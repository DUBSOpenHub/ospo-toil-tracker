name: AI Triage - Auto-score and label new toil ideas
on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to triage'
        required: true

permissions:
  issues: write
  models: read

jobs:
  ai-triage:
    if: contains(github.event.issue.labels.*.name, 'toil') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Get issue body
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUM=${{ github.event.inputs.issue_number }}
          else
            ISSUE_NUM=${{ github.event.issue.number }}
          fi
          echo "number=$ISSUE_NUM" >> "$GITHUB_OUTPUT"

          BODY=$(gh issue view "$ISSUE_NUM" --repo "${{ github.repository }}" --json body --jq '.body')
          echo "$BODY" > /tmp/issue_body.txt

      - name: Parse form fields and calculate score
        id: score
        run: |
          BODY=$(cat /tmp/issue_body.txt)

          # Parse frequency
          if echo "$BODY" | grep -q "Multiple times per day"; then
            FREQ_SCORE=8
            FREQ_LABEL="ðŸ”´ multiple-times-daily"
            FREQ_TEXT="multiple times per day"
          elif echo "$BODY" | grep -q "ðŸŸ  Daily"; then
            FREQ_SCORE=5
            FREQ_LABEL="ðŸŸ  daily"
            FREQ_TEXT="daily"
          elif echo "$BODY" | grep -q "Multiple times per week"; then
            FREQ_SCORE=3
            FREQ_LABEL="ðŸŸ¡ multiple-times-weekly"
            FREQ_TEXT="multiple times per week"
          elif echo "$BODY" | grep -q "ðŸ”µ Weekly"; then
            FREQ_SCORE=2
            FREQ_LABEL="ðŸ”µ weekly"
            FREQ_TEXT="weekly"
          else
            FREQ_SCORE=1
            FREQ_LABEL="âšª monthly"
            FREQ_TEXT="monthly or less"
          fi

          # Parse time per occurrence
          if echo "$BODY" | grep -q "> 1 hour"; then
            TIME_SCORE=8
          elif echo "$BODY" | grep -q "30.60 minutes"; then
            TIME_SCORE=5
          elif echo "$BODY" | grep -q "15.30 minutes"; then
            TIME_SCORE=3
          elif echo "$BODY" | grep -q "5.15 minutes"; then
            TIME_SCORE=2
          else
            TIME_SCORE=1
          fi

          # Parse people affected
          if echo "$BODY" | grep -q "Multiple teams"; then
            PEOPLE_SCORE=8
          elif echo "$BODY" | grep -q "Entire team"; then
            PEOPLE_SCORE=5
          elif echo "$BODY" | grep -q "4.6 people"; then
            PEOPLE_SCORE=3
          elif echo "$BODY" | grep -q "2.3 people"; then
            PEOPLE_SCORE=2
          else
            PEOPLE_SCORE=1
          fi

          # Calculate toil score
          TOIL_SCORE=$((FREQ_SCORE * TIME_SCORE * PEOPLE_SCORE))

          # Determine priority
          if [ "$TOIL_SCORE" -ge 40 ]; then
            PRIORITY="ðŸ”´ Critical - automate immediately"
            PRIORITY_LABEL="high-impact"
          elif [ "$TOIL_SCORE" -ge 20 ]; then
            PRIORITY="ðŸŸ¡ High - automate this sprint"
            PRIORITY_LABEL="high-impact"
          elif [ "$TOIL_SCORE" -ge 10 ]; then
            PRIORITY="ðŸŸ¢ Medium - add to backlog"
            PRIORITY_LABEL=""
          else
            PRIORITY="âšª Low - track but don't prioritize"
            PRIORITY_LABEL=""
          fi

          # Estimate monthly time saved
          case $FREQ_SCORE in
            8) MONTHLY_MULT=60 ;;
            5) MONTHLY_MULT=20 ;;
            3) MONTHLY_MULT=10 ;;
            2) MONTHLY_MULT=4 ;;
            *) MONTHLY_MULT=1 ;;
          esac

          case $TIME_SCORE in
            8) MINS=75 ;;
            5) MINS=45 ;;
            3) MINS=22 ;;
            2) MINS=10 ;;
            *) MINS=3 ;;
          esac

          MONTHLY_MINS=$((MONTHLY_MULT * MINS * PEOPLE_SCORE))
          if [ "$MONTHLY_MINS" -ge 60 ]; then
            MONTHLY_SAVED="~$((MONTHLY_MINS / 60)) hours/month"
          else
            MONTHLY_SAVED="~${MONTHLY_MINS} minutes/month"
          fi

          # Extract toil description for AI prompt
          TOIL_DESC=$(echo "$BODY" | sed -n '/What'\''s the toil/,/How often/p' | head -n -1 | tail -n +2)
          echo "$TOIL_DESC" > /tmp/toil_desc.txt

          echo "freq_score=$FREQ_SCORE" >> "$GITHUB_OUTPUT"
          echo "time_score=$TIME_SCORE" >> "$GITHUB_OUTPUT"
          echo "people_score=$PEOPLE_SCORE" >> "$GITHUB_OUTPUT"
          echo "toil_score=$TOIL_SCORE" >> "$GITHUB_OUTPUT"
          echo "priority=$PRIORITY" >> "$GITHUB_OUTPUT"
          echo "priority_label=$PRIORITY_LABEL" >> "$GITHUB_OUTPUT"
          echo "freq_label=$FREQ_LABEL" >> "$GITHUB_OUTPUT"
          echo "monthly_saved=$MONTHLY_SAVED" >> "$GITHUB_OUTPUT"

      - name: AI - Suggest automation approach
        id: ai
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TOIL_DESC=$(cat /tmp/toil_desc.txt)
          BODY=$(cat /tmp/issue_body.txt)

          PROMPT="You are an automation advisor. A team member submitted this toil item:

          ${BODY}

          Suggest a specific, practical automation approach in 3-4 sentences. Focus on:
          1. The best tool for the job (GitHub Action, script, Copilot agent, Slack workflow, API integration, etc.)
          2. A brief description of how it would work
          3. Estimated effort to build (hours/days)

          Be concise and practical. No fluff."

          # Use GitHub Models via the API
          RESPONSE=$(curl -s "https://models.github.ai/inference/chat/completions" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg prompt "$PROMPT" '{
              "model": "openai/gpt-4o-mini",
              "messages": [{"role": "user", "content": $prompt}],
              "max_tokens": 300,
              "temperature": 0.7
            }')" | jq -r '.choices[0].message.content // "Unable to generate suggestion at this time."')

          # Escape for GitHub output
          {
            echo "suggestion<<SUGGESTION_EOF"
            echo "$RESPONSE"
            echo "SUGGESTION_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Apply labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ steps.issue.outputs.number }}
          REPO="${{ github.repository }}"

          # Add frequency label
          gh issue edit "$ISSUE_NUM" --repo "$REPO" --add-label "${{ steps.score.outputs.freq_label }}"

          # Add priority label if high enough
          if [ -n "${{ steps.score.outputs.priority_label }}" ]; then
            gh issue edit "$ISSUE_NUM" --repo "$REPO" --add-label "${{ steps.score.outputs.priority_label }}"
          fi

          # Remove triage label (auto-triaged by AI)
          gh issue edit "$ISSUE_NUM" --repo "$REPO" --remove-label "triage" || true

      - name: Post triage comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ steps.issue.outputs.number }}

          COMMENT="## ðŸ¤– AI Triage Report

          **Toil Score:** Frequency (${{ steps.score.outputs.freq_score }}) x Time (${{ steps.score.outputs.time_score }}) x People (${{ steps.score.outputs.people_score }}) = **${{ steps.score.outputs.toil_score }}**

          **Priority:** ${{ steps.score.outputs.priority }}

          **Estimated team time saved if automated:** ${{ steps.score.outputs.monthly_saved }}

          ---

          ### ðŸ’¡ Suggested Automation Approach

          ${{ steps.ai.outputs.suggestion }}

          ---

          _This issue was auto-triaged by AI. Labels and score have been applied. Review the [scoring guide](../blob/main/docs/scoring-guide.md) for details._"

          gh issue comment "$ISSUE_NUM" --repo "${{ github.repository }}" --body "$COMMENT"
