name: AI Triage ‚Äî Auto-score and label new toil ideas

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to (re-)triage"
        required: true
        type: string

# Per-issue concurrency: prevents duplicate comments if the same issue
# triggers multiple runs (rapid label edits, manual re-runs, etc.).
concurrency:
  group: ai-triage-${{ github.event.issue.number || github.event.inputs.issue_number }}
  cancel-in-progress: true

permissions:
  issues: write    # post/update comments, apply labels
  models: read     # GitHub Models API
  contents: read   # checkout scripts/

jobs:
  triage:
    # Only run for toil-labeled issues, or on manual dispatch
    if: contains(github.event.issue.labels.*.name, 'toil') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # ‚îÄ‚îÄ 1. Checkout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      # ‚îÄ‚îÄ 2. Resolve issue number & fetch body ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Resolve issue and fetch body
        id: meta
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          EVENT_NAME: ${{ github.event_name }}
          EVENT_ISSUE_NUM: ${{ github.event.issue.number }}
          INPUT_ISSUE_NUM: ${{ github.event.inputs.issue_number }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            ISSUE_NUM="$INPUT_ISSUE_NUM"
          else
            ISSUE_NUM="$EVENT_ISSUE_NUM"
          fi
          echo "number=$ISSUE_NUM" >> "$GITHUB_OUTPUT"

          gh issue view "$ISSUE_NUM" --repo "$REPO" --json body --jq '.body' \
            > /tmp/issue_body.txt
          echo "‚úÖ Fetched issue #${ISSUE_NUM} ($(wc -c < /tmp/issue_body.txt) bytes)"

      # ‚îÄ‚îÄ 3. Idempotency check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # If a triage comment exists, we UPDATE it instead of posting a duplicate.
      - name: Check for existing triage comment
        id: existing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUM: ${{ steps.meta.outputs.number }}
        run: |
          COMMENT_ID=$(gh api "repos/$REPO/issues/$ISSUE_NUM/comments" \
            --jq '[.[] | select(.body | test("^## ü§ñ AI Triage Report"))] | first | .id // empty')

          echo "comment_id=${COMMENT_ID:-}" >> "$GITHUB_OUTPUT"

          if [ -n "${COMMENT_ID:-}" ]; then
            echo "‚ÑπÔ∏è  Found existing triage comment #${COMMENT_ID} ‚Äî will update (re-triage)"
          else
            echo "‚úÖ No prior triage comment ‚Äî will create new"
          fi

      # ‚îÄ‚îÄ 4. Parse fields & score ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Parse fields and calculate score
        id: score
        run: |
          . ./scripts/scoring.sh
          . ./scripts/parse-form.sh

          BODY=$(cat /tmp/issue_body.txt)

          # Secrets detection ‚Äî skip AI if body may contain credentials
          SAFE_BODY=$(sanitize_body "$BODY")
          if [ "$SAFE_BODY" = "__SENSITIVE_CONTENT_DETECTED__" ]; then
            echo "sensitive_content=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "sensitive_content=false" >> "$GITHUB_OUTPUT"

          # Extract dropdown field values with robust parser
          FREQ_VAL=$(parse_field "How often does it happen?" "$BODY")
          TIME_VAL=$(parse_field "How long does it take each time?" "$BODY")
          PEOPLE_VAL=$(parse_field "Who is affected?" "$BODY")

          echo "  Frequency : ${FREQ_VAL:-<not found ‚Äî defaulting to 1>}"
          echo "  Time      : ${TIME_VAL:-<not found ‚Äî defaulting to 1>}"
          echo "  People    : ${PEOPLE_VAL:-<not found ‚Äî defaulting to 1>}"

          # Score each dimension (sets FREQ_SCORE, TIME_SCORE, PEOPLE_SCORE)
          freq_score   "${FREQ_VAL:-}"
          time_score   "${TIME_VAL:-}"
          people_score "${PEOPLE_VAL:-}"

          # Bonus factors: +10 per checked checkbox
          calc_bonus_score "$BODY"

          BASE_SCORE=$(( FREQ_SCORE * TIME_SCORE * PEOPLE_SCORE ))
          TOIL_SCORE=$(( BASE_SCORE + BONUS_SCORE ))

          echo "  Base score  : $BASE_SCORE"
          echo "  Bonus score : $BONUS_SCORE"
          echo "  Total score : $TOIL_SCORE"

          priority_tier "$TOIL_SCORE"
          MONTHLY_SAVED=$(format_monthly_saved "$FREQ_SCORE" "$TIME_SCORE" "$PEOPLE_SCORE")

          # Score breakdown string for the comment
          if [ "${#BONUS_REASONS[@]}" -gt 0 ]; then
            REASONS_STR=$(IFS=', '; echo "${BONUS_REASONS[*]}")
            SCORE_BREAKDOWN="Base: ${BASE_SCORE} + Bonuses: +${BONUS_SCORE} (${REASONS_STR}) = **${TOIL_SCORE}**"
          else
            SCORE_BREAKDOWN="**${TOIL_SCORE}**"
          fi

          {
            echo "freq_score=$FREQ_SCORE"
            echo "time_score=$TIME_SCORE"
            echo "people_score=$PEOPLE_SCORE"
            echo "base_score=$BASE_SCORE"
            echo "bonus_score=$BONUS_SCORE"
            echo "toil_score=$TOIL_SCORE"
            echo "priority_display=$PRIORITY_DISPLAY"
            echo "priority_label=$PRIORITY_LABEL"
            echo "freq_label=$FREQ_LABEL"
            echo "monthly_saved=$MONTHLY_SAVED"
            echo "score_breakdown=$SCORE_BREAKDOWN"
          } >> "$GITHUB_OUTPUT"

      # ‚îÄ‚îÄ 5. Sensitive content guard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Warn and exit on sensitive content
        if: steps.score.outputs.sensitive_content == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUM: ${{ steps.meta.outputs.number }}
          SERVER_URL: ${{ github.server_url }}
        run: |
          gh issue comment "$ISSUE_NUM" --repo "$REPO" --body "## ‚ö†Ô∏è Sensitive Content Detected

          This issue may contain credentials, tokens, or other sensitive data. AI triage has been **paused** to protect your security.

          **Action required:** Please edit the issue to remove any secrets, API keys, tokens, or passwords, then re-run the [AI Triage workflow](${SERVER_URL}/${REPO}/actions/workflows/ai-triage.yml).

          _If this is a false positive, re-run the workflow ‚Äî it will proceed if no patterns are detected._"
          exit 0

      # ‚îÄ‚îÄ 6. AI automation suggestion ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # ‚îÄ‚îÄ 6. AI automation suggestion ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Get AI automation suggestion
        if: steps.score.outputs.sensitive_content != 'true'
        id: ai
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TOIL_SCORE: ${{ steps.score.outputs.toil_score }}
          PRIORITY: ${{ steps.score.outputs.priority_display }}
          MONTHLY_SAVED: ${{ steps.score.outputs.monthly_saved }}
        run: |
          BODY=$(head -c 2000 /tmp/issue_body.txt)

          # Build prompt with echo statements to avoid YAML indentation conflicts
          {
            echo "You are a senior automation engineer reviewing a toil report for a software team."
            echo ""
            echo "TOIL SUBMISSION:"
            echo "${BODY}"
            echo ""
            echo "PRE-CALCULATED IMPACT:"
            echo "- Toil Score: ${TOIL_SCORE} (higher = more painful; max realistic ~200)"
            echo "- Priority: ${PRIORITY}"
            echo "- Team time wasted: ${MONTHLY_SAVED}"
            echo ""
            echo "Respond using EXACTLY these bold headers, one per line:"
            echo ""
            echo "**Recommended Approach:** [1 sentence: what to build]"
            echo "**How It Works:** [2-3 sentences: technical detail]"
            echo "**Effort Estimate:** [X hours or X days]"
            echo "**Complexity:** [No-code | Low-code (GitHub Action) | Script | Platform change]"
            echo "**Confidence:** [High | Medium | Low]"
            echo "**Payback Period:** [build hours / monthly hours saved = X months to ROI]"
            echo ""
            echo "EXAMPLE OF EXCELLENT RESPONSE (daily deploy logs, Score 125):"
            echo "**Recommended Approach:** GitHub Action triggered on release events to auto-extract deploy metadata and append it to a Google Sheet via the Sheets API."
            echo "**How It Works:** The workflow fires on every release event, queries the GitHub API for merged PRs and commit SHAs since the last tag, formats them into a structured row, and appends it via Google Sheets API v4 using a service-account secret stored in repo secrets."
            echo "**Effort Estimate:** 4-6 hours"
            echo "**Complexity:** Low-code (GitHub Action)"
            echo "**Confidence:** High"
            echo "**Payback Period:** ~0.1 months (ROI in under a week)"
            echo ""
            echo "Now analyze the submitted toil and respond in exactly the same format."
          } > /tmp/prompt.txt

          PROMPT=$(cat /tmp/prompt.txt)

          AI_STATUS="success"
          HTTP_CODE="000"

          for attempt in 1 2; do
            HTTP_CODE=$(curl -s \
              -o /tmp/ai_response.json \
              -w "%{http_code}" \
              "https://models.github.ai/inference/chat/completions" \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg p "$PROMPT" '{
                model: "openai/gpt-4o-mini",
                messages: [{ role: "user", content: $p }],
                max_tokens: 600,
                temperature: 0.5
              }')")

            [ "$HTTP_CODE" = "200" ] && break

            if [ "$HTTP_CODE" = "403" ] || [ "$HTTP_CODE" = "401" ]; then
              echo "ERROR: GitHub Models API returned HTTP ${HTTP_CODE} ‚Äî likely a permissions issue."
              echo "Ensure your repo/org has 'models: read' permission enabled."
              echo "See: https://docs.github.com/en/github-models"
              AI_STATUS="forbidden"
              break
            elif [ "$attempt" = "1" ]; then
              echo "WARNING: AI API returned HTTP ${HTTP_CODE} -- retrying in 10s..."
              sleep 10
            else
              AI_STATUS="failed"
            fi
          done

          if [ "$AI_STATUS" = "success" ]; then
            SUGGESTION=$(jq -r '.choices[0].message.content // empty' \
              /tmp/ai_response.json 2>/dev/null || true)
            if [ -z "${SUGGESTION:-}" ]; then
              AI_STATUS="empty"
              SUGGESTION="_The AI returned an empty response. Re-run this workflow to retry._"
            fi
          elif [ "$AI_STATUS" = "forbidden" ]; then
            SUGGESTION="_‚ö†Ô∏è AI suggestion unavailable ‚Äî your repository needs **GitHub Models** access enabled. Go to your org/repo settings and ensure the \`models: read\` permission is available. See the [GitHub Models docs](https://docs.github.com/en/github-models) for setup instructions. The scoring and labels below still work without it._"
          else
            SUGGESTION="_AI suggestion unavailable ‚Äî GitHub Models API returned HTTP ${HTTP_CODE}. Re-run this workflow to retry._"
          fi

          CONFIDENCE=$(echo "${SUGGESTION:-}" \
            | grep -oE '\*\*Confidence:\*\* (High|Medium|Low)' \
            | awk '{print $NF}' || echo "Unknown")

          {
            echo "ai_status=$AI_STATUS"
            echo "http_code=$HTTP_CODE"
            echo "confidence=$CONFIDENCE"
            echo "suggestion<<__AI_EOF__"
            printf '%s' "${SUGGESTION}"
            echo ""
            echo "__AI_EOF__"
          } >> "$GITHUB_OUTPUT"

      # ‚îÄ‚îÄ 7. Apply labels ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Apply labels
        if: steps.score.outputs.sensitive_content != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUM: ${{ steps.meta.outputs.number }}
          FREQ_LABEL: ${{ steps.score.outputs.freq_label }}
          PRIORITY_LABEL: ${{ steps.score.outputs.priority_label }}
          CONFIDENCE: ${{ steps.ai.outputs.confidence }}
        run: |
          gh issue edit "$ISSUE_NUM" --repo "$REPO" --add-label "$FREQ_LABEL" || true

          if [ -n "${PRIORITY_LABEL:-}" ]; then
            gh issue edit "$ISSUE_NUM" --repo "$REPO" --add-label "$PRIORITY_LABEL" || true
          fi

          # Add needs-review label when AI is uncertain
          if [ "${CONFIDENCE:-}" = "Low" ]; then
            gh issue edit "$ISSUE_NUM" --repo "$REPO" --add-label "needs-review" || true
            echo "‚ÑπÔ∏è  AI confidence Low ‚Äî added needs-review label"
          fi

          # Remove triage label (auto-triage complete)
          gh issue edit "$ISSUE_NUM" --repo "$REPO" --remove-label "triage" 2>/dev/null || true

      # ‚îÄ‚îÄ 8. Post or update triage comment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Post or update triage comment
        if: steps.score.outputs.sensitive_content != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUM: ${{ steps.meta.outputs.number }}
          EXISTING_COMMENT_ID: ${{ steps.existing.outputs.comment_id }}
          FREQ_SCORE: ${{ steps.score.outputs.freq_score }}
          TIME_SCORE: ${{ steps.score.outputs.time_score }}
          PEOPLE_SCORE: ${{ steps.score.outputs.people_score }}
          SCORE_BREAKDOWN: ${{ steps.score.outputs.score_breakdown }}
          PRIORITY_DISPLAY: ${{ steps.score.outputs.priority_display }}
          MONTHLY_SAVED: ${{ steps.score.outputs.monthly_saved }}
          AI_SUGGESTION: ${{ steps.ai.outputs.suggestion }}
          CONFIDENCE: ${{ steps.ai.outputs.confidence }}
        run: |
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')

          case "${CONFIDENCE:-}" in
            High)   CONF_BADGE="üü¢ High" ;;
            Medium) CONF_BADGE="üü° Medium" ;;
            Low)    CONF_BADGE="üî¥ Low _(needs-review label added)_" ;;
            *)      CONF_BADGE="‚Äî" ;;
          esac

          if [ -n "${EXISTING_COMMENT_ID:-}" ]; then
            RETRIAGE_NOTE=" ¬∑ _Re-triaged at ${TIMESTAMP}_"
          else
            RETRIAGE_NOTE=""
          fi

          # Write suggestion to a temp file ‚Äî safely handles any content
          printf '%s' "${AI_SUGGESTION}" > /tmp/ai_suggestion.txt

          # Build comment by concatenation (avoids heredoc quoting pitfalls)
          {
            echo "## ü§ñ AI Triage Report"
            echo ""
            echo "**Toil Score:** Frequency (${FREQ_SCORE}) √ó Time (${TIME_SCORE}) √ó People (${PEOPLE_SCORE}) = ${SCORE_BREAKDOWN}"
            echo ""
            echo "**Priority:** ${PRIORITY_DISPLAY}"
            echo ""
            echo "**Estimated team time saved if automated:** ${MONTHLY_SAVED}"
            echo ""
            echo "---"
            echo ""
            echo "### üí° Suggested Automation Approach"
            echo ""
            cat /tmp/ai_suggestion.txt
            echo ""
            echo ""
            echo "**AI Confidence:** ${CONF_BADGE}"
            echo ""
            echo "---"
            echo ""
            echo "_Auto-triaged by AI ¬∑ [Scoring guide](../blob/main/docs/scoring-guide.md) ¬∑ [Config](../blob/main/config.yml)${RETRIAGE_NOTE}_"
          } > /tmp/triage_comment.md

          # Use jq --rawfile to build JSON payload ‚Äî handles ALL special characters safely
          jq -n --rawfile body /tmp/triage_comment.md '{"body": $body}' \
            > /tmp/patch_payload.json

          if [ -n "${EXISTING_COMMENT_ID:-}" ]; then
            gh api "repos/$REPO/issues/comments/$EXISTING_COMMENT_ID" \
              --method PATCH \
              --input /tmp/patch_payload.json
            echo "‚úÖ Updated existing triage comment #${EXISTING_COMMENT_ID}"
          else
            gh issue comment "$ISSUE_NUM" --repo "$REPO" \
              --body-file /tmp/triage_comment.md
            echo "‚úÖ Posted new triage comment"
          fi

      # ‚îÄ‚îÄ 9. Workflow summary (always ‚Äî for debuggability) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Write workflow summary
        if: always()
        env:
          ISSUE_NUM: ${{ steps.meta.outputs.number }}
          TOIL_SCORE: ${{ steps.score.outputs.toil_score }}
          BASE_SCORE: ${{ steps.score.outputs.base_score }}
          BONUS_SCORE: ${{ steps.score.outputs.bonus_score }}
          PRIORITY: ${{ steps.score.outputs.priority_display }}
          MONTHLY_SAVED: ${{ steps.score.outputs.monthly_saved }}
          AI_STATUS: ${{ steps.ai.outputs.ai_status }}
          HTTP_CODE: ${{ steps.ai.outputs.http_code }}
          CONFIDENCE: ${{ steps.ai.outputs.confidence }}
          EXISTING_COMMENT_ID: ${{ steps.existing.outputs.comment_id }}
          SENSITIVE: ${{ steps.score.outputs.sensitive_content }}
          REPO: ${{ github.repository }}
          SERVER_URL: ${{ github.server_url }}
        run: |
          COMMENT_ACTION="New comment"
          [ -n "${EXISTING_COMMENT_ID:-}" ] && COMMENT_ACTION="Updated comment #${EXISTING_COMMENT_ID}"

          {
            echo "## ü§ñ AI Triage Summary"
            echo ""
            echo "| Field | Value |"
            echo "|-------|-------|"
            echo "| Issue | [#${ISSUE_NUM:-?}](${SERVER_URL}/${REPO}/issues/${ISSUE_NUM:-0}) |"
            echo "| Toil Score | ${TOIL_SCORE:-n/a} (base: ${BASE_SCORE:-?} + bonus: ${BONUS_SCORE:-0}) |"
            echo "| Priority | ${PRIORITY:-n/a} |"
            echo "| Monthly Savings | ${MONTHLY_SAVED:-n/a} |"
            echo "| AI Status | \`${AI_STATUS:-n/a}\` (HTTP \`${HTTP_CODE:-?}\`) |"
            echo "| AI Confidence | ${CONFIDENCE:-n/a} |"
            echo "| Sensitive Content | ${SENSITIVE:-false} |"
            echo "| Comment Action | ${COMMENT_ACTION} |"
            echo "| Duration | ${SECONDS}s |"
          } >> "$GITHUB_STEP_SUMMARY"
