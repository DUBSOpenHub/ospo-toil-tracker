name: Template Setup â€” Welcome new teams

# Runs once when a new repo is created from this template.
# Resets sample data, updates repo references, and creates a welcome issue.

on:
  push:
    branches: [main]

permissions:
  contents: write
  issues: write

jobs:
  setup:
    name: Initialize from template
    runs-on: ubuntu-latest
    if: github.run_number == 1

    steps:
      - name: Check if already initialized
        id: check
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              creator: 'github-actions[bot]',
              per_page: 100,
            });
            const alreadySetUp = issues.data.some(i => i.title.includes('Welcome to AI Toil Tracker'));
            core.setOutput('skip', alreadySetUp ? 'true' : 'false');
            if (alreadySetUp) core.info('Welcome issue already exists â€” skipping setup.');

      - name: Checkout repository
        if: steps.check.outputs.skip == 'false'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Reset dashboard data
        if: steps.check.outputs.skip == 'false'
        run: |
          cat > docs/dashboard/dashboard-data.json << 'EOF'
          {
            "generatedAt": "",
            "repository": "${{ github.repository }}",
            "summary": {
              "totalToilItems": 0,
              "openToilItems": 0,
              "automatedItems": 0,
              "totalWins": 0,
              "totalMonthlyMinutes": 0,
              "totalMonthlySaved": "~0 minutes/month"
            },
            "byCategory": [],
            "byTeam": [],
            "topItems": [],
            "toilItems": [],
            "wins": []
          }
          EOF

      - name: Update repo references in config
        if: steps.check.outputs.skip == 'false'
        run: |
          # Update any hardcoded repo references to the new repo
          if grep -q "DUBSOpenHub/ai-toil-tracker" docs/dashboard/dashboard-data.json 2>/dev/null; then
            sed -i "s|DUBSOpenHub/ai-toil-tracker|${{ github.repository }}|g" docs/dashboard/dashboard-data.json
          fi

      - name: Commit changes
        if: steps.check.outputs.skip == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: initialize from AI Toil Tracker template

            Reset dashboard data and update repo references for ${{ github.repository }}"
            git push
          fi

      - name: Create welcome issue
        if: steps.check.outputs.skip == 'false'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš€ Welcome to AI Toil Tracker â€” Setup Checklist',
              body: [
                '## Your AI Toil Tracker is ready! Here\'s how to finish setup:\n',
                '### Quick Start (10 minutes)\n',
                '- [ ] **Enable GitHub Actions** â€” Go to Actions tab â†’ Enable workflows',
                '- [ ] **Set up GitHub Pages** â€” Settings â†’ Pages â†’ Source: Deploy from branch â†’ `main` / `/docs`',
                '- [ ] **Configure Slack** â€” Edit `.github/ISSUE_TEMPLATE/config.yml` with your Slack channel link',
                '- [ ] **Add secrets** â€” Settings â†’ Secrets â†’ Actions â†’ Add any integration tokens',
                '- [ ] **Schedule a weekly Slack reminder** â€” Link to your issue template: `https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/issues/new?template=toil-idea.yml`\n',
                '### Optional Enhancements\n',
                '- [ ] **Enable GitHub Discussions** â€” Settings â†’ Features â†’ Discussions',
                '- [ ] **Customize scoring** â€” Edit `config.yml` to adjust frequency/time/people weights',
                '- [ ] **Set up AI triage** â€” Ensure GitHub Models access is configured for AI-powered scoring',
                '- [ ] **Invite your team** â€” Add collaborators so everyone can submit toil ideas\n',
                '### Your Dashboard\n',
                'Once GitHub Pages is enabled, your dashboard will be live at:',
                '`https://' + context.repo.owner + '.github.io/' + context.repo.repo + '/dashboard/`\n',
                '### Submit Your First Toil Idea\n',
                'Try it now: [Submit a toil idea](../../issues/new?template=toil-idea.yml)\n',
                '---',
                '*This issue was auto-generated by the AI Toil Tracker template setup. Close it when you\'re done!*',
              ].join('\n'),
              labels: ['documentation'],
            });
