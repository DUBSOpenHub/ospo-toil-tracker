name: Celebrate Automation Wins
on:
  issues:
    types: [labeled]

permissions:
  issues: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  celebrate-win:
    if: github.event.label.name == 'automated'
    runs-on: ubuntu-latest
    steps:
      - name: Find related toil issue
        id: find
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WIN_NUM: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          WIN_TITLE=$(gh issue view "$WIN_NUM" --repo "$REPO" --json title --jq '.title')
          echo "$WIN_TITLE" | grep -q '^\[WIN\]' || { echo "Not a WIN issue â€” skipping."; exit 0; }
          BODY=$(gh issue view "$WIN_NUM" --repo "$REPO" --json body --jq '.body')
          
          # Extract issue reference (e.g. #12) from "Related toil issue" field
          RELATED=$(echo "$BODY" | grep -oE '#[0-9]+' | head -1)
          
          if [ -z "$RELATED" ]; then
            echo "No related issue found"
            echo "found=false" >> "$GITHUB_OUTPUT"
          else
            RELATED_NUM=$(echo "$RELATED" | tr -d '#')
            echo "related_num=$RELATED_NUM" >> "$GITHUB_OUTPUT"
            echo "win_num=$WIN_NUM" >> "$GITHUB_OUTPUT"
            echo "win_title=$WIN_TITLE" >> "$GITHUB_OUTPUT"
            echo "found=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment on original toil issue
        if: steps.find.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          WIN_NUM: ${{ steps.find.outputs.win_num }}
          WIN_TITLE: ${{ steps.find.outputs.win_title }}
          RELATED_NUM: ${{ steps.find.outputs.related_num }}
        run: |
          COMMENT="## ðŸŽ‰ This toil has been automated!

          Great news â€” this toil item has been addressed!

          **See:** #$WIN_NUM â€” $WIN_TITLE

          Thanks to everyone who identified and solved this. The automation is now live.

          _This comment was posted automatically when the automation was logged._"

          gh issue comment "$RELATED_NUM" \
            --repo "$REPO" \
            --body "$COMMENT"

          # Add automated label and close the original issue
          gh issue edit "$RELATED_NUM" \
            --repo "$REPO" \
            --add-label "automated"
          
          gh issue close "$RELATED_NUM" \
            --repo "$REPO" \
            --reason completed || true
