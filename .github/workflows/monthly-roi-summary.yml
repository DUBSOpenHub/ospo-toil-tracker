name: Monthly ROI Summary
on:
  workflow_dispatch:
  schedule:
    - cron: '0 17 1 * *'  # 1st of each month at 9am PST (17:00 UTC)

permissions:
  issues: write

jobs:
  roi-summary:
    runs-on: ubuntu-latest
    steps:
      - name: Gather metrics
        id: metrics
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |

          # Count totals
          TOTAL_TOIL=$(gh issue list --repo "$REPO" --label "toil" --state all --limit 1000 --json number --jq 'length')
          AUTOMATED=$(gh issue list --repo "$REPO" --label "automated" --state all --limit 1000 --json number --jq 'length')
          IN_PROGRESS=$(gh issue list --repo "$REPO" --label "in-progress" --state open --limit 1000 --json number --jq 'length')
          OPEN_TRIAGE=$(gh issue list --repo "$REPO" --label "triage" --state open --limit 1000 --json number --jq 'length')
          HIGH_IMPACT=$(gh issue list --repo "$REPO" --label "high-impact" --state open --limit 1000 --json number --jq 'length')

          # Count this month's submissions (last 30 days)
          SINCE=$(date -u -d '30 days ago' '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null || date -u -v-30d '+%Y-%m-%dT%H:%M:%SZ')
          NEW_THIS_MONTH=$(gh issue list --repo "$REPO" --label "toil" --state all --limit 1000 --json createdAt --jq "[.[] | select(.createdAt >= \"$SINCE\")] | length")

          # Count unique submitters from WIN issues
          WIN_COUNT=$(gh issue list --repo "$REPO" --label "automated" --state all --limit 1000 --json number --jq 'length')

          # Calculate automation rate
          if [ "$TOTAL_TOIL" -gt 0 ]; then
            AUTOMATION_RATE=$((AUTOMATED * 100 / TOTAL_TOIL))
          else
            AUTOMATION_RATE=0
          fi

          echo "total_toil=$TOTAL_TOIL" >> "$GITHUB_OUTPUT"
          echo "automated=$AUTOMATED" >> "$GITHUB_OUTPUT"
          echo "in_progress=$IN_PROGRESS" >> "$GITHUB_OUTPUT"
          echo "open_triage=$OPEN_TRIAGE" >> "$GITHUB_OUTPUT"
          echo "high_impact=$HIGH_IMPACT" >> "$GITHUB_OUTPUT"
          echo "new_this_month=$NEW_THIS_MONTH" >> "$GITHUB_OUTPUT"
          echo "automation_rate=$AUTOMATION_RATE" >> "$GITHUB_OUTPUT"

      - name: Create summary issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TOTAL_TOIL: ${{ steps.metrics.outputs.total_toil }}
          NEW_THIS_MONTH: ${{ steps.metrics.outputs.new_this_month }}
          AUTOMATED: ${{ steps.metrics.outputs.automated }}
          IN_PROGRESS: ${{ steps.metrics.outputs.in_progress }}
          OPEN_TRIAGE: ${{ steps.metrics.outputs.open_triage }}
          HIGH_IMPACT: ${{ steps.metrics.outputs.high_impact }}
          AUTOMATION_RATE: ${{ steps.metrics.outputs.automation_rate }}
        run: |
          MONTH=$(date -u '+%B %Y')

          BODY="## ü§ñ Toil Tracker ‚Äî Monthly Summary ($MONTH)

          | Metric | Value |
          |--------|-------|
          | üìã Total toil ideas (all time) | $TOTAL_TOIL |
          | üÜï New submissions this month | $NEW_THIS_MONTH |
          | ‚úÖ Automated (all time) | $AUTOMATED |
          | üî® In progress | $IN_PROGRESS |
          | üè∑Ô∏è Awaiting triage | $OPEN_TRIAGE |
          | üî¥ High-impact open | $HIGH_IMPACT |
          | üìà Automation rate | $AUTOMATION_RATE% |

          ---

          ### Quick Links
          - [View all toil ideas](https://github.com/$REPO/issues?q=is%3Aissue+label%3Atoil+sort%3Acreated-desc)
          - [High-impact items](https://github.com/$REPO/issues?q=is%3Aissue+label%3Ahigh-impact+is%3Aopen)
          - [Completed automations](https://github.com/$REPO/issues?q=is%3Aissue+label%3Aautomated)
          - [Submit new toil idea](https://github.com/$REPO/issues/new?template=toil-idea.yml)

          _This summary was auto-generated. See docs/roi-tracking.md for methodology._"

          gh issue create --repo "$REPO" \
            --title "üìä Monthly ROI Summary ‚Äî $MONTH" \
            --body "$BODY" \
            --label "roi-summary"

      - name: Notify Microsoft Teams
        if: secrets.TEAMS_WEBHOOK_URL != ''
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TOTAL_TOIL: ${{ steps.metrics.outputs.total_toil }}
          AUTOMATED: ${{ steps.metrics.outputs.automated }}
          NEW_THIS_MONTH: ${{ steps.metrics.outputs.new_this_month }}
          AUTOMATION_RATE: ${{ steps.metrics.outputs.automation_rate }}
          REPO: ${{ github.repository }}
        run: |
          MONTH=$(date -u '+%B %Y')

          TEAMS_BODY=$(jq -n \
            --arg title "üìä Toil Tracker ‚Äî $MONTH Summary" \
            --arg stats "üìã Total: $TOTAL_TOIL | ‚úÖ Automated: $AUTOMATED | üÜï New: $NEW_THIS_MONTH | üìà Rate: $AUTOMATION_RATE%" \
            --arg url "https://github.com/$REPO/issues?q=is%3Aissue+label%3Aroi-summary" \
            '{
              "type": "message",
              "attachments": [{
                "contentType": "application/vnd.microsoft.card.adaptive",
                "content": {
                  "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                  "type": "AdaptiveCard",
                  "version": "1.4",
                  "body": [
                    { "type": "TextBlock", "size": "Medium", "weight": "Bolder", "text": $title },
                    { "type": "TextBlock", "text": $stats, "wrap": true }
                  ],
                  "actions": [
                    { "type": "Action.OpenUrl", "title": "View Full Report", "url": $url }
                  ]
                }
              }]
            }')

          curl -s -o /dev/null -H "Content-Type: application/json" -d "$TEAMS_BODY" "$TEAMS_WEBHOOK_URL"
