<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; script-src 'self' 'unsafe-inline'; connect-src 'self' https://api.github.com; img-src 'self' data:;">
<title>Open Source Programs Team — Toil Tracker</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-surface: #f9fafb;
  --bg-card: #ffffff;
  --bg-glass: rgba(17,17,28,0.78);
  --border-card: #dfe3ec;
  --accent: #a56bff;
  --accent-strong: #7c3bff;
  --accent-soft: #dec0ff;
  --success: #3dd68c;
  --warning: #f6c05c;
  --danger: #ff667a;
  --text-soft: #5e6474;
  --text-primary: #0e1018;
  --radius: 0.75rem;
  --ring: 0 0 0 1px rgba(0,0,0,0.05);
  --shadow-sm: 0 1px 3px 0 rgba(0,0,0,0.06);
  --shadow-md: 0 8px 20px -4px rgba(0,0,0,0.08), 0 4px 8px -4px rgba(0,0,0,0.04);
}
.dark, :root:not(.light) {
  --bg-surface: #070914;
  --bg-card: #1a1d30;
  --bg-glass: rgba(30,33,52,0.88);
  --border-card: #3a4167;
  --text-soft: #b9c4e6;
  --text-primary: #f7faff;
  --ring: 0 0 0 1px rgba(255,255,255,0.06);
  --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.3);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.4), 0 2px 4px -2px rgba(0,0,0,0.3);
}

/* ── Reset & Base ── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
}
body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg-surface); color: var(--text-primary); line-height: 1.5; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; text-rendering: optimizeLegibility; min-height: 100vh; position: relative; }
body::before { content: ""; position: fixed; inset: 0; background-image: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(168,85,247,0.08), transparent), radial-gradient(ellipse 60% 40% at 80% 50%, rgba(34,211,238,0.04), transparent), radial-gradient(ellipse 40% 60% at 10% 80%, rgba(168,85,247,0.03), transparent); pointer-events: none; z-index: -1; }
.light body::before { background-image: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(168,85,247,0.04), transparent), radial-gradient(ellipse 60% 40% at 80% 50%, rgba(34,211,238,0.02), transparent); }
button:focus-visible, select:focus-visible, input:focus-visible, a:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; border-radius: calc(var(--radius) - 0.25rem); }

/* ── Header ── */
.header { position: sticky; top: 0; z-index: 1000; background: linear-gradient(135deg, #0b0d1d 0%, #1c0f2d 100%); color: #f5f7ff; border-bottom: 1px solid rgba(255,255,255,0.06); box-shadow: 0 4px 30px rgba(0,0,0,0.3); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); overflow: visible; isolation: isolate; }
.header-inner { max-width: 1440px; margin: 0 auto; padding: 1.25rem 2.25rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; position: relative; }
.header::before { content: ""; position: absolute; inset: 0; pointer-events: none; background: radial-gradient(720px 320px at 12% 5%, rgba(165,107,255,0.18), transparent 60%), radial-gradient(640px 260px at 88% -15%, rgba(67,198,255,0.14), transparent 70%); opacity: 0.85; }
.header-inner > * { position: relative; }
.hero-left { display: flex; flex-direction: column; gap: 0.35rem; max-width: 640px; }
.hero-eyebrow { font-size: 0.72rem; letter-spacing: 0.08em; text-transform: uppercase; color: rgba(255,255,255,0.45); font-weight: 500; }
.header h1 { font-size: clamp(1.4rem, 2vw, 1.8rem); font-weight: 750; letter-spacing: -0.03em; display: flex; align-items: center; gap: 0.6rem; color: #fff; }
.hero-bolt { display: inline-block; cursor: pointer; user-select: none; filter: drop-shadow(0 0 8px rgba(255,231,74,0.45)); transition: transform 160ms ease, filter 160ms ease; }
.hero-bolt:hover { transform: translateY(-1px) scale(1.1); filter: drop-shadow(0 0 14px rgba(255,231,74,0.7)); }
.hero-bolt:active { transform: scale(0.95); }
.hero-subtitle { font-size: 0.85rem; color: rgba(255,255,255,0.55); max-width: 700px; line-height: 1.5; }
.hero-pulse { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.2rem; }
.pulse-pill { display: inline-flex; align-items: center; gap: 0.3rem; font-size: 0.68rem; padding: 0.25rem 0.6rem; border-radius: 999px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04); text-transform: uppercase; letter-spacing: 0.08em; color: rgba(255,255,255,0.65); font-weight: 500; backdrop-filter: blur(8px); }
.pulse-pill.success { border-color: rgba(57,255,136,0.55); background: rgba(57,255,136,0.14); color: #39ff88; }
.pulse-pill.warning { border-color: rgba(255,231,74,0.55); background: rgba(255,231,74,0.14); color: #ffe74a; }
.pulse-pill.neutral { border-color: rgba(255,255,255,0.15); }
.pulse-pill[data-filter-status] { transition: all 200ms cubic-bezier(0.16, 1, 0.3, 1); cursor: pointer; }
.pulse-pill[data-filter-status]:hover { transform: translateY(-1px) scale(1.04); filter: brightness(1.3); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
.header .meta { font-size: 0.75rem; font-weight: 500; color: rgba(255,255,255,0.5); display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; justify-content: flex-end; text-align: right; }
.header .meta a { color: rgba(255,255,255,0.7); text-decoration: none; border-bottom: 1px solid rgba(255,255,255,0.15); transition: all 150ms ease; }
.header .meta a:hover { border-bottom-color: rgba(168,85,247,0.5); color: #c084fc; }

/* ── Container ── */
.container { max-width: 1440px; margin: 0 auto; padding: 1.75rem 2.25rem; }

/* ── Summary Cards ── */
.cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.25rem; overflow: visible; }
.card { background: rgba(17,17,23,0.6); border: 1px solid rgba(255,255,255,0.06); border-radius: var(--radius); padding: 1.25rem 1.35rem; transition: all 250ms cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 0 0 1px rgba(255,255,255,0.03), 0 2px 8px rgba(0,0,0,0.2); text-align: left; position: relative; overflow: visible; animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) backwards; backdrop-filter: blur(12px); }
.card:nth-child(1) { animation-delay: 0.05s; }
.card:nth-child(2) { animation-delay: 0.1s; }
.card:nth-child(3) { animation-delay: 0.15s; }
.card:nth-child(4) { animation-delay: 0.2s; }
.card::before { content: ""; position: absolute; inset: 0; border-radius: inherit; padding: 1px; background: linear-gradient(135deg, rgba(168,85,247,0.15), rgba(34,211,238,0.08), transparent 60%); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none; opacity: 0; transition: opacity 300ms ease; }
.card::after { content: ""; position: absolute; inset: -1px; border-radius: inherit; background: radial-gradient(300px circle at var(--mouse-x, 50%) var(--mouse-y, 50%), rgba(168,85,247,0.06), transparent 60%); pointer-events: none; opacity: 0; transition: opacity 300ms ease; }
.card:hover { transform: translateY(-3px); box-shadow: 0 0 0 1px rgba(168,85,247,0.1), 0 8px 30px rgba(0,0,0,0.3), 0 0 40px rgba(168,85,247,0.04); }
.card:hover::before { opacity: 1; }
.card:hover::after { opacity: 1; }
.card .label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.12em; color: rgba(158,164,184,0.7); margin-bottom: 0.5rem; font-weight: 600; }
.card .value { font-size: 2.25rem; font-weight: 700; color: var(--text-primary); letter-spacing: -0.04em; line-height: 1; font-variant-numeric: tabular-nums; margin-bottom: 0.45rem; display: flex; align-items: baseline; gap: 0.3rem; }
.card .value-number { display: inline-block; min-width: 0; }
.card .value sup { font-size: 0.95rem; margin-left: 0.1rem; color: rgba(158,164,184,0.5); font-weight: 500; }
.card .delta { font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.2rem 0.55rem; border-radius: 999px; }
.delta.positive { background: rgba(74,222,128,0.1); color: #4ade80; }
.delta.negative { background: rgba(248,113,113,0.1); color: #f87171; }
.card .card-subtext { font-size: 0.8rem; color: rgba(158,164,184,0.55); margin-bottom: 0.75rem; }
.micro-progress { width: 100%; height: 4px; border-radius: 999px; background: rgba(255,255,255,0.04); overflow: hidden; position: relative; }
.micro-progress span { position: absolute; inset: 0; border-radius: 999px; background: linear-gradient(90deg, #d400ff, #00e5ff); transform-origin: left; transition: transform 0.4s ease-out; }
.micro-progress[data-color="warning"] span { background: linear-gradient(90deg, #ff9f1c, #fff200); }
.micro-progress[data-color="danger"] span { background: linear-gradient(90deg, #ff4d6d, #ff1744); }
.micro-progress[data-color="success"] span { background: linear-gradient(90deg, #00f5a0, #39ff14); }
.card.emerald { background: rgba(10,42,29,0.78); border-color: rgba(57,255,136,0.24); }
.card.emerald::before { background: linear-gradient(135deg, rgba(57,255,136,0.28), rgba(0,245,160,0.12), transparent 60%); }
.dark .card, :root:not(.light) .card { background: rgba(32,36,56,0.78); border: 1px solid rgba(196,181,253,0.22); box-shadow: 0 0 0 1px rgba(196,181,253,0.12), 0 6px 18px rgba(0,0,0,0.28); }
.dark .card.emerald, :root:not(.light) .card.emerald { background: rgba(10,42,29,0.78) !important; border-color: rgba(57,255,136,0.24) !important; }
.card.card-teaser { border-style: solid; border-color: rgba(255,255,255,0.04); }
.card.card-teaser .value { opacity: 0.4; }
.card.card-teaser .micro-progress span { width: 15% !important; opacity: 0.5; }

/* ── Card Help Tooltips ── */
.card-help { display: inline-flex; align-items: center; justify-content: center; width: 1.1rem; height: 1.1rem; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); color: var(--text-soft); font-size: 0.6rem; font-weight: 700; cursor: help; position: relative; margin-left: 0.4rem; vertical-align: middle; transition: all 150ms ease; z-index: 10; }
.card-help:hover { background: var(--accent); color: #fff; border-color: var(--accent); z-index: 1000; }
.card-help .card-tip { display: none; position: absolute; top: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: #1a1a2e; color: #e4e4f0; font-size: 0.78rem; font-weight: 400; line-height: 1.45; padding: 0.65rem 0.85rem; border-radius: 0.5rem; border: 1px solid #2d2d44; box-shadow: 0 8px 24px rgba(0,0,0,0.4); width: 240px; white-space: normal; text-transform: none; letter-spacing: 0; z-index: 1001; pointer-events: none; }
.card-help .card-tip::after { content: ""; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-bottom-color: #2d2d44; }
.card-help:hover .card-tip { display: block; }
.light .card-help { background: rgba(0,0,0,0.06); border-color: rgba(0,0,0,0.1); }
.light .card-help .card-tip { background: #fff; color: #1a1a2e; border-color: #dfe3ec; box-shadow: 0 8px 24px rgba(0,0,0,0.12); }
.light .card-help .card-tip::after { border-bottom-color: #dfe3ec; border-top-color: transparent; }

.dark .card:hover, :root:not(.light) .card:hover { border-color: rgba(196,181,253,0.4); box-shadow: 0 0 0 1px rgba(196,181,253,0.24), 0 10px 34px rgba(0,0,0,0.34), 0 0 52px rgba(192,132,252,0.2); }
.dark .card .value, :root:not(.light) .card .value { color: #f8fbff; }
.dark .card .card-subtext, :root:not(.light) .card .card-subtext { color: rgba(205,216,255,0.82); }

/* ── Insight Panels ── */
.insights-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.25rem; align-items: stretch; }
.insight-card { background: rgba(17,17,23,0.5); border: 1px solid rgba(255,255,255,0.06); border-radius: var(--radius); padding: 0.9rem 1rem; box-shadow: 0 0 0 1px rgba(255,255,255,0.02), 0 2px 8px rgba(0,0,0,0.15); position: relative; overflow: visible; transition: all 250ms cubic-bezier(0.16, 1, 0.3, 1); animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) backwards; display: flex; flex-direction: column; backdrop-filter: blur(12px); }
.insight-card:nth-child(1) { animation-delay: 0.08s; }
.insight-card:nth-child(2) { animation-delay: 0.12s; }
.insight-card:nth-child(3) { animation-delay: 0.16s; }
.insight-card::before { content: ""; position: absolute; inset: 0; border-radius: inherit; padding: 1px; background: linear-gradient(135deg, rgba(168,85,247,0.12), rgba(34,211,238,0.06), transparent 50%); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none; opacity: 0; transition: opacity 300ms ease; }
.insight-card::after { content: ""; position: absolute; inset: 0; border-radius: inherit; background: radial-gradient(400px circle at 50% 0%, rgba(168,85,247,0.04), transparent 70%); pointer-events: none; }
.insight-card:hover { transform: translateY(-3px); box-shadow: 0 0 0 1px rgba(168,85,247,0.08), 0 8px 30px rgba(0,0,0,0.25), 0 0 60px rgba(168,85,247,0.03); }
.insight-card:hover::before { opacity: 1; }
.insight-header { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; margin-bottom: 0.5rem; position: relative; z-index: 1; }
.insight-header .eyebrow { font-size: 0.68rem; letter-spacing: 0.18em; text-transform: uppercase; color: rgba(158,164,184,0.6); font-weight: 600; }
.mini-pill { font-size: 0.62rem; padding: 0.15rem 0.5rem; border-radius: 999px; border: 1px solid rgba(255,255,255,0.08); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 500; }
.mini-pill.live { border-color: rgba(57,255,136,0.4); color: #39ff88; background: rgba(57,255,136,0.12); animation: pulseGlow 3s ease-in-out infinite; }
.insight-body { display: flex; gap: 0.9rem; flex-wrap: wrap; align-items: center; justify-content: center; flex: 1; position: relative; z-index: 1; }
.radial-progress { --size: 72px; --progress: 0deg; width: var(--size); height: var(--size); border-radius: 50%; background: conic-gradient(#a855f7 var(--progress), rgba(168,85,247,0.1) var(--progress), rgba(168,85,247,0.1) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0; position: relative; box-shadow: 0 0 20px rgba(168,85,247,0.1), 0 0 0 2px rgba(168,85,247,0.08); }
.radial-progress::after { content: ""; position: absolute; inset: 5px; background: rgba(5,4,7,0.95); border-radius: 50%; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
.radial-progress strong { position: relative; z-index: 1; font-size: 0.9rem; font-weight: 700; color: #f5f7ff; line-height: 1.2; }
.radial-progress span { position: relative; z-index: 1; font-size: 0.38rem; color: rgba(158,164,184,0.5); text-transform: uppercase; letter-spacing: 0.12em; line-height: 1; }
.stat-list { display: flex; flex-direction: column; gap: 0.4rem; position: relative; z-index: 1; }
.stat-row { display: flex; align-items: center; justify-content: flex-start; gap: 0.45rem; font-size: 0.75rem; color: rgba(158,164,184,0.6); }
.stat-row strong { font-size: 0.95rem; color: var(--text-primary); font-variant-numeric: tabular-nums; min-width: 1.4rem; }
/* Pipeline card: big dial left, stats right */
#pipelineCard .insight-body { flex: 1; display: flex; flex-wrap: nowrap; flex-direction: row; align-items: center; justify-content: center; gap: 1.2rem; }
#pipelineCard .radial-progress { --size: 96px; flex-shrink: 0; }
#pipelineCard .radial-progress strong { font-size: 1.25rem; }
#pipelineCard .radial-progress span { font-size: 0.45rem; }
#pipelineCard .radial-progress::after { inset: 6px; }
#pipelineCard .stat-list { flex: 0 0 auto; gap: 0.35rem; }
#pipelineCard .stat-row { gap: 0.4rem; font-size: 0.72rem; }
#pipelineCard .stat-row strong { font-size: 0.82rem; min-width: 1.2rem; text-align: right; display: inline-block; }
/* Trend chart card */
#trendChartCard { display: flex; flex-direction: column; }
#trendChart { flex: 1; display: flex; align-items: center; justify-content: center; }
/* Team card */
#teamFocusCard { display: flex; flex-direction: column; }
/* Shipped card */
#shippedCard { display: flex; flex-direction: column; }
#shippedCard .shipped-body { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem; text-align: center; }
#shippedCard .shipped-bolt { font-size: 2.8rem; cursor: pointer; filter: drop-shadow(0 0 12px rgba(255,231,74,0.5)); transition: transform 200ms ease, filter 200ms ease; user-select: none; line-height: 1; }
#shippedCard .shipped-bolt:hover { transform: scale(1.15); filter: drop-shadow(0 0 20px rgba(255,231,74,0.8)); }
#shippedCard .shipped-bolt:active { transform: scale(0.95); }
#shippedCard .shipped-number { font-size: 2.6rem; font-weight: 800; color: #39ff88; font-variant-numeric: tabular-nums; line-height: 1; letter-spacing: -0.03em; text-shadow: 0 0 20px rgba(57,255,136,0.3); }
#shippedCard .shipped-label { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.15em; color: rgba(158,164,184,0.55); font-weight: 600; }
#shippedCard .shipped-bar { width: 100%; height: 6px; border-radius: 3px; background: rgba(255,255,255,0.06); overflow: hidden; margin-top: 0.25rem; }
#shippedCard .shipped-bar-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, #39ff88, #00e5ff); transition: width 800ms cubic-bezier(0.16, 1, 0.3, 1); }
.light #shippedCard .shipped-number { color: #16a34a; text-shadow: none; }
.light #shippedCard .shipped-bar { background: #e2e8f0; }
.light #shippedCard .shipped-label { color: #475569; }
.stat-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
.stat-dot-green { background: #39ff88; }
.stat-dot-purple { background: #d400ff; }
.stat-dot-amber { background: #ffe74a; }
.stat-dot-slate { background: #8be9fd; }
.stat-val-green { color: #16a34a !important; }
.stat-val-purple { color: #7c3aed !important; }
.stat-val-amber { color: #d97706 !important; }
.stat-val-slate { color: #64748b !important; }
.dark .stat-val-green, :root:not(.light) .stat-val-green { color: #39ff88 !important; }
.dark .stat-val-purple, :root:not(.light) .stat-val-purple { color: #e879f9 !important; }
.dark .stat-val-amber, :root:not(.light) .stat-val-amber { color: #ffe74a !important; }
.dark .stat-val-slate, :root:not(.light) .stat-val-slate { color: #8be9fd !important; }
.risk-list { display: flex; flex-direction: column; gap: 0.75rem; }
.risk-row { display: flex; justify-content: space-between; gap: 1rem; }
.risk-row p { font-weight: 600; color: var(--text-primary); }
.risk-row small { display: block; color: rgba(158,164,184,0.5); margin-top: 0.15rem; font-size: 0.75rem; }
.risk-value { font-weight: 700; color: #ff4d9d; }
.team-pills { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 0.35rem; margin-bottom: 0.5rem; position: relative; z-index: 1; flex: 1; }
.team-pill { padding: 0.38rem 0.55rem; border-radius: calc(var(--radius) - 2px); border: 1px solid rgba(255,255,255,0.05); background: rgba(255,255,255,0.02); font-size: 0.72rem; display: flex; flex-direction: column; gap: 0.05rem; transition: all 200ms ease; cursor: default; }
.team-pill:hover { background: rgba(168,85,247,0.06); border-color: rgba(168,85,247,0.15); }
.team-pill strong { font-size: 0.82rem; color: #f5f7ff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.team-pill small { color: rgba(158,164,184,0.45); font-size: 0.6rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.insight-note { font-size: 0.7rem; color: rgba(158,164,184,0.45); position: relative; z-index: 1; }
.dark .insight-card, :root:not(.light) .insight-card { background: rgba(30,33,52,0.72); border-color: rgba(196,181,253,0.2); box-shadow: 0 0 0 1px rgba(196,181,253,0.08), 0 8px 20px rgba(0,0,0,0.25); }
.dark .insight-card:hover, :root:not(.light) .insight-card:hover { border-color: rgba(216,180,254,0.42); box-shadow: 0 0 0 1px rgba(216,180,254,0.24), 0 12px 34px rgba(0,0,0,0.28), 0 0 42px rgba(216,180,254,0.16); }
.dark .radial-progress, :root:not(.light) .radial-progress { background: conic-gradient(#d400ff var(--progress), rgba(212,0,255,0.2) var(--progress), rgba(0,229,255,0.14) 100%); box-shadow: 0 0 26px rgba(212,0,255,0.25), 0 0 0 2px rgba(0,229,255,0.18); }
.dark .radial-progress::after, :root:not(.light) .radial-progress::after { background: rgba(12,14,24,0.96); box-shadow: inset 0 0 20px rgba(0,0,0,0.45); }
.dark .radial-progress strong, :root:not(.light) .radial-progress strong { color: #f8fbff; }
.dark .stat-row strong, .dark .risk-row p, .dark .team-pill strong, :root:not(.light) .stat-row strong, :root:not(.light) .risk-row p, :root:not(.light) .team-pill strong { color: #f8fbff; }
.dark .team-pill, :root:not(.light) .team-pill { border-color: rgba(196,181,253,0.18); background: rgba(255,255,255,0.05); color: rgba(214,224,255,0.82); }

/* ── Section ── */
.section { background: rgba(17,17,23,0.5); border: 1px solid rgba(255,255,255,0.06); border-radius: var(--radius); padding: 1.25rem; margin-bottom: 1.25rem; box-shadow: 0 0 0 1px rgba(255,255,255,0.02), 0 2px 8px rgba(0,0,0,0.15); backdrop-filter: blur(12px); }
.section h2 { font-size: 1.05rem; font-weight: 600; margin-bottom: 1rem; letter-spacing: -0.02em; color: var(--text-primary); display: flex; align-items: center; gap: 0.6rem; }
.dark .section, :root:not(.light) .section { background: rgba(30,33,52,0.72); border: 1px solid rgba(196,181,253,0.2); box-shadow: 0 0 0 1px rgba(196,181,253,0.08), 0 8px 20px rgba(0,0,0,0.25); }
.dark .section h2 { color: #f5f7ff; }

/* ── Filters ── */
.filters { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem; align-items: center; }
.filters label { font-size: 0.68rem; font-weight: 500; color: rgba(158,164,184,0.5); text-transform: uppercase; letter-spacing: 0.08em; }
.filters select { padding: 0.4rem 2rem 0.4rem 0.65rem; border: 1px solid rgba(255,255,255,0.08); border-radius: calc(var(--radius) - 0.25rem); font-size: 0.8rem; background: rgba(9,9,11,0.6) url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") no-repeat right 0.5rem center/1em; appearance: none; box-shadow: 0 1px 2px rgba(0,0,0,0.2); transition: border-color 150ms ease, box-shadow 150ms ease; color: #e2e8f0; }
.filters select:focus { outline: none; border-color: rgba(168,85,247,0.4); box-shadow: 0 0 0 2px rgba(168,85,247,0.15); }
.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
#searchToil { padding: 0.5rem 0.75rem; border: 1px solid rgba(255,255,255,0.08); border-radius: calc(var(--radius) - 0.25rem); font-size: 0.875rem; background: rgba(9,9,11,0.6); color: #e2e8f0; min-width: 200px; flex: 1; max-width: 320px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); transition: border-color 150ms ease, box-shadow 150ms ease; }
#searchToil::placeholder { color: rgba(158,164,184,0.55); }
#searchToil:focus { outline: none; border-color: rgba(168,85,247,0.4); box-shadow: 0 0 0 2px rgba(168,85,247,0.15); }
.show-cols-toggle { display: inline-flex; align-items: center; justify-content: center; gap: 0.35rem; padding: 0.42rem 0.72rem; border: 1px solid rgba(255,255,255,0.1); border-radius: calc(var(--radius) - 0.25rem); background: rgba(255,255,255,0.04); color: #e2e8f0; font-size: 0.73rem; font-weight: 550; cursor: pointer; transition: all 180ms ease; white-space: nowrap; }
.show-cols-toggle:hover { border-color: rgba(168,85,247,0.35); background: rgba(168,85,247,0.12); color: #e9d5ff; box-shadow: 0 4px 14px rgba(168,85,247,0.15); }
.show-cols-toggle:active { transform: scale(0.98); }

/* ── Tables ── */
table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.8rem; }
th, td { padding: 0.6rem 0.85rem; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.04); vertical-align: middle; }
th { background: rgba(5,4,7,0.8); font-weight: 500; color: rgba(158,164,184,0.6); position: sticky; top: 0; cursor: pointer; user-select: none; white-space: nowrap; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 0.7rem; letter-spacing: 0.06em; text-transform: uppercase; }
th[data-col="actions"], td.toil-action-cell { width: 210px; min-width: 210px; }
th[data-col="toil_score"], td.toil-score-cell { width: 76px; min-width: 76px; max-width: 76px; text-align: center; }
th[data-col="status"], td.toil-status-cell { width: 166px; min-width: 166px; max-width: 166px; text-align: left; }
td.toil-score-cell { font-weight: 700; font-variant-numeric: tabular-nums; vertical-align: middle; }
td.toil-action-cell, td.toil-status-cell { vertical-align: middle; }
td.toil-status-cell { white-space: nowrap; padding-left: 0.55rem; padding-right: 0.55rem; }
td.toil-status-cell .badge { justify-content: center; min-height: 34px; padding-left: 0.72rem; padding-right: 0.72rem; }
.toil-action-wrap, .toil-status-wrap { display: flex; align-items: center; min-height: 34px; }
.toil-action-wrap { justify-content: flex-start; }
.toil-status-wrap { justify-content: flex-start; }
th:first-child { border-top-left-radius: calc(var(--radius) - 1px); }
th:last-child { border-top-right-radius: calc(var(--radius) - 1px); }
th:hover { background: rgba(17,17,23,0.9); color: #e2e8f0; }
tr:last-child td { border-bottom: none; }
tbody tr:nth-child(even):not(.total-row) { background: rgba(255,255,255,0.015); }
tr:hover td { background: rgba(168,85,247,0.04); }
.table-wrap { border: 1px solid rgba(255,255,255,0.06); border-radius: var(--radius); overflow-x: auto; -webkit-overflow-scrolling: touch; background: rgba(17,17,23,0.4); box-shadow: 0 0 0 1px rgba(255,255,255,0.02); }
.dark .table-wrap, :root:not(.light) .table-wrap { background: rgba(26,29,46,0.72); border-color: rgba(196,181,253,0.2); box-shadow: 0 0 0 1px rgba(196,181,253,0.08); }
.dark th, :root:not(.light) th { background: rgba(13,16,28,0.92); color: rgba(214,224,255,0.85); border-bottom-color: rgba(196,181,253,0.22); }
.dark td, :root:not(.light) td { border-bottom-color: rgba(196,181,253,0.1); color: #e6ecff; }
.dark tbody tr:nth-child(even):not(.total-row), :root:not(.light) tbody tr:nth-child(even):not(.total-row) { background: rgba(255,255,255,0.03); }
.dark tr:hover td, :root:not(.light) tr:hover td { background: rgba(192,132,252,0.1); }

/* ── Priority Rows ── */
tr.priority-critical td:first-child { border-left: 4px solid #cf222e; }
tr.priority-high td:first-child { border-left: 4px solid #bf8700; }
tr.priority-medium td:first-child { border-left: 4px solid #1a7f37; }
tr.priority-low td:first-child { border-left: 4px solid #8b949e; }
/* Reset old border-left on tr */
tr.priority-critical, tr.priority-high, tr.priority-medium, tr.priority-low { border-left: none; }

/* ── Status Badges ── */
.badge { display: inline-flex; align-items: center; font-size: 0.66rem; font-weight: 600; padding: 0.24rem 0.62rem; border-radius: 999px; text-transform: none; letter-spacing: 0.01em; border: 1px solid transparent; line-height: 1.2; }
.badge-toil { background: rgba(168,85,247,0.16); color: #d8b4fe; border-color: rgba(168,85,247,0.35); }
.badge-triage { background: rgba(251,191,36,0.1); color: #fbbf24; border: 1px solid rgba(251,191,36,0.2); }
.badge-in-progress { background: rgba(168,85,247,0.1); color: #c084fc; border: 1px solid rgba(168,85,247,0.2); }
.badge-automated { background: rgba(74,222,128,0.1); color: #4ade80; border: 1px solid rgba(74,222,128,0.2); }
.dark .badge-toil, :root:not(.light) .badge-toil { background: rgba(168,85,247,0.16); color: #d8b4fe; border-color: rgba(168,85,247,0.35); }
.dark .badge-triage, :root:not(.light) .badge-triage { background: rgba(255,231,74,0.16); color: #fff59d; border-color: rgba(255,231,74,0.35); }
.dark .badge-in-progress, :root:not(.light) .badge-in-progress { background: rgba(212,0,255,0.16); color: #f0abfc; border-color: rgba(212,0,255,0.35); }
.dark .badge-automated, :root:not(.light) .badge-automated { background: rgba(57,255,136,0.16); color: #a7ffcf; border-color: rgba(57,255,136,0.35); }

/* ── Inline Edit ── */
td.editable { cursor: pointer; position: relative; }
td.editable:hover { background: rgba(165,107,255,0.04); border-radius: calc(var(--radius) - 0.25rem); }
td.editable input, td.editable select { font-size: 0.82rem; padding: 0.2rem 0.35rem; border: 1px solid var(--accent); border-radius: calc(var(--radius) - 0.25rem); width: 100%; background: var(--bg-card); }
.edited-marker { color: #a56bff; font-weight: 700; margin-left: 2px; font-size: 0.65rem; }

/* ── Team Manager Panel ── */
.team-manager { margin-bottom: 1.25rem; padding: 1rem; background: var(--bg-surface); border: 1px solid var(--border-card); border-radius: calc(var(--radius) - 0.25rem); }
.team-manager summary { font-weight: 600; font-size: 0.875rem; cursor: pointer; user-select: none; color: var(--text-primary); }
.team-manager summary:hover { color: var(--accent); }
.team-manager-list { margin-top: 0.75rem; display: flex; flex-direction: column; gap: 0.5rem; }
.team-rename-row { display: flex; align-items: center; gap: 0.5rem; }
.team-rename-row .team-current { font-size: 0.85rem; font-weight: 600; min-width: 140px; }
.team-rename-row span.arrow { color: #8b949e; font-size: 0.8rem; }
.team-rename-row input { font-size: 0.85rem; padding: 0.3rem 0.5rem; border: 1px solid var(--border-card); border-radius: calc(var(--radius) - 0.25rem); width: 180px; }
.team-rename-row .btn-rename { background: #0969da; color: #fff; border-color: #0969da; font-size: 0.75rem; padding: 0.25rem 0.5rem; }
.team-rename-row .btn-rename:hover { background: #0860ca; }
.team-rename-row .btn-rename:disabled { opacity: 0.5; cursor: not-allowed; }

/* ── Buttons ── */
.btn { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.4rem 0.85rem; border: 1px solid rgba(255,255,255,0.1); border-radius: calc(var(--radius) - 0.25rem); background: rgba(255,255,255,0.04); font-size: 0.78rem; font-weight: 500; cursor: pointer; transition: all 200ms ease; box-shadow: none; color: #e2e8f0; backdrop-filter: blur(8px); }
.btn:hover { background: rgba(168,85,247,0.1); border-color: rgba(168,85,247,0.25); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.btn:active { transform: scale(0.98); }
.btn-launch { background: linear-gradient(135deg, rgba(168,85,247,0.22), rgba(124,58,237,0.1)); color: #e9d5ff; border: 1px solid rgba(168,85,247,0.42); padding: 0.34rem 0.74rem; font-size: 0.72rem; font-weight: 600; line-height: 1.2; text-align: center; flex-direction: row; gap: 0.3rem; border-radius: 999px; white-space: nowrap; min-height: 34px; }
.btn-launch small { font-size: 0.7rem; opacity: 0.85; font-weight: 500; font-family: inherit; }
.btn-launch:hover { background: linear-gradient(135deg, rgba(168,85,247,0.3), rgba(124,58,237,0.16)); box-shadow: 0 0 20px rgba(168,85,247,0.16); border-color: rgba(196,181,253,0.55); }
.btn-save { background: rgba(37,99,235,0.15); color: #60a5fa; border: 1px solid rgba(37,99,235,0.3); }
.btn-save:hover { background: rgba(37,99,235,0.25); box-shadow: 0 0 15px rgba(37,99,235,0.1); }

/* ── Toil Name Cell ── */
.toil-name { font-weight: 600; font-size: 0.85rem; color: #e2e8f0; line-height: 1.4; letter-spacing: -0.01em; }
.toil-desc { font-size: 0.75rem; color: rgba(158,164,184,0.65); margin-top: 0.2rem; line-height: 1.5; font-weight: 400; }
.issue-link { color: #e879f9; font-weight: 600; text-decoration: none; }
.issue-link:hover { color: #d946ef; text-decoration: underline; }
.light .issue-link { color: #7c3aed; }
.light .issue-link:hover { color: #6d28d9; }
.toil-cell { min-width: 320px; padding-top: 1.25rem; padding-bottom: 1.25rem; }
.toil-action-cell .toil-action-inner { white-space: nowrap; display: flex; flex-direction: row; gap: 0.45rem; align-items: center; justify-content: flex-start; }
.status-toggle { cursor: pointer; transition: all 200ms ease; }
.status-toggle:hover { filter: brightness(1.2); transform: scale(1.05); }

/* ── Toast ── */
.toast { position: fixed; bottom: 1.5rem; right: 1.5rem; background: #111117; color: #f5f7ff; padding: 0.75rem 1.25rem; border-radius: var(--radius); font-size: 0.875rem; font-weight: 500; z-index: 9999; opacity: 0; transform: translateY(10px); transition: all 150ms ease; pointer-events: none; border: 1px solid #27272a; box-shadow: var(--shadow-md); }
.toast.show { opacity: 1; transform: translateY(0); }

/* ── Lightning Easter Egg ── */
.bolt-storm { position: fixed; inset: 0; pointer-events: none; z-index: 99998; overflow: hidden; }
.bolt-flash { position: absolute; inset: 0; background: radial-gradient(circle at 50% 20%, rgba(255,243,125,0.45), rgba(212,0,255,0.16) 35%, transparent 68%); animation: boltFlash 1.4s ease-out forwards; }
.storm-bolt { position: absolute; transform: translate(-50%, -50%); color: #fff07a; text-shadow: 0 0 8px rgba(255,231,74,0.9), 0 0 18px rgba(212,0,255,0.55); opacity: 0; animation: boltScatter 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

/* ── Micro Animations ── */
@keyframes pulseGlow {
  0% { box-shadow: 0 0 0 0 rgba(74,222,128,0.3); }
  60% { box-shadow: 0 0 0 8px rgba(74,222,128,0); }
  100% { box-shadow: 0 0 0 0 rgba(74,222,128,0); }
}
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(16px) scale(0.98); filter: blur(4px); }
  to { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
}
@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}
@keyframes glowPulse {
  0%, 100% { box-shadow: 0 0 20px rgba(168,85,247,0.1); }
  50% { box-shadow: 0 0 40px rgba(168,85,247,0.2), 0 0 60px rgba(168,85,247,0.05); }
}
@keyframes boltFlash {
  0% { opacity: 0; }
  12% { opacity: 1; }
  28% { opacity: 0.3; }
  42% { opacity: 0.8; }
  100% { opacity: 0; }
}
@keyframes boltScatter {
  0% { opacity: 0; transform: translate(-50%, -50%) scale(0.35) rotate(0deg); }
  15% { opacity: 1; }
  100% { opacity: 0; transform: translate(calc(-50% + var(--tx, 0px)), calc(-50% + var(--ty, -120px))) scale(1.05) rotate(var(--rot, -8deg)); }
}

/* ── Responsive ── */
/* ── Responsive: Tablet ── */
@media (max-width: 900px) {
  .container { padding: 1rem; }
  .cards { grid-template-columns: repeat(2, 1fr); }
  .header-inner { padding: 1rem 1.25rem; flex-direction: column; }
  .header-inner .meta { justify-content: flex-start; text-align: left; }
  .insight-body { flex-direction: column; }
  .stat-list { flex: 1 1 auto; width: 100%; max-width: 220px; }
  #pipelineCard .insight-body { flex-direction: column; }
  #pipelineCard .stat-list { width: 100%; max-width: 200px; }
  .insights-grid { grid-template-columns: 1fr; }
  .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .toil-cell { min-width: 200px; }
}

/* ── Responsive: Mobile ── */
@media (max-width: 480px) {
  .container { padding: 0.75rem; }
  .header-inner { padding: 0.75rem 1rem; }
  .header h1 { font-size: 1.2rem; }
  .hero-subtitle { font-size: 0.78rem; }
  .cards { grid-template-columns: 1fr 1fr; gap: 0.5rem; }
  .card { padding: 0.85rem; border-radius: calc(var(--radius) - 0.25rem); }
  .card .value { font-size: 1.6rem; }
  .section { padding: 0.85rem; border-radius: calc(var(--radius) - 0.25rem); }
  .filters { flex-direction: column; gap: 0.5rem; }
  .filters select { width: 100%; }
  .btn-launch { font-size: 0.75rem; padding: 0.4rem 0.75rem; min-height: 34px; }
  th[data-col="actions"], td.toil-action-cell { width: 180px; min-width: 180px; }
  th[data-col="status"], td.toil-status-cell { width: 146px; min-width: 146px; max-width: 146px; }
  th, td { padding: 0.6rem 0.5rem; font-size: 0.78rem; }
  .toil-cell { min-width: 160px; }
  .toil-action-cell .btn-launch { white-space: normal; }
}

/* ── Dark Mode Toggle ── */
.theme-toggle { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); border-radius: calc(var(--radius) - 0.25rem); color: rgba(255,255,255,0.6); padding: 0.3rem 0.65rem; font-size: 0.72rem; cursor: pointer; display: flex; align-items: center; gap: 0.3rem; transition: all 200ms ease; backdrop-filter: blur(8px); }
.theme-toggle:hover { background: rgba(168,85,247,0.1); border-color: rgba(168,85,247,0.25); color: #c084fc; }

/* ═══════════════════════════════════════════════════
   LIGHT MODE — complete override for all glass styles
   ═══════════════════════════════════════════════════ */
.light { color-scheme: light; }
.light body { background: #f8f9fc; color: #0e1018; }
.light body::before { background-image: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(168,85,247,0.04), transparent), radial-gradient(ellipse 60% 40% at 80% 50%, rgba(34,211,238,0.03), transparent); }
.light .header { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); }
.light .theme-toggle { background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.2); color: rgba(255,255,255,0.8); }
.light .theme-toggle:hover { background: rgba(255,255,255,0.2); }
.light .card { background: #fff; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 0 0 1px rgba(0,0,0,0.03); backdrop-filter: none; }
.light .card::before { background: linear-gradient(135deg, rgba(168,85,247,0.1), rgba(34,211,238,0.05), transparent 60%); }
.light .card::after { background: radial-gradient(300px circle at var(--mouse-x, 50%) var(--mouse-y, 50%), rgba(168,85,247,0.04), transparent 60%); }
.light .card:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.08), 0 0 0 1px rgba(168,85,247,0.08); border-color: #c4b5fd; }
.light .card .label { color: #475569; }
.light .card .value { color: #0f172a; }
.light .card .card-subtext { color: #475569; }
.light .card.emerald { background: linear-gradient(135deg, #ecfdf5, #f0f9ff); border-color: #a7f3d0; }
.light .card.emerald::before { background: linear-gradient(135deg, rgba(52,211,153,0.15), rgba(74,222,128,0.06), transparent 60%); }
.light .card.card-teaser { border-color: #e2e8f0; border-style: dashed; }
.light .card.card-teaser .value { opacity: 0.72; }
.light .card.card-teaser .card-subtext { color: #64748b; }
.light .micro-progress { background: #f1f5f9; }
.light .delta.positive { background: rgba(34,197,94,0.1); color: #16a34a; }
.light .delta.negative { background: rgba(239,68,68,0.1); color: #dc2626; }
.light .insight-card { background: #fff; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.06); backdrop-filter: none; }
.light .insight-card::before { background: linear-gradient(135deg, rgba(168,85,247,0.08), rgba(34,211,238,0.04), transparent 50%); }
.light .insight-card::after { background: radial-gradient(400px circle at 50% 0%, rgba(168,85,247,0.03), transparent 70%); }
.light .insight-card:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.08), 0 0 0 1px rgba(168,85,247,0.06); border-color: #c4b5fd; }
.light .insight-header .eyebrow { color: #475569; }
.light .mini-pill { border-color: #e2e8f0; color: #64748b; }
.light .mini-pill.live { border-color: rgba(34,197,94,0.3); color: #16a34a; background: rgba(34,197,94,0.06); }
.light .radial-progress { box-shadow: 0 0 15px rgba(168,85,247,0.08), 0 0 0 2px rgba(168,85,247,0.06); }
.light .radial-progress::after { background: #fff; box-shadow: inset 0 0 10px rgba(0,0,0,0.04); }
.light .radial-progress strong { color: #0f172a; }
.light .radial-progress span { color: #94a3b8; }
.light .stat-row { color: #475569; }
.light .stat-row strong { color: #0f172a; }
.light .team-pill { border-color: #e2e8f0; background: #f8fafc; color: #475569; }
.light .team-pill:hover { background: rgba(168,85,247,0.04); border-color: #c4b5fd; }
.light .team-pill strong { color: #0f172a; }
.light .team-pill small { color: #64748b; }
.light .insight-note { color: #64748b; }
.light .section { background: #fff; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.06); backdrop-filter: none; }
.light .section h2 { color: #0f172a; }
.light .filters label { color: #475569; }
.light .filters select { background-color: #fff; border-color: #e2e8f0; color: #0f172a; }
.light .filters select:focus { border-color: #a855f7; box-shadow: 0 0 0 2px rgba(168,85,247,0.12); }
.light #searchToil { background: #fff; border-color: #e2e8f0; color: #0f172a; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
.light #searchToil::placeholder { color: #94a3b8; }
.light table { font-size: 0.8rem; }
.light th { background: #f8fafc; color: #334155; border-bottom-color: #e2e8f0; }
.light th:hover { background: #f1f5f9; color: #0f172a; }
.light td { border-bottom-color: #f1f5f9; color: #1f2937; }
.light tbody tr:nth-child(even):not(.total-row) { background: #fafbfc; }
.light tr:hover td { background: rgba(168,85,247,0.03); }
.light tr.total-row { background: rgba(168,85,247,0.04); }
.light .table-wrap { background: #fff; border-color: #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
.light .toil-name { color: #0b1220; font-weight: 650; }
.light .toil-desc { color: #475569; }
.light .btn { background: #fff; border-color: #e2e8f0; color: #1f2937; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
.light .btn:hover { background: #f8fafc; border-color: #c4b5fd; }
.light .btn-launch { background: linear-gradient(135deg, rgba(168,85,247,0.13), rgba(192,132,252,0.08)); color: #6d28d9; border-color: rgba(124,58,237,0.28); }
.light .btn-launch:hover { background: linear-gradient(135deg, rgba(168,85,247,0.2), rgba(192,132,252,0.13)); box-shadow: 0 0 15px rgba(124,58,237,0.12); }
.light .show-cols-toggle { background: #fff; border-color: #e2e8f0; color: #475569; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
.light .show-cols-toggle:hover { background: #f8fafc; border-color: #c4b5fd; color: #6d28d9; box-shadow: 0 4px 12px rgba(124,58,237,0.1); }
.light .btn-save { background: rgba(37,99,235,0.08); color: #2563eb; border-color: rgba(37,99,235,0.2); }
.light .badge-toil { background: rgba(124,58,237,0.1); color: #6d28d9; border-color: rgba(124,58,237,0.24); }
.light .badge-triage { background: rgba(191,135,0,0.08); color: #bf8700; }
.light .badge-in-progress { background: rgba(168,85,247,0.08); color: #7c3aed; }
.light .badge-automated { background: rgba(34,197,94,0.08); color: #16a34a; }
.light .toast { background: #fff; color: #0f172a; border-color: #e2e8f0; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
.light .trend-label { fill: #94a3b8; }
.light .trend-value { fill: #0f172a; }
.light .trend-axis { stroke: #e2e8f0; }
.light .trend-grid { stroke: #f1f5f9; }
.light a { color: #7c3aed; }
.light .edited-marker { color: #7c3aed; }

/* ── Dark Mode (GitHub Primer Dark) ── */
@media (prefers-color-scheme: dark) {
  :root:not(.light) {
    color-scheme: dark;
    --bg-surface: #070914;
    --bg-card: #1a1d30;
    --border-card: #3a4167;
    --text-soft: #b9c4e6;
    --text-primary: #f7faff;
  }
}
.dark { color-scheme: dark; }
.dark body, :root:not(.light) body { background: #070914; color: #f8fbff; }
.dark body::before, :root:not(.light) body::before { opacity: 0.78; }

/* Unified Dark Mode Styles */
.dark .header,
@media (prefers-color-scheme: dark) { :root:not(.light) .header { background: linear-gradient(135deg, #0b0d1d 0%, #1c0f2d 100%); } }

.dark .header .meta,
@media (prefers-color-scheme: dark) { :root:not(.light) .header .meta { color: #9ea4b8; } }

.dark .card,
@media (prefers-color-scheme: dark) { :root:not(.light) .card { background: rgba(32,36,56,0.78); border-color: rgba(196,181,253,0.22); box-shadow: 0 0 0 1px rgba(196,181,253,0.12), 0 6px 18px rgba(0,0,0,0.28); } }

.dark .card.emerald,
@media (prefers-color-scheme: dark) { :root:not(.light) .card.emerald { background: rgba(10,42,29,0.78) !important; border-color: rgba(57,255,136,0.24) !important; } }

.dark .card:hover,
@media (prefers-color-scheme: dark) { :root:not(.light) .card:hover { box-shadow: 0 0 0 1px rgba(196,181,253,0.24), 0 10px 34px rgba(0,0,0,0.34), 0 0 52px rgba(192,132,252,0.2); border-color: rgba(196,181,253,0.4); } }

.dark .card .label,
@media (prefers-color-scheme: dark) { :root:not(.light) .card .label { color: rgba(214,224,255,0.82); } }

.dark .card .value,
@media (prefers-color-scheme: dark) { :root:not(.light) .card .value { color: #f8fbff; } }

.dark .card .value.green,
@media (prefers-color-scheme: dark) { :root:not(.light) .card .value.green { color: #39ff88; } }

.dark .card .value.purple,
@media (prefers-color-scheme: dark) { :root:not(.light) .card .value.purple { color: #e879f9; } }

.dark .card .value.orange,
@media (prefers-color-scheme: dark) { :root:not(.light) .card .value.orange { color: #ffe74a; } }

.dark .section,
@media (prefers-color-scheme: dark) { :root:not(.light) .section { background: rgba(30,33,52,0.72); border-color: rgba(196,181,253,0.2); } }

.dark .filters label,
@media (prefers-color-scheme: dark) { :root:not(.light) .filters label { color: rgba(214,224,255,0.72); } }

.dark .filters select,
@media (prefers-color-scheme: dark) { :root:not(.light) .filters select { background-color: rgba(20,23,38,0.88); border-color: rgba(196,181,253,0.24); color: #f1f5ff; } }

.dark th,
@media (prefers-color-scheme: dark) { :root:not(.light) th { background: rgba(13,16,28,0.92); color: rgba(214,224,255,0.85); border-color: rgba(196,181,253,0.22); } }

.dark th:hover,
@media (prefers-color-scheme: dark) { :root:not(.light) th:hover { background: rgba(32,36,56,0.95); } }

.dark td,
@media (prefers-color-scheme: dark) { :root:not(.light) td { border-color: rgba(196,181,253,0.1); color: #e6ecff; } }

.dark tr:hover,
@media (prefers-color-scheme: dark) { :root:not(.light) tr:hover { background: rgba(192,132,252,0.1); } }

.dark tr.total-row,
@media (prefers-color-scheme: dark) { :root:not(.light) tr.total-row { background: rgba(192,132,252,0.12); } }

.dark td.editable:hover,
@media (prefers-color-scheme: dark) { :root:not(.light) td.editable:hover { background: rgba(165,107,255,0.1); } }

.dark td.editable input, .dark td.editable select,
@media (prefers-color-scheme: dark) { :root:not(.light) td.editable input, :root:not(.light) td.editable select { background: rgba(20,23,38,0.92); border-color: rgba(196,181,253,0.3); color: #f8fbff; } }

.dark .btn,
@media (prefers-color-scheme: dark) { :root:not(.light) .btn { background: rgba(255,255,255,0.08); border-color: rgba(196,181,253,0.28); color: #eef2ff; } }

.dark .btn:hover,
@media (prefers-color-scheme: dark) { :root:not(.light) .btn:hover { background: rgba(192,132,252,0.16); border-color: rgba(216,180,254,0.42); } }

.dark .btn-launch,
@media (prefers-color-scheme: dark) { :root:not(.light) .btn-launch { background: linear-gradient(135deg, rgba(168,85,247,0.22), rgba(124,58,237,0.1)); color: #e9d5ff; border-color: rgba(168,85,247,0.42); } }

.dark .btn-launch:hover,
@media (prefers-color-scheme: dark) { :root:not(.light) .btn-launch:hover { background: linear-gradient(135deg, rgba(168,85,247,0.3), rgba(124,58,237,0.16)); box-shadow: 0 0 20px rgba(168,85,247,0.15); } }

.dark .toil-name,
@media (prefers-color-scheme: dark) { :root:not(.light) .toil-name { color: #f5f7ff; } }

.dark .toil-desc,
@media (prefers-color-scheme: dark) { :root:not(.light) .toil-desc { color: #cbd5ff; } }

.dark .btn-save,
@media (prefers-color-scheme: dark) { :root:not(.light) .btn-save { background: #2563eb; color: #fff; border-color: #1d4ed8; } }

.dark .btn-save:hover,
@media (prefers-color-scheme: dark) { :root:not(.light) .btn-save:hover { background: #1d4ed8; } }

.dark .badge-toil,
@media (prefers-color-scheme: dark) { :root:not(.light) .badge-toil { background: rgba(168,85,247,0.16); color: #d8b4fe; border-color: rgba(168,85,247,0.35); } }

.dark .badge-triage,
@media (prefers-color-scheme: dark) { :root:not(.light) .badge-triage { background: rgba(255,231,74,0.16); color: #fff59d; border-color: rgba(255,231,74,0.35); } }

.dark .badge-in-progress,
@media (prefers-color-scheme: dark) { :root:not(.light) .badge-in-progress { background: rgba(212,0,255,0.16); color: #f0abfc; border-color: rgba(212,0,255,0.35); } }

.dark .badge-automated,
@media (prefers-color-scheme: dark) { :root:not(.light) .badge-automated { background: rgba(57,255,136,0.16); color: #a7ffcf; border-color: rgba(57,255,136,0.35); } }

.dark .toast,
@media (prefers-color-scheme: dark) { :root:not(.light) .toast { background: rgba(30,33,52,0.92); color: #eef2ff; border-color: rgba(216,180,254,0.3); backdrop-filter: blur(12px); } }

.dark .edited-marker,
@media (prefers-color-scheme: dark) { :root:not(.light) .edited-marker { color: #dec0ff; } }

.dark .team-manager,
@media (prefers-color-scheme: dark) { :root:not(.light) .team-manager { background: rgba(20,23,38,0.88); border-color: rgba(196,181,253,0.22); } }

.dark .team-manager summary,
@media (prefers-color-scheme: dark) { :root:not(.light) .team-manager summary { color: #f5f7ff; } }

.dark .team-rename-row input,
@media (prefers-color-scheme: dark) { :root:not(.light) .team-rename-row input { background: rgba(20,23,38,0.92); border-color: rgba(196,181,253,0.24); color: #f8fbff; } }

.dark .team-rename-row .btn-rename,
@media (prefers-color-scheme: dark) { :root:not(.light) .team-rename-row .btn-rename { background: #2563eb; border-color: #1d4ed8; } }

.dark a,
@media (prefers-color-scheme: dark) { :root:not(.light) a { color: #e879f9; } }

.dark .theme-toggle { border-color: rgba(255,255,255,0.1); }

/* ── Trend Chart ── */
#trendChart { flex: 1; display: flex; align-items: center; justify-content: center; min-height: 108px; }
.trend-chart-wrap { width: 100%; overflow-x: auto; flex: 0 0 auto; display: flex; align-items: flex-start; justify-content: center; }
.trend-chart-wrap svg { display: block; width: auto; max-width: 100%; height: auto; }
.trend-bar { transition: opacity 0.2s; }
.trend-bar:hover { opacity: 0.8; }
.trend-label { font-size: 9px; fill: rgba(158,164,184,0.5); font-family: 'Inter', system-ui, sans-serif; }
.trend-value { font-size: 9px; fill: #e2e8f0; font-weight: 600; font-family: 'Inter', system-ui, sans-serif; }
.trend-axis { stroke: rgba(255,255,255,0.06); stroke-width: 1; }
.trend-grid { stroke: rgba(255,255,255,0.03); stroke-width: 1; stroke-dasharray: 4 4; }

.dark .trend-label,
@media (prefers-color-scheme: dark) { :root:not(.light) .trend-label { fill: #a1a1aa; } }

.dark .trend-value,
@media (prefers-color-scheme: dark) { :root:not(.light) .trend-value { fill: #fafafa; } }

.dark .trend-axis,
@media (prefers-color-scheme: dark) { :root:not(.light) .trend-axis { stroke: #27272a; } }

.dark .trend-grid,
@media (prefers-color-scheme: dark) { :root:not(.light) .trend-grid { stroke: #18181b; } }

/* ── Print ── */
@media print {
  .btn-launch, .btn-save, .filters, .theme-toggle, .toast, .hero-pulse { display: none !important; }
  .card, .section { break-inside: avoid; }
}
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
  <div class="hero-left">
    <p class="hero-eyebrow">Live Data · DUBSOpenHub/ospo-toil-tracker</p>
    <h1><span class="hero-bolt" title="Psst… click me">⚡</span> AI Toil Tracker</h1>
    <p id="teamName" title="Click to rename your team" style="cursor:pointer;font-size:1.15rem;font-weight:600;color:rgba(255,255,255,0.75);letter-spacing:-0.01em">Open Source Programs Team ✎</p>
    <p class="hero-subtitle">See your team's repetitive work, watch AI eliminate it, and track the hours everyone gets back.</p>
    <p style="font-size:0.72rem;color:rgba(255,255,255,0.35);margin-top:0.25rem;letter-spacing:0.02em;">Built and powered by the Copilot CLI</p>
    <div class="hero-pulse" id="heroPulse">
      <span class="pulse-pill neutral">⚡ Scanning for toil…</span>
    </div>
  </div>
  <div class="meta">
    <span id="headerRepo"></span>
    <span>Generated: <span id="headerDate">—</span></span>
    <a href="#" id="headerRepoLink" target="_blank" rel="noopener noreferrer">View on GitHub ↗</a>
    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" aria-label="Toggle dark or light mode" title="Toggle dark/light mode">🌙 Dark</button>
  </div>
  </div>
</div>

<div class="container">

  <!-- Summary Cards -->
  <div class="cards" id="summaryCards" aria-live="polite" aria-label="Summary statistics"></div>

  <!-- Insights Grid -->
  <div class="insights-grid" id="insightsGrid">
    <article class="insight-card" id="pipelineCard"></article>
    <article class="insight-card" id="trendChartCard">
      <div class="insight-header">
        <span class="eyebrow">Time Reclaimed <span class="card-help">?<span class="card-tip">Monthly hours your team gets back as toil is automated. Each bar shows cumulative time savings over time.</span></span></span>
        <span class="mini-pill live">Live</span>
      </div>
      <div id="trendChart" role="img" aria-label="Bar chart showing monthly hours saved from automation over time"></div>
    </article>
    <article class="insight-card" id="shippedCard"></article>
  </div>

  <!-- Main Toil Ideas Table -->
  <div class="section">
    <h2>🗂️ Toil Backlog <span class="card-help">?<span class="card-tip">All toil issues filed by your team. Sort by impact score or time saved to prioritize what to automate first.</span></span></h2>
    <div class="filters" role="search" aria-label="Filter toil ideas">
      <label for="searchToil" class="sr-only">Search:</label>
      <input type="search" id="searchToil" placeholder="🔍 Search toil ideas..." aria-label="Search toil ideas">
      <label for="filterTeam">Team:</label>
      <select id="filterTeam"><option value="">All</option></select>
      <label for="filterCategory">Category:</label>
      <select id="filterCategory"><option value="">All</option></select>
      <label for="filterStatus">Status:</label>
      <select id="filterStatus"><option value="">All</option></select>
      <label for="filterSort">📊 Sort by:</label>
      <select id="filterSort">
        <option value="monthly_saved_minutes">⏱️ Potential Time Saved / Month</option>
        <option value="toil_score">🎯 Impact Score</option>
        <option value="submitter">🧑‍💻 Person</option>
      </select>
      <button class="show-cols-toggle" id="toggleCols" onclick="toggleColumns()">+ Show all details</button>
      <button class="show-cols-toggle" onclick="exportCSV()" title="Download as CSV">📥 CSV</button>
      <button class="show-cols-toggle" onclick="exportJSON()" title="Download as JSON">📥 JSON</button>
    </div>
    <div class="table-wrap">
      <table id="toilTable">
        <thead>
          <tr>
            <th scope="col" data-col="number" tabindex="0" role="button" aria-label="Sort by number">#️⃣</th>
            <th scope="col" data-col="title" tabindex="0" role="button" aria-label="Sort by toil name">💡 Toil</th>
            <th scope="col" data-col="actions"></th>
            <th scope="col" data-col="submitter" tabindex="0" role="button" aria-label="Sort by submitter">🧑‍💻 Submitter</th>
            <th scope="col" data-col="category" class="col-hidden" tabindex="0" role="button" aria-label="Sort by category">🏷️ Category</th>
            <th scope="col" data-col="frequency" tabindex="0" role="button" aria-label="Sort by frequency">🔄 Frequency</th>
            <th scope="col" data-col="time_per_occurrence" tabindex="0" role="button" aria-label="Sort by time">⏱️ Time</th>
            <th scope="col" data-col="people_affected" tabindex="0" role="button" aria-label="Sort by people affected">👥 People</th>
            <th scope="col" data-col="toil_score" tabindex="0" role="button" aria-label="Sort by impact score">Score</th>
            <th scope="col" data-col="status" tabindex="0" role="button" aria-label="Sort by status">Status</th>
            <th scope="col" data-col="monthly_saved_minutes" tabindex="0" role="button" aria-label="Sort by time saved">⏱️ Time Saved / Month</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Team Load (below toil backlog) -->
  <article class="insight-card" id="teamFocusCard" style="margin-bottom: 1.25rem;"></article>

</div>

<div class="toast" id="toast"></div>

<script>
// ═══════════════════════════════════════════════════
// THEME — Dark/Light mode with localStorage persistence
// ═══════════════════════════════════════════════════
function initTheme() {
  const saved = localStorage.getItem('toilDashTheme');
  if (saved === 'dark') { applyDark(); }
  else if (saved === 'light') { applyLight(); }
  // else: follow system preference via CSS prefers-color-scheme
}
function toggleTheme() {
  const html = document.documentElement;
  if (html.classList.contains('dark')) { applyLight(); localStorage.setItem('toilDashTheme', 'light'); }
  else { applyDark(); localStorage.setItem('toilDashTheme', 'dark'); }
}
function applyDark() {
  document.documentElement.classList.add('dark');
  document.documentElement.classList.remove('light');
  const btn = document.getElementById('themeToggle');
  if (btn) { btn.innerHTML = '☀️ Light'; }
}
function applyLight() {
  document.documentElement.classList.remove('dark');
  document.documentElement.classList.add('light');
  const btn = document.getElementById('themeToggle');
  if (btn) { btn.innerHTML = '🌙 Dark'; }
}
initTheme();

// ═══════════════════════════════════════════════════
// CONFIG — Set your owner/repo here
// ═══════════════════════════════════════════════════
const CONFIG = {
  owner: '',
  repo: '',
  get fullRepo() { return `${this.owner}/${this.repo}`; }
};
// Auto-detect from GitHub Pages URL (e.g. owner.github.io/repo/dashboard/)
(function() {
  const parts = window.location.pathname.split('/').filter(Boolean);
  if (window.location.hostname.endsWith('.github.io') && parts.length >= 1) {
    CONFIG.owner = window.location.hostname.split('.')[0];
    CONFIG.repo = parts[0];
  } else {
    // Fallback — edit these if not on GitHub Pages
    CONFIG.owner = 'DUBSOpenHub';
    CONFIG.repo = 'ospo-toil-tracker';
  }
})();

// ═══════════════════════════════════════════════════
// SCORE MULTIPLIERS (matches ai-triage.yml)
// ═══════════════════════════════════════════════════
const FREQ_SCORES = {
  '🔴 Multiple times per day': { score: 8, monthly: 60 },
  '🟠 Daily': { score: 5, monthly: 20 },
  '🟡 Multiple times per week': { score: 3, monthly: 10 },
  '🔵 Weekly': { score: 2, monthly: 4 },
  '⚪ Monthly or less': { score: 1, monthly: 1 }
};
const TIME_SCORES = {
  '> 1 hour': { score: 8, mins: 75 },
  '30–60 minutes': { score: 5, mins: 45 },
  '15–30 minutes': { score: 3, mins: 22 },
  '5–15 minutes': { score: 2, mins: 10 },
  '< 5 minutes': { score: 1, mins: 3 }
};
const PEOPLE_SCORES = {
  'Multiple teams / org-wide': { score: 8 },
  'Entire team': { score: 5 },
  '4\u20136 people': { score: 3 },
  '2\u20133 people': { score: 2 },
  'Just me': { score: 1 }
};
const BONUS_MAP = {
  '❌ Error-prone': 2,
  '🔗 Blocking': 3,
  '😤 Morale killer': 1,
  '📈 Growing worse': 2,
  '🆕 New team friction': 1
};

const PRIORITY_BANDS = [
  { id: 'critical', min: 40, className: 'priority-critical', label: '🔴 Critical' },
  { id: 'high', min: 20, className: 'priority-high', label: '🟠 High' },
  { id: 'medium', min: 10, className: 'priority-medium', label: '🟡 Medium' },
  { id: 'low', min: 0, className: 'priority-low', label: '⚪ Low' }
];
const CRITICAL_THRESHOLD = PRIORITY_BANDS[0].min;

function getPriorityBand(score = 0) {
  return PRIORITY_BANDS.find(band => score >= band.min) || PRIORITY_BANDS[PRIORITY_BANDS.length - 1];
}

function isCritical(score = 0) {
  return score >= CRITICAL_THRESHOLD;
}

// ═══════════════════════════════════════════════════
// SAMPLE DATA
// ═══════════════════════════════════════════════════
const SAMPLE_DATA = {
  repo: CONFIG.fullRepo,
  generated_at: new Date().toISOString(),
  issues: [
    {
      number: 1,
      title: "[TOIL] Staging Deploy — Manual deployment steps for staging environment",
      url: `https://github.com/${CONFIG.fullRepo}/issues/1`,
      state: "open",
      labels: ["toil", "high-impact", "🔴 multiple-times-daily"],
      submitter: "Maya Patel (@mayap)",
      team: "Platform",
      category: "🔧 CI/CD & Builds",
      frequency: "🔴 Multiple times per day",
      time_per_occurrence: "30–60 minutes",
      people_affected: "Entire team",
      bonus_factors: ["❌ Error-prone", "🔗 Blocking"],
      automation_idea: "Create a CI/CD pipeline with GitHub Actions to automate staging deployments",
      toil_score: 200,
      priority: "🔴 Critical",
      monthly_saved_minutes: 6000,
      weekly_time_spent: 1500,
      team_weekly_time_spent: 4200,
      weekly_time_spent_display: "25 hrs/week",
      team_weekly_time_spent_display: "70 hrs/week",
      created_at: "2026-02-10T10:00:00Z",
      ai_suggestion: "Use reusable GitHub Actions workflow with environment gates"
    },
    {
      number: 2,
      title: "[TOIL] Credential Rotation — Rotating database credentials manually every week",
      url: `https://github.com/${CONFIG.fullRepo}/issues/2`,
      state: "open",
      labels: ["toil", "triage"],
      submitter: "Liam Ortiz (@liamortiz)",
      team: "DevOps",
      category: "🔐 Security & Compliance",
      frequency: "🔵 Weekly",
      time_per_occurrence: "15–30 minutes",
      people_affected: "2-3 people",
      bonus_factors: ["❌ Error-prone"],
      automation_idea: "Use AWS Secrets Manager automatic rotation",
      toil_score: 14,
      priority: "🟡 Medium",
      monthly_saved_minutes: 4800,
      weekly_time_spent: 1200,
      team_weekly_time_spent: 2400,
      weekly_time_spent_display: "20 hrs/week",
      team_weekly_time_spent_display: "40 hrs/week",
      created_at: "2026-02-04T14:30:00Z",
      ai_suggestion: "Configure AWS Secrets Manager with Lambda rotation function"
    },
    {
      number: 3,
      title: "[TOIL] Test Results — Copy-pasting test results into Slack every morning",
      url: `https://github.com/${CONFIG.fullRepo}/issues/3`,
      state: "closed",
      labels: ["toil", "automated"],
      submitter: "Nina Gomez (@ninagomez)",
      team: "Engineering",
      category: "📊 Reporting & Communication",
      frequency: "🟠 Daily",
      time_per_occurrence: "5–15 minutes",
      people_affected: "Just you",
      bonus_factors: ["😤 Morale killer"],
      automation_idea: "Slack bot that posts CI results automatically",
      toil_score: 11,
      priority: "🟡 Medium",
      monthly_saved_minutes: 3600,
      weekly_time_spent: 900,
      team_weekly_time_spent: 900,
      weekly_time_spent_display: "15 hrs/week",
      team_weekly_time_spent_display: "15 hrs/week",
      created_at: "2026-01-18T09:00:00Z",
      ai_suggestion: "GitHub Actions workflow with Slack notification step"
    },
    {
      number: 4,
      title: "[TOIL] Dep Updates — Updating dependency versions across 12 microservices",
      url: `https://github.com/${CONFIG.fullRepo}/issues/4`,
      state: "open",
      labels: ["toil", "in-progress", "high-impact"],
      submitter: "Ravi Shah (@ravishah)",
      team: "Platform",
      category: "🔧 CI/CD & Builds",
      frequency: "🟡 Multiple times per week",
      time_per_occurrence: "> 1 hour",
      people_affected: "4-6 people",
      bonus_factors: ["❌ Error-prone", "📈 Growing worse"],
      automation_idea: "Dependabot with auto-merge for patch versions",
      toil_score: 76,
      priority: "🔴 Critical",
      monthly_saved_minutes: 2400,
      weekly_time_spent: 600,
      team_weekly_time_spent: 1800,
      weekly_time_spent_display: "10 hrs/week",
      team_weekly_time_spent_display: "30 hrs/week",
      created_at: "2025-12-12T11:00:00Z",
      ai_suggestion: "Set up Dependabot with grouped updates and auto-merge workflow"
    },
    {
      number: 5,
      title: "[TOIL] Dev Onboarding — Manual environment setup for new engineers",
      url: `https://github.com/${CONFIG.fullRepo}/issues/5`,
      state: "open",
      labels: ["toil", "triage"],
      submitter: "Priya Desai (@priyadesai)",
      team: "Product",
      category: "🆕 Onboarding & Access",
      frequency: "⚪ Monthly or less",
      time_per_occurrence: "> 1 hour",
      people_affected: "2-3 people",
      bonus_factors: ["🆕 New team friction", "😤 Morale killer"],
      automation_idea: "Dev container or Codespaces setup with scripted provisioning",
      toil_score: 18,
      priority: "🟡 Medium",
      monthly_saved_minutes: 1200,
      weekly_time_spent: 300,
      team_weekly_time_spent: 600,
      weekly_time_spent_display: "5 hrs/week",
      team_weekly_time_spent_display: "10 hrs/week",
      created_at: "2025-11-05T16:00:00Z",
      ai_suggestion: "Create devcontainer.json with all tools and extensions pre-configured"
    },
    {
      number: 6,
      title: "[TOIL] Ticket Triage — Routing incoming support tickets from Zendesk",
      url: `https://github.com/${CONFIG.fullRepo}/issues/6`,
      state: "closed",
      labels: ["toil", "high-impact", "automated"],
      submitter: "Jordan Reed (@jordanreed)",
      team: "Engineering",
      category: "📊 Reporting & Communication",
      frequency: "🟠 Daily",
      time_per_occurrence: "30–60 minutes",
      people_affected: "Entire team",
      bonus_factors: ["🔗 Blocking", "📈 Growing worse"],
      automation_idea: "Use an AI classifier to auto-route tickets by category",
      toil_score: 55,
      priority: "🔴 Critical",
      monthly_saved_minutes: 3000,
      weekly_time_spent: 750,
      team_weekly_time_spent: 2250,
      weekly_time_spent_display: "12.5 hrs/week",
      team_weekly_time_spent_display: "37.5 hrs/week",
      created_at: "2026-01-05T08:00:00Z",
      ai_suggestion: "Train a classifier on historical ticket data to auto-label and route"
    }
  ]
};

// ═══════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════
let dashboardData = null;
let sortCol = 'team_weekly_time_spent';
let sortDir = -1; // -1 = desc
const localEdits = JSON.parse(localStorage.getItem('toilEdits') || '{}');

// ═══════════════════════════════════════════════════
// DATA LOADING
// ═══════════════════════════════════════════════════
function normalizeData(raw) {
  // Workflow-generated format: { meta: {...}, issues: [{scoring:{}, roi:{}}] }
  if (raw.meta && raw.issues) {
    return {
      repo: raw.meta.repo || CONFIG.fullRepo,
      generated_at: raw.meta.generatedAt || new Date().toISOString(),
      issues: raw.issues.map(item => ({
        number: item.number,
        title: item.title,
        url: item.url,
        state: (item.state || '').toLowerCase(),
        labels: item.labels || [],
        submitter: item.author ? `${item.author} (@${item.author})` : 'Unknown contributor',
        team: item.team || 'Unassigned team',
        category: item.category || 'Other',
        frequency: reverseFreqScore(item.scoring?.frequency),
        time_per_occurrence: reverseTimeScore(item.scoring?.time),
        people_affected: reversePeopleScore(item.scoring?.people),
        bonus_factors: [],
        automation_idea: '',
        toil_score: item.scoring?.adjusted || item.scoring?.base || 1,
        priority: getPriorityLabel(item.scoring?.adjusted || item.scoring?.base || 1),
        monthly_saved_minutes: item.roi?.monthlyMins || 0,
        created_at: item.createdAt,
        ai_suggestion: ''
      }))
    };
  }
  if (raw.toilItems) {
    return {
      repo: raw.repository,
      generated_at: raw.generatedAt,
      issues: raw.toilItems.map(item => ({
        number: item.number,
        title: item.title,
        url: item.url,
        state: item.state?.toLowerCase() || 'unknown',
        labels: (item.labels || '').split(',').filter(Boolean),
        submitter: item.submitter,
        team: item.team,
        category: item.category,
        frequency: item.frequency?.label || 'unknown',
        time_per_occurrence: item.time?.label || 'unknown',
        people_affected: item.people?.label || 'unknown',
        bonus_factors: item.bonusFactors || [],
        automation_idea: item.automationIdea || '',
        toil_score: item.toilScore,
        priority: item.priority,
        monthly_saved_minutes: item.monthlyMinutes,
        created_at: item.createdAt,
        ai_suggestion: ''
      })),
      wins: raw.wins || [],
      summary: raw.summary
    };
  }
  return raw; // Legacy format pass-through
}

function reverseFreqScore(s) {
  const map = {8:'🔴 Multiple times per day',5:'🟠 Daily',3:'🟡 Multiple times per week',2:'🔵 Weekly',1:'⚪ Monthly or less'};
  return map[s] || '⚪ Monthly or less';
}
function reverseTimeScore(s) {
  const map = {8:'> 1 hour',5:'30–60 minutes',3:'15–30 minutes',2:'5–15 minutes',1:'< 5 minutes'};
  return map[s] || '< 5 minutes';
}
function reversePeopleScore(s) {
  const map = {8:'Multiple teams / org-wide',5:'Entire team',3:'4–6 people',2:'2–3 people',1:'Just me'};
  return map[s] || 'Just me';
}

async function loadData() {
  // Try the workflow-generated JSON first (works locally and on Pages)
  try {
    const res = await fetch('../dashboard-data.json');
    if (res.ok) {
      const json = await res.json();
      if (json.issues && json.issues.length > 0) {
        dashboardData = normalizeData(json);
        applyLocalEdits();
        render();
        return;
      }
    }
  } catch (_) { /* fall through */ }

  // Fallback: GitHub API (works for public repos or with token)
  try {
    const apiUrl = `https://api.github.com/repos/${CONFIG.fullRepo}/issues?labels=toil&state=all&per_page=100`;
    const res = await fetch(apiUrl);
    if (res.ok) {
      const apiIssues = await res.json();
      if (apiIssues.length > 0) {
        dashboardData = convertApiIssues(apiIssues);
        applyLocalEdits();
        render();
        return;
      }
    }
  } catch (_) { /* fall through */ }

  // No data — show empty state
  dashboardData = { repo: CONFIG.fullRepo, generated_at: new Date().toISOString(), issues: [] };
  render();
  showEmptyState();
}

function showEmptyState() {
  const container = document.querySelector('.container');
  const msg = document.createElement('div');
  msg.className = 'section';
  msg.style.textAlign = 'center';
  msg.style.padding = '3rem 2rem';
  msg.innerHTML = `
    <h2 style="margin-bottom:1rem">📭 No toil issues found yet</h2>
    <p style="color:var(--text-soft);max-width:480px;margin:0 auto 1.5rem">
      Issues labeled <code style="background:rgba(14,138,22,0.12);color:#0e8a16;padding:0.15rem 0.45rem;border-radius:4px;font-size:0.85rem">toil</code>
      in <a href="https://github.com/${CONFIG.fullRepo}/issues" target="_blank" rel="noopener">${CONFIG.fullRepo}</a> will appear here automatically.
    </p>
    <a href="https://github.com/${CONFIG.fullRepo}/issues/new/choose" target="_blank" rel="noopener"
       style="display:inline-flex;align-items:center;gap:0.5rem;padding:0.65rem 1.25rem;background:var(--accent-strong);color:#fff;border-radius:var(--radius);text-decoration:none;font-weight:600;font-size:0.9rem">
      ＋ File a Toil Idea
    </a>
  `;
  container.prepend(msg);
}

function convertApiIssues(apiIssues) {
  return {
    repo: CONFIG.fullRepo,
    generated_at: new Date().toISOString(),
    issues: apiIssues.filter(i => !i.pull_request).map(issue => {
      const body = issue.body || '';
      const labels = issue.labels.map(l => l.name);
      const freq = extractField(body, 'How often does it happen?') || '⚪ Monthly or less';
      const time = extractField(body, 'How long does it take each time?') || '< 5 minutes';
      const people = extractField(body, 'Who is affected?') || 'Just me';
      const team = extractField(body, 'What team or group are you on?') || 'Unassigned team';
      const category = extractField(body, 'What area does this toil fall under?') || 'Other';
      const submitter = issue.user ? `${issue.user.login} (@${issue.user.login})` : 'Unknown contributor';
      const bonusRaw = extractField(body, 'Bonus factors (check all that apply)') || '';
      const bonus = Object.keys(BONUS_MAP).filter(b => bonusRaw.includes(b));
      const { score, monthlyMins } = calcScore(freq, time, people, bonus);
      return {
        number: issue.number,
        title: issue.title,
        url: issue.html_url,
        state: issue.state,
        labels,
        submitter,
        team,
        category,
        frequency: freq,
        time_per_occurrence: time,
        people_affected: people,
        bonus_factors: bonus,
        automation_idea: extractField(body, 'Automation idea (if any)') || '',
        toil_score: score,
        priority: getPriorityLabel(score),
        monthly_saved_minutes: monthlyMins,
        created_at: issue.created_at,
        ai_suggestion: ''
      };
    })
  };
}

function extractField(body, field) {
  const escaped = field.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const regex = new RegExp(`###?\\s*${escaped}[\\s:]*\\n+([^\\n]+)`, 'i');
  const m = body.match(regex);
  return m ? m[1].trim() : null;
}

function calcScore(freq, time, people, bonus) {
  const fObj = FREQ_SCORES[freq] || { score: 1, monthly: 1 };
  const tObj = TIME_SCORES[time] || { score: 1, mins: 3 };
  const pObj = PEOPLE_SCORES[people] || { score: 1 };
  const base = fObj.score * tObj.score * pObj.score;
  const bonusList = Array.isArray(bonus) ? bonus : [];
  const bonusTotal = bonusList.reduce((s, b) => s + (BONUS_MAP[b] || 0), 0);
  const score = base + bonusTotal;
  const monthlyMins = fObj.monthly * tObj.mins * pObj.score;
  return { score, monthlyMins };
}

function applyLocalEdits() {
  if (!dashboardData) return;
  dashboardData.issues.forEach(issue => {
    const edits = localEdits[issue.number];
    if (!edits) return;
    if (edits.frequency) issue.frequency = edits.frequency;
    if (edits.time_per_occurrence) issue.time_per_occurrence = edits.time_per_occurrence;
    if (edits.people_affected) issue.people_affected = edits.people_affected;
    // Recalculate score
    const { score, monthlyMins } = calcScore(issue.frequency, issue.time_per_occurrence, issue.people_affected, issue.bonus_factors);
    issue.toil_score = score;
    issue.monthly_saved_minutes = monthlyMins;
    issue.priority = getPriorityLabel(score);
  });
}

function saveLocalEdits() {
  localStorage.setItem('toilEdits', JSON.stringify(localEdits));
}

// ═══════════════════════════════════════════════════
// STATUS HELPERS
// ═══════════════════════════════════════════════════
function getStatus(issue) {
  // Check local overrides first
  if (localEdits[issue.number] && localEdits[issue.number].status) {
    return localEdits[issue.number].status;
  }
  const labels = issue.labels.map(l => l.toLowerCase());
  if (labels.includes('automated') || issue.state === 'closed') return 'automated';
  if (labels.includes('in-progress')) return 'in-progress';
  if (labels.includes('triage')) return 'triage';
  return 'toil';
}

function statusBadge(status, issueNum) {
  const badges = {
    'automated': '✅ Shipped',
    'in-progress': '🔨 Building',
    'triage': '🔍 Triaging',
    'toil': '💡 Ready to fix'
  };
  const edited = issueNum && localEdits[issueNum] && localEdits[issueNum].status ? '<span class="edited-marker">✎</span>' : '';
  return `<span class="badge badge-${status} status-toggle" data-issue="${issueNum || ''}" style="cursor:pointer" title="Click to update status">${badges[status] || status}${edited}</span>`;
}

function priorityClass(score) {
  return getPriorityBand(score).className;
}

function getPriorityLabel(score) {
  return getPriorityBand(score).label;
}

function formatMinutes(mins) {
  if (mins >= 60) return `${(mins / 60).toFixed(1)} hrs/mo`;
  return `${Math.round(mins)} min/mo`;
}

function formatWeeklyTime(mins) {
  if (!mins && mins !== 0) return '—';
  if (mins >= 60) return `${(mins / 60).toFixed(1)} hrs/wk`;
  return `${Math.round(mins)} min/wk`;
}

function formatCurrencyShort(value) {
  if (!isFinite(value) || value <= 0) return '$0';
  if (value >= 1_000_000) return `$${(value / 1_000_000).toFixed(1)}M`;
  if (value >= 1_000) return `$${(value / 1_000).toFixed(0)}K`;
  return `$${Math.round(value)}`;
}

// ═══════════════════════════════════════════════════
// RENDER
// ═══════════════════════════════════════════════════
function render() {
  const data = dashboardData;
  if (!data) return;

  // Apply team renames
  applyTeamRenames(data.issues);

  // Header
  document.getElementById('headerRepo').textContent = data.repo;
  document.getElementById('headerDate').textContent = new Date(data.generated_at).toLocaleDateString();
  document.getElementById('headerRepoLink').href = `https://github.com/${data.repo}`;

  const issues = data.issues;

  // Populate filter dropdowns
  populateFilters(issues);

  // Summary cards (dynamically shows relevant cards)
  renderSummaryCards(issues);

  // Hero + insight telemetry
  renderHeroPulse(issues);
  renderInsightPanels(issues);

  // Trend chart
  renderTrendChart(issues);

  // Team manager + breakdown
  renderTeamFocusCard(issues);

  // Main table
  renderToilTable(issues);
}

function populateFilters(issues) {
  const teams = [...new Set(issues.map(i => i.team).filter(Boolean))].sort();
  const categories = [...new Set(issues.map(i => i.category).filter(Boolean))].sort();
  const statuses = [...new Set(issues.map(i => getStatus(i)))].sort();

  fillSelect('filterTeam', teams);
  fillSelect('filterCategory', categories);
  fillSelect('filterStatus', statuses);
}

function fillSelect(id, options) {
  const sel = document.getElementById(id);
  const current = sel.value;
  // Keep first "All" option
  while (sel.options.length > 1) sel.remove(1);
  options.forEach(o => {
    const opt = document.createElement('option');
    opt.value = o; opt.textContent = o;
    sel.appendChild(opt);
  });
  sel.value = current;
}

// ── Summary Cards ──
function renderSummaryCards(issues) {
  const total = issues.length || 0;
  const statusCounts = issues.reduce((acc, issue) => {
    const status = getStatus(issue);
    acc[status] = (acc[status] || 0) + 1;
    return acc;
  }, {});
  const automated = statusCounts['automated'] || 0;
  const inProgress = statusCounts['in-progress'] || 0;
  const backlog = statusCounts['toil'] || 0;
  const totalMinsSaved = issues.reduce((s, i) => s + (i.monthly_saved_minutes || 0), 0);
  const hoursSaved = totalMinsSaved / 60;
  const automationRate = total ? Math.round((automated / total) * 100) : 0;
  const riskIssues = issues.filter(i => getStatus(i) !== 'automated' && isCritical(i.toil_score));
  const riskMins = riskIssues.reduce((s, i) => s + (i.monthly_saved_minutes || 0), 0);
  const riskHours = riskMins / 60;
  const avgHoursPerIdea = total ? (hoursSaved / total) : 0;
  const weeklyBurn = issues.reduce((s, i) => s + (i.team_weekly_time_spent || 0), 0) / 60;
  const fteRecovered = hoursSaved / 160;
  const targetRate = 55;
  const rateDelta = automationRate - targetRate;
  const deltaClass = rateDelta >= 0 ? 'positive' : 'negative';
  const deltaLabel = `${rateDelta >= 0 ? '+' : ''}${rateDelta.toFixed(0)} pts vs target`;
  const mitigationRate = hoursSaved + riskHours > 0 ? Math.round((hoursSaved / (hoursSaved + riskHours)) * 100) : 0;
  const riskShare = total ? Math.round((riskIssues.length / total) * 100) : 0;
  const backlogShare = total ? Math.round((backlog / total) * 100) : 0;

  // Tooltip helper
  const tip = (text) => `<span class="card-help">?<span class="card-tip">${text}</span></span>`;

  // Early stage: only show relevant cards
  const cards = [];

  cards.push(`
    <article class="card">
      <div class="label">Toil Signals ${tip('Total number of repetitive tasks your team has reported. Each GitHub Issue labeled "toil" counts as one signal.')}</div>
      <div class="value"><span class="value-number" data-animate="${total}" data-format="number">${total}</span></div>
      <p class="card-subtext">${backlog} in backlog · ${inProgress} building · ${automated} shipped</p>
      <div class="micro-progress"><span style="width:${Math.min(automationRate, 100)}%"></span></div>
    </article>`);

  cards.push(`
    <article class="card emerald">
      <div class="label">⚡ Hours Saved / Month ${tip('Estimated hours your team saves each month from automating toil. Calculated from frequency × time × people affected for each issue.')}</div>
      <div class="value"><span class="value-number" data-animate="${hoursSaved}" data-format="hours">${hoursSaved.toFixed(1)}</span><sup>hrs</sup></div>
      <p class="card-subtext">≈ ${fteRecovered.toFixed(1)} FTEs given back</p>
      <div class="micro-progress" data-color="success"><span style="width:${Math.min(mitigationRate, 100)}%"></span></div>
    </article>`);

  if (automated > 0) {
    cards.push(`
    <article class="card">
      <div class="label">Automation Velocity ${tip('Percentage of reported toil that has been fully automated. Tracks issues that move to "automated" or "closed" status.')}</div>
      <div class="value"><span class="value-number" data-animate="${automationRate}" data-format="percent">${automationRate}%</span></div>
      <div class="delta ${deltaClass}">${deltaLabel}</div>
      <p class="card-subtext">${automated} of ${total} toil signals retired</p>
    </article>`);
  } else {
    cards.push(`
    <article class="card card-teaser">
      <div class="label">Automation Velocity ${tip('Percentage of reported toil that has been fully automated. This card lights up when you close your first toil issue as automated.')}</div>
      <div class="value"><span class="value-number">0%</span></div>
      <div class="delta positive" style="opacity:0.7">🔓 Ships with your first automation</div>
      <p class="card-subtext">0 of ${total} toil signals retired</p>
      <div class="micro-progress"><span style="width:15%"></span></div>
    </article>`);
  }

  if (riskIssues.length > 0) {
    cards.push(`
    <article class="card">
      <div class="label">Critical Hotspots ${tip('Issues with a toil score of 40+. These are high-frequency, time-consuming tasks affecting many people — your biggest ROI opportunities.')}</div>
      <div class="value"><span class="value-number" data-animate="${riskIssues.length}" data-format="number">${riskIssues.length}</span></div>
      <p class="card-subtext">${riskShare}% of backlog is 🔴 critical</p>
      <div class="micro-progress" data-color="danger"><span style="width:${Math.min(riskShare, 100)}%"></span></div>
    </article>`);
  } else {
    cards.push(`
    <article class="card card-teaser">
      <div class="label">Critical Hotspots ${tip('Issues with a toil score of 40+. Score = frequency × time × people + bonuses. This card appears when high-impact toil is reported.')}</div>
      <div class="value"><span class="value-number">0</span></div>
      <p class="card-subtext">🔓 Appears when toil scores ≥ 40</p>
      <div class="micro-progress" data-color="danger"><span style="width:15%"></span></div>
    </article>`);
  }

  document.getElementById('summaryCards').innerHTML = cards.join('');
  animateSummaryNumbers();
}

function animateSummaryNumbers() {
  requestAnimationFrame(() => {
    document.querySelectorAll('#summaryCards [data-animate]').forEach(el => {
      const target = parseFloat(el.dataset.animate) || 0;
      const format = el.dataset.format || 'number';
      animateValue(el, target, format);
    });
  });
}

function animateValue(el, target, format) {
  const duration = 900;
  const start = 0;
  const startTime = performance.now();
  function frame(now) {
    const progress = Math.min((now - startTime) / duration, 1);
    const eased = easeOutCubic(progress);
    const current = start + (target - start) * eased;
    el.textContent = formatAnimatedValue(current, format);
    if (progress < 1) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

function formatAnimatedValue(value, format) {
  if (format === 'percent') return `${Math.round(value)}%`;
  if (format === 'hours') return `${value.toFixed(1)}`;
  return `${Math.round(value)}`;
}

function easeOutCubic(t) {
  return 1 - Math.pow(1 - t, 3);
}

function renderHeroPulse(issues) {
  const heroPulse = document.getElementById('heroPulse');
  if (!heroPulse) return;
  const total = issues.length || 0;
  const automated = issues.filter(i => getStatus(i) === 'automated').length;
  const inProgress = issues.filter(i => getStatus(i) === 'in-progress').length;
  const triage = issues.filter(i => getStatus(i) === 'triage').length;
  const backlog = issues.filter(i => getStatus(i) === 'toil').length;
  const automationRate = total ? Math.round((automated / total) * 100) : 0;
  const highImpact = issues.filter(i => isCritical(i.toil_score) && getStatus(i) !== 'automated').length;
  heroPulse.innerHTML = `
    <span class="pulse-pill success">⚡ ${automationRate}% automated</span>
    <span class="pulse-pill" data-filter-status="" tabindex="0" role="button" style="cursor:pointer;border-color:rgba(67,198,255,0.3);background:rgba(67,198,255,0.06);color:#67c8ff;" title="Show all">📦 ${total} signals</span>
    ${highImpact > 0 ? `<span class="pulse-pill warning">🔥 ${highImpact} critical</span>` : ''}
    ${automated > 0 ? `<span class="pulse-pill" data-filter-status="automated" tabindex="0" role="button" style="cursor:pointer;border-color:rgba(57,255,136,0.42);background:rgba(57,255,136,0.12);color:#39ff88;" title="Filter to shipped">✅ ${automated} shipped</span>` : ''}
    ${inProgress > 0 ? `<span class="pulse-pill" data-filter-status="in-progress" tabindex="0" role="button" style="cursor:pointer;border-color:rgba(212,0,255,0.42);background:rgba(212,0,255,0.12);color:#f0abfc;" title="Filter to building">🔨 ${inProgress} building</span>` : ''}
  `;
}

function renderInsightPanels(issues) {
  renderPipelineCard(issues);
  renderShippedCard(issues);
  renderTeamFocusCard(issues);
}

function renderPipelineCard(issues) {
  const card = document.getElementById('pipelineCard');
  if (!card) return;
  const total = issues.length || 0;
  const counts = { backlog: 0, triage: 0, building: 0, shipped: 0 };
  issues.forEach(issue => {
    const status = getStatus(issue);
    if (status === 'automated') counts.shipped++;
    else if (status === 'in-progress') counts.building++;
    else if (status === 'triage') counts.triage++;
    else counts.backlog++;
  });
  const automationRate = total ? Math.round((counts.shipped / total) * 100) : 0;
  card.innerHTML = `
    <div class="insight-header">
      <span class="eyebrow">Pipeline Momentum <span class="card-help">?<span class="card-tip">Shows where your toil issues are in the automation pipeline — from backlog to shipped. The gauge tracks your overall automation rate.</span></span></span>
      <span class="mini-pill live">Live</span>
    </div>
    <div class="insight-body">
      <div class="radial-progress"><strong>${automationRate}%</strong><span>Automated</span></div>
      <div class="stat-list">
        <div class="stat-row"><strong class="stat-val-green">${counts.shipped}</strong><span style="display:flex;align-items:center;gap:6px"><span class="stat-dot stat-dot-green"></span>Automated</span></div>
        <div class="stat-row"><strong class="stat-val-purple">${counts.building}</strong><span style="display:flex;align-items:center;gap:6px"><span class="stat-dot stat-dot-purple"></span>Building</span></div>
        <div class="stat-row"><strong class="stat-val-amber">${counts.triage}</strong><span style="display:flex;align-items:center;gap:6px"><span class="stat-dot stat-dot-amber"></span>Triage</span></div>
        <div class="stat-row"><strong class="stat-val-slate">${counts.backlog}</strong><span style="display:flex;align-items:center;gap:6px"><span class="stat-dot stat-dot-slate"></span>Backlog</span></div>
      </div>
    </div>
  `;
  const gauge = card.querySelector('.radial-progress');
  if (gauge) {
    gauge.style.setProperty('--progress', `${automationRate * 3.6}deg`);
  }
}

function renderShippedCard(issues) {
  const card = document.getElementById('shippedCard');
  if (!card) return;
  const total = issues.length || 0;
  const shipped = issues.filter(i => getStatus(i) === 'automated').length;
  const pct = total ? Math.round((shipped / total) * 100) : 0;
  card.innerHTML = `
    <div class="insight-header">
      <span class="eyebrow">Shipped <span class="card-help">?<span class="card-tip">Toil items fully automated and retired. Each shipped item means your team never has to do that task manually again.</span></span></span>
      <span class="mini-pill live">Live</span>
    </div>
    <div class="shipped-body">
      <span class="shipped-bolt" title="Click for celebration ⚡">⚡</span>
      <span class="shipped-number">${shipped}</span>
      <span class="shipped-label">${shipped === 1 ? 'toil eliminated' : 'toils eliminated'}</span>
      <div class="shipped-bar"><div class="shipped-bar-fill" style="width:${pct}%"></div></div>
      <span class="shipped-label" style="font-size:0.62rem;opacity:0.7">${pct}% of ${total} signals automated</span>
    </div>
  `;
  // Lightning bolt Easter egg on this card too
  const bolt = card.querySelector('.shipped-bolt');
  if (bolt) {
    bolt.addEventListener('click', function() {
      const storm = document.createElement('div');
      storm.className = 'bolt-storm';
      const flash = document.createElement('div');
      flash.className = 'bolt-flash';
      storm.appendChild(flash);
      for (let i = 0; i < 14; i++) {
        const b = document.createElement('span');
        b.className = 'storm-bolt';
        b.textContent = '⚡';
        b.style.left = (30 + Math.random() * 40) + '%';
        b.style.top = (20 + Math.random() * 40) + '%';
        b.style.fontSize = (1 + Math.random() * 2) + 'rem';
        const angle = (i / 14) * 360;
        const dist = 80 + Math.random() * 200;
        b.style.setProperty('--tx', (Math.cos(angle * Math.PI / 180) * dist) + 'px');
        b.style.setProperty('--ty', (Math.sin(angle * Math.PI / 180) * dist) + 'px');
        b.style.setProperty('--rot', (Math.random() * 720 - 360) + 'deg');
        b.style.animationDelay = (Math.random() * 0.15) + 's';
        storm.appendChild(b);
      }
      document.body.appendChild(storm);
      setTimeout(() => storm.remove(), 1800);
    });
  }
}


function renderTeamFocusCard(issues) {
  const card = document.getElementById('teamFocusCard');
  if (!card) return;
  const personMap = {};
  issues.forEach(issue => {
    const person = issue.submitter || 'Unknown contributor';
    const name = person.replace(/\s*\(@\w+\)/, '');
    if (!personMap[name]) personMap[name] = { weekly: 0, saved: 0, count: 0, automated: 0, team: issue.team || '' };
    personMap[name].weekly += (issue.weekly_time_spent || 0);
    personMap[name].saved += (issue.monthly_saved_minutes || 0);
    personMap[name].count++;
    if (getStatus(issue) === 'automated') personMap[name].automated++;
  });
  const people = Object.entries(personMap).sort((a, b) => (b[1].weekly || 0) - (a[1].weekly || 0)).slice(0, 6);
  const maxWeekly = Math.max(...people.map(([, d]) => d.weekly), 1);
  const totalWeekly = people.reduce((s, [, d]) => s + d.weekly, 0);

  const heatColor = (pct) => {
    if (pct >= 0.7) return '#ff3860';
    if (pct >= 0.4) return '#ffe74a';
    return '#39ff88';
  };

  card.innerHTML = `
    <div class="insight-header">
      <span class="eyebrow">Team Load <span class="card-help">?<span class="card-tip">Shows who carries the most toil burden. Bar length = weekly hours on toil. Color intensity: 🟢 light → 🟡 moderate → 🔴 heavy.</span></span></span>
      <span class="mini-pill">${people.length} ${people.length === 1 ? 'person' : 'people'}</span>
    </div>
    <div class="team-load-bars" style="flex:1;display:flex;flex-direction:column;justify-content:center;gap:0.45rem;">
      ${people.length === 0 ? '<p style="color:var(--text-soft);font-size:0.82rem;">Submit toil ideas to see team load.</p>' : people.map(([name, data]) => {
        const pct = data.weekly / maxWeekly;
        const barPct = Math.max(pct * 100, 4);
        const color = heatColor(pct);
        const automatedPct = data.count > 0 ? Math.round((data.automated / data.count) * 100) : 0;
        return `
        <div class="load-row" title="${name}: ${formatWeeklyTime(data.weekly)}/wk across ${data.count} toil item${data.count !== 1 ? 's' : ''} (${automatedPct}% automated)">
          <span class="load-name">${esc(name.split(' ')[0])}</span>
          <div class="load-track">
            <div class="load-fill" style="width:${barPct}%;background:${color};"></div>
          </div>
          <span class="load-val">${formatWeeklyTime(data.weekly)}</span>
        </div>`;
      }).join('')}
    </div>
    <p class="insight-note" style="margin-top:auto;">${people.length ? `Combined: ${formatWeeklyTime(totalWeekly)}/wk across ${people.length} ${people.length === 1 ? 'person' : 'people'}` : ''}</p>
  `;
}

// ── Executive Summary for Leadership ──

// ── Team Name Management ──
function getTeamRenames() {
  return JSON.parse(localStorage.getItem('toilTeamRenames') || '{}');
}
function saveTeamRenames(renames) {
  localStorage.setItem('toilTeamRenames', JSON.stringify(renames));
}
function applyTeamRenames(issues) {
  const renames = getTeamRenames();
  issues.forEach(i => {
    if (i._originalTeam === undefined) i._originalTeam = i.team;
    if (renames[i._originalTeam]) i.team = renames[i._originalTeam];
  });
}
function renderTeamManager(issues) {
  const renames = getTeamRenames();
  const originalTeams = [...new Set(issues.map(i => i._originalTeam || i.team))].sort();
  const container = document.getElementById('teamManagerList');
  if (!originalTeams.length) { container.innerHTML = '<p style="font-size:0.85rem;color:#8b949e;">No teams found yet.</p>'; return; }
  container.innerHTML = originalTeams.map(t => {
    const current = renames[t] || t;
    return `<div class="team-rename-row">
      <span class="team-current">${esc(t)}</span>
      <span class="arrow">→</span>
      <input type="text" value="${esc(current)}" data-original="${esc(t)}" placeholder="New team name" />
      <button class="btn btn-rename" onclick="renameTeam(this)">Rename</button>
    </div>`;
  }).join('');
}
function renameTeam(btn) {
  const row = btn.closest('.team-rename-row');
  const input = row.querySelector('input');
  const original = input.dataset.original;
  const newName = input.value.trim();
  if (!newName) return;
  const renames = getTeamRenames();
  if (newName === original) { delete renames[original]; }
  else { renames[original] = newName; }
  saveTeamRenames(renames);
  applyTeamRenames(dashboardData.issues);
  render();
  showToast(`🏷️ Team glow-up complete: ${original} → ${newName} ✨`);
}

// ── Trend Chart — Monthly hours reclaimed ──
function renderTrendChart(issues) {
  const container = document.getElementById('trendChart');
  if (!container) return;

  // Build monthly buckets from issue created_at dates — only months with data
  const monthMap = {};
  issues.forEach(issue => {
    const created = issue.created_at ? issue.created_at.slice(0, 7) : null;
    if (!created) return;
    if (!monthMap[created]) monthMap[created] = { total: 0, automated: 0 };
    const hrs = (issue.monthly_saved_minutes || 0) / 60;
    monthMap[created].total += hrs;
    if (getStatus(issue) === 'automated') monthMap[created].automated += hrs;
  });

  const months = Object.keys(monthMap).sort();
  const data = months.map(k => ({ month: k, total: monthMap[k].total, automated: monthMap[k].automated }));

  if (data.length === 0 || data.every(d => d.total === 0)) {
    container.innerHTML = '<p style="color:var(--text-soft);font-size:0.9rem;">Submit your first toil idea to start tracking impact.</p>';
    return;
  }

  const maxVal = Math.max(...data.map(d => d.total));
  // Round up to a clean number for the Y-axis, including sub-1hr ranges
  const yMax = maxVal <= 1
    ? Math.max(0.1, Math.ceil(maxVal * 10) / 10)
    : maxVal <= 10
      ? Math.ceil(maxVal)
      : Math.ceil(maxVal / 10) * 10;

  const barCount = data.length;
  const barW = barCount === 1 ? 22 : barCount <= 3 ? 28 : 22;
  const barGap = 14;
  const pad = { top: 14, right: 14, bottom: 30, left: 46 };
  const totalBarsWidth = barCount * barW + Math.max(0, barCount - 1) * barGap;
  const svgW = pad.left + Math.max(totalBarsWidth + 60, 160) + pad.right;
  const svgH = 122;
  const chartW = svgW - pad.left - pad.right;
  const chartH = svgH - pad.top - pad.bottom;

  // Y-axis grid lines — use clean intervals
  const gridCount = yMax < 1 ? 2 : Math.min(4, yMax);
  let gridLines = '';
  for (let i = 0; i <= gridCount; i++) {
    const y = pad.top + chartH - (chartH * i / gridCount);
    const val = yMax * i / gridCount;
    const labelVal = yMax < 1 ? val.toFixed(1) : Math.round(val);
    const labelNum = Number(labelVal);
    gridLines += `<line x1="${pad.left}" y1="${y}" x2="${svgW - pad.right}" y2="${y}" class="trend-grid"/>`;
    gridLines += `<text x="${pad.left - 8}" y="${y + 3}" text-anchor="end" class="trend-label">${labelVal} ${labelNum === 1 ? 'hr' : 'hrs'}</text>`;
  }

  // Bars — centered in available space
  const startX = pad.left + (chartW - totalBarsWidth) / 2;
  let bars = '';
  data.forEach((d, i) => {
    const x = startX + i * (barW + barGap);
    const totalH = Math.max(d.total > 0 ? 2 : 0, (d.total / yMax) * chartH);
    const autoH = Math.max(d.automated > 0 ? 2 : 0, (d.automated / yMax) * chartH);
    const totalY = pad.top + chartH - totalH;
    const autoY = pad.top + chartH - autoH;
    bars += `<rect class="trend-bar" x="${x}" y="${totalY}" width="${barW}" height="${totalH}" rx="4" fill="#8be9fd" opacity="0.72"><title>${d.month}: ${d.total.toFixed(1)} hrs potential</title></rect>`;
    bars += `<rect class="trend-bar" x="${x}" y="${autoY}" width="${barW}" height="${autoH}" rx="4" fill="#d400ff"><title>${d.month}: ${d.automated.toFixed(1)} hrs automated</title></rect>`;
    if (d.total > 0) {
      const hrsLabel = d.total < 1 ? d.total.toFixed(1) : d.total.toFixed(0);
      bars += `<text x="${x + barW / 2}" y="${totalY - 3}" text-anchor="middle" class="trend-value">${hrsLabel}h</text>`;
    }
    const label = new Date(d.month + '-15').toLocaleDateString('en-US', { month: 'short' });
    bars += `<text x="${x + barW / 2}" y="${svgH - 5}" text-anchor="middle" class="trend-label">${label}</text>`;
  });

  const axisLine = `<line x1="${pad.left}" y1="${pad.top + chartH}" x2="${svgW - pad.right}" y2="${pad.top + chartH}" class="trend-axis"/>`;
  const legend = `
    <g transform="translate(${pad.left}, ${svgH - 1})">
      <rect width="8" height="8" rx="2" fill="#8be9fd" opacity="0.72"/>
      <text x="12" y="7" class="trend-label">Potential</text>
      <rect x="64" width="8" height="8" rx="2" fill="#d400ff"/>
      <text x="76" y="7" class="trend-label">Automated</text>
    </g>`;

  container.innerHTML = `<div class="trend-chart-wrap"><svg width="${svgW}" height="${svgH + 10}" viewBox="0 0 ${svgW} ${svgH + 10}" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Monthly hours saved trend">${gridLines}${axisLine}${bars}${legend}</svg></div>`;
}

// ── Team & Individual Breakdown ──
// ── Main Toil Table ──
function renderToilTable(issues) {
  const teamF = document.getElementById('filterTeam').value;
  const catF = document.getElementById('filterCategory').value;
  const statF = document.getElementById('filterStatus').value;
  const searchQ = (document.getElementById('searchToil').value || '').toLowerCase().trim();

  let filtered = issues.slice();
  if (teamF) filtered = filtered.filter(i => i.team === teamF);
  if (catF) filtered = filtered.filter(i => i.category === catF);
  if (statF) filtered = filtered.filter(i => getStatus(i) === statF);
  if (searchQ) filtered = filtered.filter(i =>
    (i.title || '').toLowerCase().includes(searchQ) ||
    (i.submitter || '').toLowerCase().includes(searchQ) ||
    (i.team || '').toLowerCase().includes(searchQ) ||
    (i.category || '').toLowerCase().includes(searchQ) ||
    (i.automation_idea || '').toLowerCase().includes(searchQ)
  );

  // Sort
  filtered.sort((a, b) => {
    let va = a[sortCol], vb = b[sortCol];
    if (typeof va === 'number' && typeof vb === 'number') return (va - vb) * sortDir;
    va = String(va || '').toLowerCase(); vb = String(vb || '').toLowerCase();
    return va < vb ? -sortDir : va > vb ? sortDir : 0;
  });

  // Sort arrows
  document.querySelectorAll('#toilTable th').forEach(th => {
    const col = th.dataset.col;
    const arrow = col === sortCol ? (sortDir === 1 ? ' ▲' : ' ▼') : '';
    const existing = th.querySelector('.sort-arrow');
    if (existing) existing.textContent = arrow;
    else if (col) {
      const sp = document.createElement('span');
      sp.className = 'sort-arrow';
      sp.textContent = arrow;
      th.appendChild(sp);
    }
  });

  const tbody = document.querySelector('#toilTable tbody');
  tbody.innerHTML = filtered.map(issue => {
    const status = getStatus(issue);
    const edited = localEdits[issue.number] ? '<span class="edited-marker">✎</span>' : '';
    const bonusStr = (issue.bonus_factors || []).join(' ');
    const rawTitle = (issue.title || '').replace(/^\[TOIL\]\s*/i, '');
    const freq = issue.frequency || 'unknown frequency';
    const time = issue.time_per_occurrence || 'unknown duration';
    const idea = issue.automation_idea || '';
    const issueUrl = issue.url || `https://github.com/${CONFIG.fullRepo}/issues/${issue.number}`;
    const repoUrl = `https://github.com/${CONFIG.fullRepo}`;
    const contextUrls = [issueUrl, repoUrl].filter(u => u && u.startsWith('https://'));
    const agentPrompt = [
      `You are an automation agent. A team identified this toil: "${rawTitle}".`,
      `IMPORTANT — Start by reading these URLs for context:`,
      ...contextUrls.map((u, i) => `  ${i + 1}. ${u}`),
      CONFIG.fullRepo ? `Repository: ${CONFIG.fullRepo} (${repoUrl}).` : '',
      issue.number ? `Issue: #${issue.number} — ${issueUrl}.` : '',
      issue.submitter ? `Submitter: ${issue.submitter}.` : '',
      issue.team ? `Team: ${issue.team}.` : '',
      issue.category ? `Category: ${issue.category}.` : '',
      `It happens ${freq}, takes ${time} each time, and affects ${issue.people_affected || 'the team'}.`,
      issue.toil_score ? `Toil score: ${issue.toil_score}. Priority: ${issue.priority || 'unknown'}. Potential savings: ${issue.monthly_saved_minutes || 0} min/month.` : '',
      idea ? `Suggested approach: ${idea}.` : '',
      `Step 1: Read the URLs above for full context, then analyze this repo to identify the best automation strategy.`,
      `Step 2: Propose a concrete implementation plan with file paths.`,
      `Step 3: Scaffold the solution (GitHub Actions workflow, script, or code).`,
      `Step 4: Ask the user if they want to refine, test, or commit the changes.`,
      `Start by exploring the repo structure, then present your plan.`
    ].filter(Boolean).join(' ');
    const ghCmd = `gh copilot "${agentPrompt.replace(/"/g, '\\"')}"`;
    
    // Split "Name — Description" into two parts
    const dashIdx = rawTitle.indexOf(' — ');
    const toilName = dashIdx > -1 ? rawTitle.substring(0, dashIdx) : rawTitle.split(/\s+/).slice(0, 4).join(' ');
    const toilDesc = dashIdx > -1 ? rawTitle.substring(dashIdx + 3) : (dashIdx === -1 && rawTitle.length > toilName.length ? rawTitle : '');

    const safeUrl = issue.url && issue.url.startsWith('https://github.com/') ? issue.url : '#';
    const actionBtn = `<button class="btn btn-launch" onclick="copyLaunchCmd(this, ${issue.number})" data-cmd="${esc(ghCmd, true)}" title="Copies a ready-to-use prompt to your clipboard. Paste it into GitHub Copilot CLI, Copilot Chat, or any AI assistant to start automating this toil.">⚡ Generate Copilot CLI Prompt</button>`;

    return `<tr class="${priorityClass(issue.toil_score)}">
      <td><a href="${safeUrl}" target="_blank" rel="noopener noreferrer" class="issue-link">#${issue.number}</a></td>
      <td class="toil-cell"><div class="toil-name">${esc(toilName)}</div>${toilDesc ? `<div class="toil-desc">${esc(toilDesc)}</div>` : ''}</td>
      <td class="toil-action-cell"><div class="toil-action-inner">${actionBtn}</div></td>
      <td>${esc(issue.submitter)}</td>
      <td class="col-hidden">${esc(issue.category)}</td>
      <td class="editable" data-issue="${issue.number}" data-field="frequency">${esc(issue.frequency)}${edited}</td>
      <td class="editable" data-issue="${issue.number}" data-field="time_per_occurrence">${esc(issue.time_per_occurrence)}</td>
      <td class="editable" data-issue="${issue.number}" data-field="people_affected">${esc(issue.people_affected)}</td>
      <td class="toil-score-cell">${issue.toil_score}</td>
      <td class="toil-status-cell">${statusBadge(status, issue.number)}</td>
      <td>${formatMinutes(issue.monthly_saved_minutes)}</td>
    </tr>`;
  }).join('');
}

// ═══════════════════════════════════════════════════
// INLINE EDITING
// ═══════════════════════════════════════════════════
document.addEventListener('click', function(e) {
  const td = e.target.closest('td.editable');
  if (!td || td.querySelector('select')) return;

  const field = td.dataset.field;
  const issueNum = Number(td.dataset.issue);
  const issue = dashboardData.issues.find(i => i.number === issueNum);
  if (!issue) return;

  let options;
  if (field === 'frequency') options = Object.keys(FREQ_SCORES);
  else if (field === 'time_per_occurrence') options = Object.keys(TIME_SCORES);
  else if (field === 'people_affected') options = Object.keys(PEOPLE_SCORES);
  else return;

  const current = issue[field];
  const sel = document.createElement('select');
  options.forEach(o => {
    const opt = document.createElement('option');
    opt.value = o; opt.textContent = o;
    if (o === current) opt.selected = true;
    sel.appendChild(opt);
  });

  td.textContent = '';
  td.appendChild(sel);
  sel.focus();

  function commit() {
    const newVal = sel.value;
    if (newVal !== current) {
      if (!localEdits[issueNum]) localEdits[issueNum] = {};
      localEdits[issueNum][field] = newVal;
      issue[field] = newVal;
      const { score, monthlyMins } = calcScore(issue.frequency, issue.time_per_occurrence, issue.people_affected, issue.bonus_factors);
      issue.toil_score = score;
      issue.monthly_saved_minutes = monthlyMins;
      issue.priority = getPriorityLabel(score);
      saveLocalEdits();
    }
    render();
  }

  sel.addEventListener('change', commit);
  sel.addEventListener('blur', commit);
});

// ═══════════════════════════════════════════════════
// STATUS TOGGLE — click badge to cycle status
// ═══════════════════════════════════════════════════
const STATUS_CYCLE = ['toil', 'triage', 'in-progress', 'automated'];
document.addEventListener('click', function(e) {
  const badge = e.target.closest('.status-toggle');
  if (!badge) return;
  const issueNum = Number(badge.dataset.issue);
  if (!issueNum) return;
  const issue = dashboardData.issues.find(i => i.number === issueNum);
  if (!issue) return;
  const current = getStatus(issue);
  const idx = STATUS_CYCLE.indexOf(current);
  const next = STATUS_CYCLE[(idx + 1) % STATUS_CYCLE.length];
  if (!localEdits[issueNum]) localEdits[issueNum] = {};
  localEdits[issueNum].status = next;
  saveLocalEdits();
  const labels = { 'automated': '✅ Shipped', 'in-progress': '🔨 Building', 'triage': '🔍 Triaging', 'toil': '💡 Ready to fix' };
  showToast(`Status updated → ${labels[next]}`);
  render();
});

// ═══════════════════════════════════════════════════
// HEADER PILL FILTERS — click to filter table by status
// ═══════════════════════════════════════════════════
document.getElementById('heroPulse').addEventListener('click', function(e) {
  const pill = e.target.closest('[data-filter-status]');
  if (!pill) return;
  const status = pill.dataset.filterStatus;
  const sel = document.getElementById('filterStatus');
  sel.value = status;
  render();
  document.getElementById('toilTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
  showToast(status ? `Filtered to: ${status}` : 'Showing all statuses');
});
// Keyboard support for pulse pill filters (Enter/Space)
document.getElementById('heroPulse').addEventListener('keydown', function(e) {
  if (e.key !== 'Enter' && e.key !== ' ') return;
  const pill = e.target.closest('[data-filter-status]');
  if (!pill) return;
  e.preventDefault();
  pill.click();
});

// ═══════════════════════════════════════════════════
// SORT
// ═══════════════════════════════════════════════════
document.querySelector('#toilTable thead').addEventListener('click', function(e) {
  const th = e.target.closest('th');
  if (!th || !th.dataset.col || th.dataset.col === 'actions') return;
  const col = th.dataset.col;
  if (col === sortCol) sortDir *= -1;
  else { sortCol = col; sortDir = -1; }
  render();
});
// Keyboard support for sortable headers (Enter/Space)
document.querySelector('#toilTable thead').addEventListener('keydown', function(e) {
  if (e.key !== 'Enter' && e.key !== ' ') return;
  const th = e.target.closest('th');
  if (!th || !th.dataset.col || th.dataset.col === 'actions') return;
  e.preventDefault();
  th.click();
});

// ═══════════════════════════════════════════════════
// FILTERS
// ═══════════════════════════════════════════════════
['filterTeam', 'filterCategory', 'filterStatus'].forEach(id => {
  document.getElementById(id).addEventListener('change', () => render());
});
document.getElementById('searchToil').addEventListener('input', () => render());
document.getElementById('filterSort').addEventListener('change', function() {
  sortCol = this.value;
  sortDir = this.value === 'submitter' ? 1 : -1;
  render();
});

// ═══════════════════════════════════════════════════
// COPILOT CLI LAUNCH TRACKING
// ═══════════════════════════════════════════════════
function getCopilotLaunches() {
  return JSON.parse(localStorage.getItem('toilCopilotLaunches') || '{"total":0,"issues":{},"recent":[]}');
}
function trackCopilotLaunch(issueNum) {
  const data = getCopilotLaunches();
  data.total = (data.total || 0) + 1;
  if (!data.issues) data.issues = {};
  data.issues[issueNum] = (data.issues[issueNum] || 0) + 1;
  if (!data.recent) data.recent = [];
  data.recent.unshift({ issue: issueNum, time: Date.now() });
  data.recent = data.recent.slice(0, 20);
  localStorage.setItem('toilCopilotLaunches', JSON.stringify(data));
}
function timeAgo(ts) {
  const secs = Math.floor((Date.now() - ts) / 1000);
  if (secs < 60) return 'just now';
  if (secs < 3600) return `${Math.floor(secs / 60)}m ago`;
  if (secs < 86400) return `${Math.floor(secs / 3600)}h ago`;
  return `${Math.floor(secs / 86400)}d ago`;
}

// ═══════════════════════════════════════════════════
// CLIPBOARD & TOAST
// ═══════════════════════════════════════════════════
function copyLaunchCmd(btn, issueNum) {
  const cmd = btn.getAttribute('data-cmd');
  // Track the launch
  trackCopilotLaunch(issueNum);
  navigator.clipboard.writeText(cmd).then(() => {
    showToast('🚀 Command copied — paste in your terminal to start automating!');
    render();
  }).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = cmd; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('🚀 Command copied — paste in your terminal to start automating!');
    render();
  });
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// ═══════════════════════════════════════════════════
// UTILS
// ═══════════════════════════════════════════════════
/**
 * Escapes HTML special characters to prevent XSS
 * @param {string} str - String to escape
 * @param {boolean} attr - If true, also escapes quotes for use in HTML attributes
 * @returns {string} Escaped string
 */
function escapeHtml(str, attr) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = str;
  return attr ? d.innerHTML.replace(/"/g, '&quot;') : d.innerHTML;
}
// Compatibility alias (to be removed in future refactor)
const esc = escapeHtml;

// ═══════════════════════════════════════════════════
// COLUMN TOGGLE
// ═══════════════════════════════════════════════════
let showAllCols = false;
function toggleColumns() {
  showAllCols = !showAllCols;
  document.querySelectorAll('.col-hidden').forEach(el => el.style.display = showAllCols ? '' : 'none');
  document.getElementById('toggleCols').textContent = showAllCols ? '− Fewer columns' : '+ Show all columns';
}

// ═══════════════════════════════════════════════════
// EXPORT — CSV & JSON downloads
// ═══════════════════════════════════════════════════
function getVisibleData() {
  const rows = document.querySelectorAll('#toilTable tbody tr:not(.total-row)');
  return Array.from(rows).map(tr => {
    const cells = tr.querySelectorAll('td');
    return {
      number: cells[0]?.textContent?.trim() || '',
      title: cells[1]?.textContent?.trim() || '',
      submitter: cells[3]?.textContent?.trim() || '',
      frequency: cells[5]?.textContent?.trim() || '',
      time: cells[6]?.textContent?.trim() || '',
      people: cells[7]?.textContent?.trim() || '',
      score: cells[8]?.textContent?.trim() || '',
      status: cells[9]?.textContent?.trim() || '',
      saved_per_month: cells[10]?.textContent?.trim() || '',
    };
  });
}
function downloadFile(content, filename, mime) {
  const blob = new Blob([content], { type: mime });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}
function exportCSV() {
  const data = getVisibleData();
  if (!data.length) return;
  const headers = Object.keys(data[0]);
  const csv = [headers.join(','), ...data.map(r => headers.map(h => `"${(r[h]||'').replace(/"/g,'""')}"`).join(','))].join('\n');
  downloadFile(csv, 'toil-tracker-export.csv', 'text/csv');
  showToast('📥 CSV downloaded');
}
function exportJSON() {
  const data = getVisibleData();
  if (!data.length) return;
  downloadFile(JSON.stringify(data, null, 2), 'toil-tracker-export.json', 'application/json');
  showToast('📥 JSON downloaded');
}

// ═══════════════════════════════════════════════════
// EASTER EGGS 🥚
// ═══════════════════════════════════════════════════

// 1. Konami Code → Confetti celebration
(function() {
  const code = [38,38,40,40,37,39,37,39,66,65];
  let pos = 0;
  document.addEventListener('keydown', e => {
    if (e.keyCode === code[pos]) {
      pos++;
      if (pos === code.length) {
        pos = 0;
        launchConfetti();
        showToast('🏆 Achievement Unlocked: Toil Destroyer!');
      }
    } else { pos = 0; }
  });

  function launchConfetti() {
    const canvas = document.createElement('canvas');
    canvas.style.cssText = 'position:fixed;inset:0;z-index:99999;pointer-events:none;';
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    document.body.appendChild(canvas);
    const ctx = canvas.getContext('2d');
    const colors = ['#a855f7','#22d3ee','#4ade80','#fbbf24','#f472b6','#818cf8','#fb923c'];
    const pieces = Array.from({length: 150}, () => ({
      x: Math.random() * canvas.width,
      y: -20 - Math.random() * 200,
      w: 4 + Math.random() * 6,
      h: 8 + Math.random() * 8,
      color: colors[Math.floor(Math.random() * colors.length)],
      vx: (Math.random() - 0.5) * 4,
      vy: 2 + Math.random() * 4,
      rot: Math.random() * 360,
      rv: (Math.random() - 0.5) * 12,
      opacity: 1
    }));
    let frame = 0;
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      let alive = false;
      pieces.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.08;
        p.rot += p.rv;
        if (frame > 60) p.opacity -= 0.008;
        if (p.opacity <= 0) return;
        alive = true;
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot * Math.PI / 180);
        ctx.globalAlpha = Math.max(0, p.opacity);
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
        ctx.restore();
      });
      frame++;
      if (alive && frame < 300) requestAnimationFrame(draw);
      else canvas.remove();
    }
    requestAnimationFrame(draw);
  }
})();

// 2. Click the 0% gauge → rainbow fill + "Soon™"
document.addEventListener('click', function(e) {
  const gauge = e.target.closest('.radial-progress');
  if (!gauge) return;
  const strong = gauge.querySelector('strong');
  if (!strong || strong.textContent.trim() !== '0%') return;
  gauge.style.transition = 'none';
  gauge.style.background = 'conic-gradient(#f472b6 0deg, #a855f7 60deg, #818cf8 120deg, #22d3ee 180deg, #4ade80 240deg, #fbbf24 300deg, #f472b6 360deg)';
  gauge.style.boxShadow = '0 0 30px rgba(168,85,247,0.4), 0 0 60px rgba(34,211,238,0.2)';
  strong.textContent = '✨';
  const span = gauge.querySelector('span');
  if (span) span.textContent = 'SOON™';
  showToast('🌈 Your future is looking automated!');
  setTimeout(() => {
    gauge.style.transition = 'all 0.6s ease';
    gauge.style.background = '';
    gauge.style.boxShadow = '';
    strong.textContent = '0%';
    if (span) span.textContent = 'AUTOMATED';
  }, 2500);
});

// 3. Card hover glow tracking (mouse position for radial gradient)
document.addEventListener('mousemove', function(e) {
  document.querySelectorAll('.card, .insight-card').forEach(card => {
    const rect = card.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width * 100).toFixed(0);
    const y = ((e.clientY - rect.top) / rect.height * 100).toFixed(0);
    card.style.setProperty('--mouse-x', x + '%');
    card.style.setProperty('--mouse-y', y + '%');
  });
});

// ═══════════════════════════════════════════════════
// EDITABLE TEAM NAME (persisted to localStorage)
// ═══════════════════════════════════════════════════
(function() {
  const el = document.getElementById('teamName');
  const key = 'toilDashTeamName';
  const saved = localStorage.getItem(key);
  if (saved) el.textContent = saved + ' ✎';

  el.addEventListener('click', function() {
    const current = el.textContent.replace(/\s*✎$/, '');
    const name = prompt('Enter your team name:', current);
    if (name !== null && name.trim()) {
      el.textContent = name.trim() + ' ✎';
      localStorage.setItem(key, name.trim());
    }
  });
})();

// ── Lightning Bolt Easter Egg ──
(function() {
  const bolt = document.querySelector('.hero-bolt');
  if (!bolt) return;
  bolt.addEventListener('click', function(e) {
    e.preventDefault();
    const storm = document.createElement('div');
    storm.className = 'bolt-storm';
    const flash = document.createElement('div');
    flash.className = 'bolt-flash';
    storm.appendChild(flash);
    const count = 18;
    for (let i = 0; i < count; i++) {
      const b = document.createElement('span');
      b.className = 'storm-bolt';
      b.textContent = '⚡';
      b.style.left = (30 + Math.random() * 40) + '%';
      b.style.top = (20 + Math.random() * 40) + '%';
      b.style.fontSize = (1 + Math.random() * 2) + 'rem';
      const angle = (i / count) * 360;
      const dist = 80 + Math.random() * 200;
      b.style.setProperty('--tx', (Math.cos(angle * Math.PI / 180) * dist) + 'px');
      b.style.setProperty('--ty', (Math.sin(angle * Math.PI / 180) * dist) + 'px');
      b.style.setProperty('--rot', (Math.random() * 720 - 360) + 'deg');
      b.style.animationDelay = (Math.random() * 0.15) + 's';
      storm.appendChild(b);
    }
    document.body.appendChild(storm);
    setTimeout(() => storm.remove(), 1800);
  });
})();

// ═══════════════════════════════════════════════════
// INIT
loadData();
</script>
</body>
</html>
