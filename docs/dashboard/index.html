<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; script-src 'self' 'unsafe-inline'; connect-src 'self' https://api.github.com; img-src 'self' data:;">
<title>AI Toil Tracker ‚Äî Reduce Toil, Gain Leverage</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-surface: #f9fafb;
  --bg-card: #ffffff;
  --bg-glass: rgba(17,17,28,0.78);
  --border-card: #dfe3ec;
  --accent: #a56bff;
  --accent-strong: #7c3bff;
  --accent-soft: #dec0ff;
  --success: #3dd68c;
  --warning: #f6c05c;
  --danger: #ff667a;
  --text-soft: #5e6474;
  --text-primary: #0e1018;
  --radius: 0.75rem;
  --ring: 0 0 0 1px rgba(0,0,0,0.05);
  --shadow-sm: 0 1px 3px 0 rgba(0,0,0,0.06);
  --shadow-md: 0 8px 20px -4px rgba(0,0,0,0.08), 0 4px 8px -4px rgba(0,0,0,0.04);
}
.dark, :root:not(.light) {
  --bg-surface: #050407;
  --bg-card: #111117;
  --bg-glass: rgba(17,17,28,0.85);
  --border-card: #23242f;
  --text-soft: #9ea4b8;
  --text-primary: #f5f7ff;
  --ring: 0 0 0 1px rgba(255,255,255,0.06);
  --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.3);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.4), 0 2px 4px -2px rgba(0,0,0,0.3);
}

/* ‚îÄ‚îÄ Reset & Base ‚îÄ‚îÄ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
}
body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg-surface); color: var(--text-primary); line-height: 1.5; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; text-rendering: optimizeLegibility; min-height: 100vh; position: relative; }
body::before { content: ""; position: fixed; inset: 0; background-image: radial-gradient(circle at 25% 25%, rgba(165,107,255,0.05), transparent 45%), radial-gradient(circle at 75% 0%, rgba(67,198,255,0.04), transparent 50%); opacity: 1; pointer-events: none; z-index: -1; }
button:focus-visible, select:focus-visible, input:focus-visible, a:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; border-radius: calc(var(--radius) - 0.25rem); }

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.header { position: sticky; top: 0; z-index: 1000; background: linear-gradient(135deg, #0b0d1d 0%, #1c0f2d 100%); color: #f5f7ff; padding: 1.75rem 2.25rem; display: flex; align-items: flex-start; justify-content: space-between; flex-wrap: wrap; gap: 1.25rem; border-bottom: 1px solid #23242f; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); overflow: hidden; isolation: isolate; }
.header::before { content: ""; position: absolute; inset: 0; pointer-events: none; background: radial-gradient(720px 320px at 12% 5%, rgba(165,107,255,0.18), transparent 60%), radial-gradient(640px 260px at 88% -15%, rgba(67,198,255,0.14), transparent 70%); opacity: 0.85; }
.header > * { position: relative; }
.hero-left { display: flex; flex-direction: column; gap: 0.55rem; max-width: 640px; }
.hero-eyebrow { font-size: 0.8rem; letter-spacing: 0.05em; text-transform: none; color: rgba(255,255,255,0.65); font-weight: 600; }
.header h1 { font-size: clamp(1.6rem, 2.3vw, 2.2rem); font-weight: 750; letter-spacing: -0.02em; display: flex; align-items: center; gap: 0.75rem; color: #fff; position: relative; overflow: hidden; }
.header h1::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); background-size: 200% 100%; background-repeat: no-repeat; animation: heroShimmer 3s ease-out 1 forwards; pointer-events: none; mix-blend-mode: overlay; }
.hero-subtitle { font-size: 0.95rem; color: rgba(255,255,255,0.78); max-width: 520px; line-height: 1.6; }
.hero-pulse { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.35rem; }
.pulse-pill { display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.78rem; padding: 0.35rem 0.75rem; border-radius: 999px; border: 1px solid rgba(255,255,255,0.18); background: rgba(255,255,255,0.08); text-transform: uppercase; letter-spacing: 0.08em; color: rgba(255,255,255,0.8); }
.pulse-pill.success { border-color: rgba(34,197,94,0.45); background: rgba(34,197,94,0.15); color: #bbf7d0; }
.pulse-pill.warning { border-color: rgba(245,158,11,0.45); background: rgba(245,158,11,0.15); color: #fcd34d; }
.pulse-pill.neutral { border-color: rgba(255,255,255,0.25); }
.pulse-pill[data-filter-status] { transition: all 150ms ease; }
.pulse-pill[data-filter-status]:hover { transform: scale(1.05); filter: brightness(1.2); }
.header .meta { font-size: 0.85rem; font-weight: 500; color: rgba(255,255,255,0.78); display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; justify-content: flex-end; text-align: right; }
.header .meta a { color: rgba(255,255,255,0.90); text-decoration: none; border-bottom: 1px solid rgba(255,255,255,0.22); }
.header .meta a:hover { border-bottom-color: rgba(255,255,255,0.55); }

/* ‚îÄ‚îÄ Container ‚îÄ‚îÄ */
.container { max-width: 1440px; margin: 0 auto; padding: 1.5rem; }

/* ‚îÄ‚îÄ Summary Cards ‚îÄ‚îÄ */
.cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem; }
.card { background: var(--bg-card); border: 1px solid var(--border-card); border-radius: var(--radius); padding: 1.5rem; transition: all 150ms ease; box-shadow: var(--shadow-sm); text-align: left; position: relative; overflow: hidden; animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) backwards; }
.card:nth-child(1) { animation-delay: 0.1s; }
.card:nth-child(2) { animation-delay: 0.2s; }
.card:nth-child(3) { animation-delay: 0.3s; }
.card:nth-child(4) { animation-delay: 0.4s; }
.card::after { content: ""; position: absolute; inset: 0; border-radius: inherit; border: 1px solid transparent; opacity: 0; pointer-events: none; }
.card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: #d4d4d8; }
.card:hover::after { opacity: 0; }
.card .label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-soft); margin-bottom: 0.35rem; font-weight: 600; }
.card .value { font-size: 2.5rem; font-weight: 700; color: var(--text-primary); letter-spacing: -0.03em; line-height: 1.1; font-variant-numeric: tabular-nums; margin-bottom: 0.4rem; display: flex; align-items: baseline; gap: 0.3rem; }
.card .value-number { display: inline-block; min-width: 0; }
.card .value sup { font-size: 1.1rem; margin-left: 0.15rem; color: var(--text-soft); font-weight: 600; }
.card .delta { font-size: 0.82rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.25rem 0.6rem; border-radius: 999px; }
.delta.positive { background: rgba(34,197,94,0.1); color: #15803d; }
.delta.negative { background: rgba(248,113,113,0.15); color: #b91c1c; }
.card .card-subtext { font-size: 0.875rem; color: var(--text-soft); margin-bottom: 0.85rem; }
.micro-progress { width: 100%; height: 6px; border-radius: 999px; background: rgba(15,23,42,0.08); overflow: hidden; position: relative; }
.micro-progress span { position: absolute; inset: 0; border-radius: 999px; background: linear-gradient(90deg, var(--accent), #43c6ff); transform-origin: left; transition: transform 0.4s ease-out; }
.micro-progress[data-color="warning"] span { background: linear-gradient(90deg, #f97316, #facc15); }
.micro-progress[data-color="danger"] span { background: linear-gradient(90deg, #f87171, #f43f5e); }
.card.emerald { background: linear-gradient(135deg, #f0fdf4, #f0f9ff); }
.dark .card { background: #111117; border: 1px solid #27272a; box-shadow: var(--shadow-sm); }
.dark .card:hover { border-color: #3b3c49; }
.dark .card .value { color: #f5f7ff; }
.dark .card .card-subtext { color: #9ea4b8; }

/* ‚îÄ‚îÄ Insight Panels ‚îÄ‚îÄ */
.insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem; align-items: stretch; }
.insight-card { background: var(--bg-card); border: 1px solid var(--border-card); border-radius: var(--radius); padding: 1.5rem; box-shadow: var(--shadow-sm); position: relative; overflow: hidden; transition: all 150ms ease; animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) backwards; display: flex; flex-direction: column; }
.insight-card:nth-child(1) { animation-delay: 0.1s; }
.insight-card:nth-child(2) { animation-delay: 0.2s; }
.insight-card:nth-child(3) { animation-delay: 0.3s; }
.insight-card:nth-child(4) { animation-delay: 0.4s; }
.insight-card::after { content: ""; position: absolute; inset: 0; border-radius: inherit; background: radial-gradient(circle at top right, rgba(165,107,255,0.06), transparent 60%); opacity: 0; transition: opacity 150ms ease; }
.insight-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: #d4d4d8; }
.insight-card:hover::after { opacity: 1; }
.insight-header { display: flex; align-items: center; justify-content: space-between; gap: 1rem; margin-bottom: 1rem; }
.insight-header .eyebrow { font-size: 0.75rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--text-soft); font-weight: 600; }
.mini-pill { font-size: 0.72rem; padding: 0.2rem 0.6rem; border-radius: 999px; border: 1px solid var(--border-card); text-transform: uppercase; letter-spacing: 0.1em; }
.mini-pill.live { border-color: rgba(34,197,94,0.4); color: #15803d; background: rgba(34,197,94,0.08); animation: pulseGlow 3s ease-in-out infinite; }
.mini-link { font-size: 0.8rem; border: none; background: none; color: #2563eb; font-weight: 600; cursor: pointer; padding: 0; }
.mini-link:hover { text-decoration: underline; }
.insight-body { display: flex; gap: 1.25rem; flex-wrap: wrap; align-items: center; flex: 1; }
.radial-progress { --size: 120px; --progress: 0deg; width: var(--size); height: var(--size); border-radius: 50%; background: conic-gradient(var(--accent) var(--progress), rgba(15,23,42,0.08) 0); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0; position: relative; }
.radial-progress::after { content: ""; position: absolute; inset: 10px; background: var(--bg-card); border-radius: 50%; box-shadow: inset 0 0 15px rgba(15,23,42,0.12); }
.radial-progress strong { position: relative; z-index: 1; font-size: 1.5rem; font-weight: 700; color: var(--text-primary); line-height: 1.2; }
.radial-progress span { position: relative; z-index: 1; font-size: 0.55rem; color: var(--text-soft); text-transform: uppercase; letter-spacing: 0.12em; line-height: 1; }
.stat-list { flex: 1; display: flex; flex-direction: column; gap: 0.65rem; }
.stat-row { display: flex; align-items: center; justify-content: space-between; font-size: 0.875rem; color: var(--text-soft); }
.stat-row strong { font-size: 1.25rem; color: var(--text-primary); font-variant-numeric: tabular-nums; }
.risk-list { display: flex; flex-direction: column; gap: 0.85rem; }
.risk-row { display: flex; justify-content: space-between; gap: 1rem; }
.risk-row p { font-weight: 600; color: var(--text-primary); }
.risk-row small { display: block; color: var(--text-soft); margin-top: 0.2rem; }
.risk-value { font-weight: 700; color: #b91c1c; }
.team-pills { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
.team-pill { padding: 0.5rem 0.75rem; border-radius: var(--radius); border: 1px solid var(--border-card); background: var(--bg-surface); font-size: 0.8rem; display: flex; flex-direction: column; gap: 0.1rem; }
.team-pill strong { font-size: 1.1rem; color: var(--text-primary); }
.insight-note { font-size: 0.82rem; color: var(--text-soft); }
.dark .insight-card { background: #111117; border-color: #23242f; box-shadow: var(--shadow-sm); }
.dark .insight-card:hover { border-color: #3b3c49; }
.dark .insight-card::after { background: radial-gradient(circle at top right, rgba(165,107,255,0.15), transparent 65%); }
.dark .radial-progress::after { background: #050407; box-shadow: inset 0 0 15px rgba(0,0,0,0.45); }
.dark .radial-progress strong { color: #f5f7ff; }
.dark .stat-row strong, .dark .risk-row p, .dark .team-pill strong { color: #f5f7ff; }
.dark .team-pill { border-color: #23242f; background: #050407; color: #9ea4b8; }

/* ‚îÄ‚îÄ Section ‚îÄ‚îÄ */
.section { background: var(--bg-card); border: 1px solid var(--border-card); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: var(--shadow-sm); }
.section h2 { font-size: 1.15rem; font-weight: 600; margin-bottom: 1.25rem; letter-spacing: -0.02em; color: var(--text-primary); display: flex; align-items: center; gap: 0.75rem; }
.dark .section { background: #111117; border: 1px solid #27272a; box-shadow: var(--shadow-sm); }
.dark .section h2 { color: #f5f7ff; }

/* ‚îÄ‚îÄ Filters ‚îÄ‚îÄ */
.filters { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; align-items: center; }
.filters label { font-size: 0.75rem; font-weight: 500; color: var(--text-soft); text-transform: uppercase; letter-spacing: 0.05em; }
.filters select { padding: 0.5rem 2rem 0.5rem 0.75rem; border: 1px solid var(--border-card); border-radius: calc(var(--radius) - 0.25rem); font-size: 0.875rem; background: var(--bg-card) url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") no-repeat right 0.5rem center/1em; appearance: none; box-shadow: var(--shadow-sm); transition: border-color 150ms ease, box-shadow 150ms ease; color: var(--text-primary); }
.filters select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(165,107,255,0.2); }

/* ‚îÄ‚îÄ Tables ‚îÄ‚îÄ */
table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.875rem; }
th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border-card); }
th { background: var(--bg-surface); font-weight: 500; color: var(--text-soft); position: sticky; top: 0; cursor: pointer; user-select: none; white-space: nowrap; border-bottom: 1px solid var(--border-card); font-size: 0.8rem; letter-spacing: 0.02em; text-transform: uppercase; }
th:first-child { border-top-left-radius: calc(var(--radius) - 1px); }
th:last-child { border-top-right-radius: calc(var(--radius) - 1px); }
th:hover { background: #f4f4f5; color: var(--text-primary); }
tr:last-child td { border-bottom: none; }
tbody tr:nth-child(even):not(.total-row) { background: var(--bg-surface); }
tr:hover td { background: rgba(165,107,255,0.04); }
.table-wrap { border: 1px solid var(--border-card); border-radius: var(--radius); overflow-x: auto; -webkit-overflow-scrolling: touch; background: var(--bg-card); box-shadow: var(--shadow-sm); }
.dark .table-wrap { background: #111117; border-color: #23242f; box-shadow: var(--shadow-sm); }
.dark th { background: #050407; color: #9ea4b8; border-bottom-color: #27272a; }
.dark td { border-bottom-color: #27272a; color: #d4d4d8; }
.dark tbody tr:nth-child(even):not(.total-row) { background: rgba(255,255,255,0.02); }
.dark tr:hover td { background: rgba(165,107,255,0.06); }

/* ‚îÄ‚îÄ Priority Rows ‚îÄ‚îÄ */
tr.priority-critical td:first-child { border-left: 4px solid #cf222e; }
tr.priority-high td:first-child { border-left: 4px solid #bf8700; }
tr.priority-medium td:first-child { border-left: 4px solid #1a7f37; }
tr.priority-low td:first-child { border-left: 4px solid #8b949e; }
/* Reset old border-left on tr */
tr.priority-critical, tr.priority-high, tr.priority-medium, tr.priority-low { border-left: none; }

/* ‚îÄ‚îÄ Status Badges ‚îÄ‚îÄ */
.badge { display: inline-flex; align-items: center; font-size: 0.75rem; font-weight: 500; padding: 0.2rem 0.65rem; border-radius: 999px; text-transform: capitalize; letter-spacing: 0.02em; }
.badge-toil { background: rgba(9, 105, 218, 0.1); color: #0969da; border: 1px solid rgba(9, 105, 218, 0.2); }
.badge-triage { background: rgba(191, 135, 0, 0.1); color: #bf8700; border: 1px solid rgba(191, 135, 0, 0.2); }
.badge-in-progress { background: rgba(165,107,255,0.1); color: #4f46e5; border: 1px solid rgba(165,107,255,0.2); }
.badge-automated { background: rgba(26, 127, 55, 0.1); color: #1a7f37; border: 1px solid rgba(26, 127, 55, 0.2); }

/* ‚îÄ‚îÄ Inline Edit ‚îÄ‚îÄ */
td.editable { cursor: pointer; position: relative; }
td.editable:hover { background: rgba(165,107,255,0.04); border-radius: calc(var(--radius) - 0.25rem); }
td.editable input, td.editable select { font-size: 0.82rem; padding: 0.2rem 0.35rem; border: 1px solid var(--accent); border-radius: calc(var(--radius) - 0.25rem); width: 100%; background: var(--bg-card); }
.edited-marker { color: #a56bff; font-weight: 700; margin-left: 2px; font-size: 0.65rem; }

/* ‚îÄ‚îÄ Team Manager Panel ‚îÄ‚îÄ */
.team-manager { margin-bottom: 1.25rem; padding: 1rem; background: var(--bg-surface); border: 1px solid var(--border-card); border-radius: calc(var(--radius) - 0.25rem); }
.team-manager summary { font-weight: 600; font-size: 0.875rem; cursor: pointer; user-select: none; color: var(--text-primary); }
.team-manager summary:hover { color: var(--accent); }
.team-manager-list { margin-top: 0.75rem; display: flex; flex-direction: column; gap: 0.5rem; }
.team-rename-row { display: flex; align-items: center; gap: 0.5rem; }
.team-rename-row .team-current { font-size: 0.85rem; font-weight: 600; min-width: 140px; }
.team-rename-row span.arrow { color: #8b949e; font-size: 0.8rem; }
.team-rename-row input { font-size: 0.85rem; padding: 0.3rem 0.5rem; border: 1px solid var(--border-card); border-radius: calc(var(--radius) - 0.25rem); width: 180px; }
.team-rename-row .btn-rename { background: #0969da; color: #fff; border-color: #0969da; font-size: 0.75rem; padding: 0.25rem 0.5rem; }
.team-rename-row .btn-rename:hover { background: #0860ca; }
.team-rename-row .btn-rename:disabled { opacity: 0.5; cursor: not-allowed; }

/* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
.btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border: 1px solid var(--border-card); border-radius: calc(var(--radius) - 0.25rem); background: var(--bg-card); font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 150ms ease; box-shadow: var(--shadow-sm); color: var(--text-primary); }
.btn:hover { background: #f4f4f5; box-shadow: var(--shadow-md); }
.btn:active { transform: scale(0.98); }
.btn-launch { background: var(--accent); color: #fff; border: 1px solid var(--accent-strong); padding: 0.5rem 1rem; font-size: 0.8rem; line-height: 1.3; text-align: center; flex-direction: column; gap: 0.1rem; }
.btn-launch small { font-size: 0.7rem; opacity: 0.85; font-weight: 500; font-family: inherit; }
.btn-launch:hover { background: var(--accent-strong); box-shadow: 0 0 0 2px rgba(165,107,255,0.2); }
.btn-save { background: #2563eb; color: #fff; border: 1px solid #1d4ed8; }
.btn-save:hover { background: #1d4ed8; box-shadow: 0 0 0 2px rgba(37,99,235,0.2); }

/* ‚îÄ‚îÄ Toil Name Cell ‚îÄ‚îÄ */
.toil-name { font-weight: 600; font-size: 0.9rem; color: var(--text-primary); line-height: 1.4; letter-spacing: -0.01em; }
.toil-desc { font-size: 0.8rem; color: var(--text-soft); margin-top: 0.25rem; line-height: 1.5; font-weight: 400; }
.toil-cell { min-width: 320px; padding-top: 1.25rem; padding-bottom: 1.25rem; }
.toil-action-cell { white-space: nowrap; display: flex; flex-direction: column; gap: 0.4rem; align-items: flex-start; }
.status-toggle { cursor: pointer; transition: all 150ms ease; }
.status-toggle:hover { filter: brightness(1.15); transform: scale(1.05); }

/* ‚îÄ‚îÄ Copilot Tool Toggle ‚îÄ‚îÄ */




/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
.toast { position: fixed; bottom: 1.5rem; right: 1.5rem; background: #111117; color: #f5f7ff; padding: 0.75rem 1.25rem; border-radius: var(--radius); font-size: 0.875rem; font-weight: 500; z-index: 9999; opacity: 0; transform: translateY(10px); transition: all 150ms ease; pointer-events: none; border: 1px solid #27272a; box-shadow: var(--shadow-md); }
.toast.show { opacity: 1; transform: translateY(0); }

/* ‚îÄ‚îÄ Micro Animations ‚îÄ‚îÄ */
@keyframes pulseGlow {
  0% { box-shadow: 0 0 0 0 rgba(165,107,255,0.35); }
  60% { box-shadow: 0 0 0 12px rgba(165,107,255,0); }
  100% { box-shadow: 0 0 0 0 rgba(165,107,255,0); }
}
@keyframes floaty {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
}
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes heroShimmer {
  0% { background-position: -200% center; }
  100% { background-position: 200% center; }
}

/* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
/* ‚îÄ‚îÄ Responsive: Tablet ‚îÄ‚îÄ */
@media (max-width: 900px) {
  .container { padding: 1rem; }
  .cards { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
  .header { padding: 1.5rem; flex-direction: column; }
  .header .meta { justify-content: flex-start; text-align: left; }
  .insight-body { flex-direction: column; }
  .insights-grid { grid-template-columns: 1fr; }
  .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .toil-cell { min-width: 200px; }
}

/* ‚îÄ‚îÄ Responsive: Mobile ‚îÄ‚îÄ */
@media (max-width: 480px) {
  .container { padding: 0.75rem; }
  .header { padding: 1rem; }
  .header h1 { font-size: 1.3rem; }
  .hero-subtitle { font-size: 0.85rem; }
  .cards { grid-template-columns: 1fr 1fr; gap: 0.75rem; }
  .card { padding: 1rem; border-radius: calc(var(--radius) - 0.25rem); }
  .card .value { font-size: 1.8rem; }
  .section { padding: 1rem; border-radius: calc(var(--radius) - 0.25rem); }
  .filters { flex-direction: column; gap: 0.5rem; }
  .filters select { width: 100%; }
  .btn-launch { font-size: 0.75rem; padding: 0.4rem 0.75rem; }
  th, td { padding: 0.6rem 0.5rem; font-size: 0.78rem; }
  .toil-cell { min-width: 160px; }
  .toil-action-cell .btn-launch { white-space: normal; }
}

/* ‚îÄ‚îÄ Dark Mode Toggle ‚îÄ‚îÄ */
.theme-toggle { background: transparent; border: 1px solid #3f3f46; border-radius: calc(var(--radius) - 0.25rem); color: #f5f7ff; padding: 0.35rem 0.75rem; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 0.35rem; transition: all 150ms ease; }
.theme-toggle:hover { background: #23242f; border-color: #52525b; }

/* ‚îÄ‚îÄ Dark Mode (GitHub Primer Dark) ‚îÄ‚îÄ */
@media (prefers-color-scheme: dark) {
  :root:not(.light) {
    color-scheme: dark;
    --bg-surface: #09090b;
    --bg-card: #18181b;
    --border-card: #27272a;
    --text-soft: #a1a1aa;
    --text-primary: #fafafa;
  }
}
.dark { color-scheme: dark; }
.dark body, :root:not(.light) body { background: #050407; color: #f5f7ff; }
.dark body::before, :root:not(.light) body::before { opacity: 0.5; }

/* Unified Dark Mode Styles */
.dark .header,
@media (prefers-color-scheme: dark) { :root:not(.light) .header { background: #0f0f11; } }

.dark .header .meta,
@media (prefers-color-scheme: dark) { :root:not(.light) .header .meta { color: #9ea4b8; } }

.dark .card,
@media (prefers-color-scheme: dark) { :root:not(.light) .card { background: #111117; border-color: #23242f; } }

.dark .card:hover,
@media (prefers-color-scheme: dark) { :root:not(.light) .card:hover { box-shadow: var(--shadow-md); border-color: #3b3c49; } }

.dark .card .label,
@media (prefers-color-scheme: dark) { :root:not(.light) .card .label { color: #9ea4b8; } }

.dark .card .value,
@media (prefers-color-scheme: dark) { :root:not(.light) .card .value { color: #c58eff; } }

.dark .card .value.green,
@media (prefers-color-scheme: dark) { :root:not(.light) .card .value.green { color: #3dd68c; } }

.dark .card .value.purple,
@media (prefers-color-scheme: dark) { :root:not(.light) .card .value.purple { color: #dec0ff; } }

.dark .card .value.orange,
@media (prefers-color-scheme: dark) { :root:not(.light) .card .value.orange { color: #f6c05c; } }

.dark .section,
@media (prefers-color-scheme: dark) { :root:not(.light) .section { background: #111117; border-color: #23242f; } }

.dark .filters label,
@media (prefers-color-scheme: dark) { :root:not(.light) .filters label { color: #9ea4b8; } }

.dark .filters select,
@media (prefers-color-scheme: dark) { :root:not(.light) .filters select { background-color: #09090b; border-color: #23242f; color: #f5f7ff; } }

.dark th,
@media (prefers-color-scheme: dark) { :root:not(.light) th { background: #050407; color: #9ea4b8; border-color: #23242f; } }

.dark th:hover,
@media (prefers-color-scheme: dark) { :root:not(.light) th:hover { background: #111117; } }

.dark td,
@media (prefers-color-scheme: dark) { :root:not(.light) td { border-color: #23242f; } }

.dark tr:hover,
@media (prefers-color-scheme: dark) { :root:not(.light) tr:hover { background: #111117; } }

.dark tr.total-row,
@media (prefers-color-scheme: dark) { :root:not(.light) tr.total-row { background: #23242f; } }

.dark td.editable:hover,
@media (prefers-color-scheme: dark) { :root:not(.light) td.editable:hover { background: rgba(165,107,255,0.1); } }

.dark td.editable input, .dark td.editable select,
@media (prefers-color-scheme: dark) { :root:not(.light) td.editable input, :root:not(.light) td.editable select { background: #050407; border-color: var(--accent); color: #f5f7ff; } }

.dark .btn,
@media (prefers-color-scheme: dark) { :root:not(.light) .btn { background: #23242f; border-color: #3b3c49; color: #f5f7ff; } }

.dark .btn:hover,
@media (prefers-color-scheme: dark) { :root:not(.light) .btn:hover { background: #3b3c49; } }

.dark .btn-launch,
@media (prefers-color-scheme: dark) { :root:not(.light) .btn-launch { background: var(--accent); color: #fff; border-color: var(--accent-strong); } }

.dark .btn-launch:hover,
@media (prefers-color-scheme: dark) { :root:not(.light) .btn-launch:hover { background: var(--accent-strong); } }

.dark .toil-name,
@media (prefers-color-scheme: dark) { :root:not(.light) .toil-name { color: #f5f7ff; } }

.dark .toil-desc,
@media (prefers-color-scheme: dark) { :root:not(.light) .toil-desc { color: #9ea4b8; } }

.dark .btn-save,
@media (prefers-color-scheme: dark) { :root:not(.light) .btn-save { background: #2563eb; color: #fff; border-color: #1d4ed8; } }

.dark .btn-save:hover,
@media (prefers-color-scheme: dark) { :root:not(.light) .btn-save:hover { background: #1d4ed8; } }

.dark .badge-toil,
@media (prefers-color-scheme: dark) { :root:not(.light) .badge-toil { background: rgba(96,165,250,0.1); color: #93c5fd; } }

.dark .badge-triage,
@media (prefers-color-scheme: dark) { :root:not(.light) .badge-triage { background: rgba(251,191,36,0.1); color: #fde68a; } }

.dark .badge-in-progress,
@media (prefers-color-scheme: dark) { :root:not(.light) .badge-in-progress { background: rgba(165,107,255,0.1); color: #dec0ff; } }

.dark .badge-automated,
@media (prefers-color-scheme: dark) { :root:not(.light) .badge-automated { background: rgba(74,222,128,0.1); color: #86efac; } }

.dark .toast,
@media (prefers-color-scheme: dark) { :root:not(.light) .toast { background: #23242f; color: #f5f7ff; border-color: #3b3c49; } }

.dark .edited-marker,
@media (prefers-color-scheme: dark) { :root:not(.light) .edited-marker { color: #dec0ff; } }

.dark .team-manager,
@media (prefers-color-scheme: dark) { :root:not(.light) .team-manager { background: #050407; border-color: #23242f; } }

.dark .team-manager summary,
@media (prefers-color-scheme: dark) { :root:not(.light) .team-manager summary { color: #f5f7ff; } }

.dark .team-rename-row input,
@media (prefers-color-scheme: dark) { :root:not(.light) .team-rename-row input { background: #050407; border-color: #23242f; color: #f5f7ff; } }

.dark .team-rename-row .btn-rename,
@media (prefers-color-scheme: dark) { :root:not(.light) .team-rename-row .btn-rename { background: #2563eb; border-color: #1d4ed8; } }

.dark a,
@media (prefers-color-scheme: dark) { :root:not(.light) a { color: #c58eff; } }

.dark .details-toggle,
@media (prefers-color-scheme: dark) { :root:not(.light) .details-toggle { background: #111117; border-color: #23242f; color: #f5f7ff; } }

.dark .details-toggle:hover,
@media (prefers-color-scheme: dark) { :root:not(.light) .details-toggle:hover { background: #23242f; } }

.dark .theme-toggle { border-color: #3b3c49; }

/* ‚îÄ‚îÄ Trend Chart ‚îÄ‚îÄ */
#trendChart { flex: 1; display: flex; }
.trend-chart-wrap { width: 100%; overflow-x: auto; flex: 1; display: flex; align-items: stretch; }
.trend-chart-wrap svg { display: block; width: 100%; height: 100%; }
.trend-bar { transition: opacity 0.2s; }
.trend-bar:hover { opacity: 0.8; }
.trend-label { font-size: 11px; fill: var(--text-soft); font-family: 'Inter', system-ui, sans-serif; }
.trend-value { font-size: 11px; fill: var(--text-primary); font-weight: 600; font-family: 'Inter', system-ui, sans-serif; }
.trend-axis { stroke: var(--border-card); stroke-width: 1; }
.trend-grid { stroke: #f4f4f5; stroke-width: 1; stroke-dasharray: 4 4; }

.dark .trend-label,
@media (prefers-color-scheme: dark) { :root:not(.light) .trend-label { fill: #a1a1aa; } }

.dark .trend-value,
@media (prefers-color-scheme: dark) { :root:not(.light) .trend-value { fill: #fafafa; } }

.dark .trend-axis,
@media (prefers-color-scheme: dark) { :root:not(.light) .trend-axis { stroke: #27272a; } }

.dark .trend-grid,
@media (prefers-color-scheme: dark) { :root:not(.light) .trend-grid { stroke: #18181b; } }

/* ‚îÄ‚îÄ Print ‚îÄ‚îÄ */
@media print {
  .header { background: #fff !important; color: #000 !important; border-bottom: 2px solid #000; }
  .header .meta a { color: #000 !important; }
  .btn-launch, .btn-save, .filters, .theme-toggle { display: none !important; }
  .card { border: 1px solid #ccc !important; break-inside: avoid; background: #fff !important; color: #000 !important; }
  .card .value { color: #000 !important; }
  .section { break-inside: avoid; background: #fff !important; border-color: #ccc !important; }
  body { background: #fff !important; color: #000 !important; }
  th { background: #f6f8fa !important; color: #000 !important; }
  td { color: #000 !important; border-color: #d8dee4 !important; }
  .toast { display: none; }
}
</style>
</head>
<body>

<div class="header">
  <div class="hero-left">
    <p class="hero-eyebrow">Built with GitHub Copilot CLI</p>
    <h1>‚ö° AI Toil Tracker</h1>
    <p class="hero-subtitle">See your team's repetitive work, watch AI eliminate it, and track the hours you get back.</p>
    <div class="hero-pulse" id="heroPulse">
      <span class="pulse-pill neutral">‚ö° Scanning for toil‚Ä¶</span>
    </div>
  </div>
  <div class="meta">
    <span id="headerRepo"></span>
    <span>Generated: <span id="headerDate">‚Äî</span></span>
    <a href="#" id="headerRepoLink" target="_blank" rel="noopener noreferrer">View on GitHub ‚Üó</a>
    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle dark/light mode">üåô Dark</button>
  </div>
</div>

<div class="container">

  <!-- Summary Cards -->
  <div class="cards" id="summaryCards"></div>

  <!-- Insights Grid -->
  <div class="insights-grid" id="insightsGrid">
    <article class="insight-card" id="pipelineCard"></article>
    <article class="insight-card" id="trendChartCard">
      <div class="insight-header">
        <span class="eyebrow">Time Reclaimed</span>
        <span class="mini-pill live">Live</span>
      </div>
      <div id="trendChart" role="img" aria-label="Bar chart showing monthly hours saved from automation over time"></div>
    </article>
    <article class="insight-card" id="teamFocusCard"></article>
  </div>

  <!-- Main Toil Ideas Table -->
  <div class="section">
    <h2>üóÇÔ∏è Toil Backlog</h2>
    <div class="filters">
      <label>Team:</label>
      <select id="filterTeam"><option value="">All</option></select>
      <label>Category:</label>
      <select id="filterCategory"><option value="">All</option></select>
      <label>Status:</label>
      <select id="filterStatus"><option value="">All</option></select>
      <label>üìä Sort by:</label>
      <select id="filterSort">
        <option value="monthly_saved_minutes">‚è±Ô∏è Potential Time Saved / Month</option>
        <option value="toil_score">üéØ Impact Score</option>
        <option value="submitter">üßë‚Äçüíª Person</option>
      </select>
      <button class="show-cols-toggle" id="toggleCols" onclick="toggleColumns()">+ Show all details</button>
      <button class="show-cols-toggle" onclick="exportCSV()" title="Download as CSV">üì• CSV</button>
      <button class="show-cols-toggle" onclick="exportJSON()" title="Download as JSON">üì• JSON</button>
    </div>
    <div class="table-wrap">
      <table id="toilTable">
        <thead>
          <tr>
            <th data-col="number">#Ô∏è‚É£</th>
            <th data-col="title">üí° Toil</th>
            <th data-col="actions"></th>
            <th data-col="submitter">üßë‚Äçüíª Submitter</th>
            <th data-col="category" class="col-hidden">üè∑Ô∏è Category</th>
            <th data-col="frequency">üîÑ Frequency</th>
            <th data-col="time_per_occurrence">‚è±Ô∏è Time</th>
            <th data-col="people_affected">üë• People</th>
            <th data-col="toil_score">üéØ Impact Score</th>
            <th data-col="status">üìç Status</th>
            <th data-col="monthly_saved_minutes">‚è±Ô∏è Time Saved / Month</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// THEME ‚Äî Dark/Light mode with localStorage persistence
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initTheme() {
  const saved = localStorage.getItem('toilDashTheme');
  if (saved === 'dark') { applyDark(); }
  else if (saved === 'light') { applyLight(); }
  // else: follow system preference via CSS prefers-color-scheme
}
function toggleTheme() {
  const html = document.documentElement;
  if (html.classList.contains('dark')) { applyLight(); localStorage.setItem('toilDashTheme', 'light'); }
  else { applyDark(); localStorage.setItem('toilDashTheme', 'dark'); }
}
function applyDark() {
  document.documentElement.classList.add('dark');
  document.documentElement.classList.remove('light');
  const btn = document.getElementById('themeToggle');
  if (btn) { btn.innerHTML = '‚òÄÔ∏è Light'; }
}
function applyLight() {
  document.documentElement.classList.remove('dark');
  document.documentElement.classList.add('light');
  const btn = document.getElementById('themeToggle');
  if (btn) { btn.innerHTML = 'üåô Dark'; }
}
initTheme();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG ‚Äî Set your owner/repo here
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CONFIG = {
  owner: '',
  repo: '',
  get fullRepo() { return `${this.owner}/${this.repo}`; }
};
// Auto-detect from GitHub Pages URL (e.g. owner.github.io/repo/dashboard/)
(function() {
  const parts = window.location.pathname.split('/').filter(Boolean);
  if (window.location.hostname.endsWith('.github.io') && parts.length >= 1) {
    CONFIG.owner = window.location.hostname.split('.')[0];
    CONFIG.repo = parts[0];
  } else {
    // Fallback ‚Äî edit these if not on GitHub Pages
    CONFIG.owner = 'DUBSOpenHub';
    CONFIG.repo = 'ai-toil-tracker';
  }
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCORE MULTIPLIERS (matches ai-triage.yml)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FREQ_SCORES = {
  'üî¥ Multiple times per day': { score: 8, monthly: 60 },
  'üü† Daily': { score: 5, monthly: 20 },
  'üü° Multiple times per week': { score: 3, monthly: 10 },
  'üîµ Weekly': { score: 2, monthly: 4 },
  '‚ö™ Monthly or less': { score: 1, monthly: 1 }
};
const TIME_SCORES = {
  '> 1 hour': { score: 8, mins: 75 },
  '30‚Äì60 minutes': { score: 5, mins: 45 },
  '15‚Äì30 minutes': { score: 3, mins: 22 },
  '5‚Äì15 minutes': { score: 2, mins: 10 },
  '< 5 minutes': { score: 1, mins: 3 }
};
const PEOPLE_SCORES = {
  'Multiple teams / org-wide': { score: 8 },
  'Entire team': { score: 5 },
  '4\u20136 people': { score: 3 },
  '2\u20133 people': { score: 2 },
  'Just me': { score: 1 }
};
const BONUS_MAP = {
  '‚ùå Error-prone': 2,
  'üîó Blocking': 3,
  'üò§ Morale killer': 1,
  'üìà Growing worse': 2,
  'üÜï New team friction': 1
};

const PRIORITY_BANDS = [
  { id: 'critical', min: 40, className: 'priority-critical', label: 'üî¥ Critical' },
  { id: 'high', min: 20, className: 'priority-high', label: 'üü† High' },
  { id: 'medium', min: 10, className: 'priority-medium', label: 'üü° Medium' },
  { id: 'low', min: 0, className: 'priority-low', label: '‚ö™ Low' }
];
const CRITICAL_THRESHOLD = PRIORITY_BANDS[0].min;

function getPriorityBand(score = 0) {
  return PRIORITY_BANDS.find(band => score >= band.min) || PRIORITY_BANDS[PRIORITY_BANDS.length - 1];
}

function isCritical(score = 0) {
  return score >= CRITICAL_THRESHOLD;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAMPLE DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SAMPLE_DATA = {
  repo: CONFIG.fullRepo,
  generated_at: new Date().toISOString(),
  issues: [
    {
      number: 1,
      title: "[TOIL] Staging Deploy ‚Äî Manual deployment steps for staging environment",
      url: `https://github.com/${CONFIG.fullRepo}/issues/1`,
      state: "open",
      labels: ["toil", "high-impact", "üî¥ multiple-times-daily"],
      submitter: "Maya Patel (@mayap)",
      team: "Platform",
      category: "üîß CI/CD & Builds",
      frequency: "üî¥ Multiple times per day",
      time_per_occurrence: "30‚Äì60 minutes",
      people_affected: "Entire team",
      bonus_factors: ["‚ùå Error-prone", "üîó Blocking"],
      automation_idea: "Create a CI/CD pipeline with GitHub Actions to automate staging deployments",
      toil_score: 200,
      priority: "üî¥ Critical",
      monthly_saved_minutes: 6000,
      weekly_time_spent: 1500,
      team_weekly_time_spent: 4200,
      weekly_time_spent_display: "25 hrs/week",
      team_weekly_time_spent_display: "70 hrs/week",
      created_at: "2026-02-10T10:00:00Z",
      ai_suggestion: "Use reusable GitHub Actions workflow with environment gates"
    },
    {
      number: 2,
      title: "[TOIL] Credential Rotation ‚Äî Rotating database credentials manually every week",
      url: `https://github.com/${CONFIG.fullRepo}/issues/2`,
      state: "open",
      labels: ["toil", "triage"],
      submitter: "Liam Ortiz (@liamortiz)",
      team: "DevOps",
      category: "üîê Security & Compliance",
      frequency: "üîµ Weekly",
      time_per_occurrence: "15‚Äì30 minutes",
      people_affected: "2-3 people",
      bonus_factors: ["‚ùå Error-prone"],
      automation_idea: "Use AWS Secrets Manager automatic rotation",
      toil_score: 14,
      priority: "üü° Medium",
      monthly_saved_minutes: 4800,
      weekly_time_spent: 1200,
      team_weekly_time_spent: 2400,
      weekly_time_spent_display: "20 hrs/week",
      team_weekly_time_spent_display: "40 hrs/week",
      created_at: "2026-02-04T14:30:00Z",
      ai_suggestion: "Configure AWS Secrets Manager with Lambda rotation function"
    },
    {
      number: 3,
      title: "[TOIL] Test Results ‚Äî Copy-pasting test results into Slack every morning",
      url: `https://github.com/${CONFIG.fullRepo}/issues/3`,
      state: "closed",
      labels: ["toil", "automated"],
      submitter: "Nina Gomez (@ninagomez)",
      team: "Engineering",
      category: "üìä Reporting & Communication",
      frequency: "üü† Daily",
      time_per_occurrence: "5‚Äì15 minutes",
      people_affected: "Just you",
      bonus_factors: ["üò§ Morale killer"],
      automation_idea: "Slack bot that posts CI results automatically",
      toil_score: 11,
      priority: "üü° Medium",
      monthly_saved_minutes: 3600,
      weekly_time_spent: 900,
      team_weekly_time_spent: 900,
      weekly_time_spent_display: "15 hrs/week",
      team_weekly_time_spent_display: "15 hrs/week",
      created_at: "2026-01-18T09:00:00Z",
      ai_suggestion: "GitHub Actions workflow with Slack notification step"
    },
    {
      number: 4,
      title: "[TOIL] Dep Updates ‚Äî Updating dependency versions across 12 microservices",
      url: `https://github.com/${CONFIG.fullRepo}/issues/4`,
      state: "open",
      labels: ["toil", "in-progress", "high-impact"],
      submitter: "Ravi Shah (@ravishah)",
      team: "Platform",
      category: "üîß CI/CD & Builds",
      frequency: "üü° Multiple times per week",
      time_per_occurrence: "> 1 hour",
      people_affected: "4-6 people",
      bonus_factors: ["‚ùå Error-prone", "üìà Growing worse"],
      automation_idea: "Dependabot with auto-merge for patch versions",
      toil_score: 76,
      priority: "üî¥ Critical",
      monthly_saved_minutes: 2400,
      weekly_time_spent: 600,
      team_weekly_time_spent: 1800,
      weekly_time_spent_display: "10 hrs/week",
      team_weekly_time_spent_display: "30 hrs/week",
      created_at: "2025-12-12T11:00:00Z",
      ai_suggestion: "Set up Dependabot with grouped updates and auto-merge workflow"
    },
    {
      number: 5,
      title: "[TOIL] Dev Onboarding ‚Äî Manual environment setup for new engineers",
      url: `https://github.com/${CONFIG.fullRepo}/issues/5`,
      state: "open",
      labels: ["toil", "triage"],
      submitter: "Priya Desai (@priyadesai)",
      team: "Product",
      category: "üÜï Onboarding & Access",
      frequency: "‚ö™ Monthly or less",
      time_per_occurrence: "> 1 hour",
      people_affected: "2-3 people",
      bonus_factors: ["üÜï New team friction", "üò§ Morale killer"],
      automation_idea: "Dev container or Codespaces setup with scripted provisioning",
      toil_score: 18,
      priority: "üü° Medium",
      monthly_saved_minutes: 1200,
      weekly_time_spent: 300,
      team_weekly_time_spent: 600,
      weekly_time_spent_display: "5 hrs/week",
      team_weekly_time_spent_display: "10 hrs/week",
      created_at: "2025-11-05T16:00:00Z",
      ai_suggestion: "Create devcontainer.json with all tools and extensions pre-configured"
    },
    {
      number: 6,
      title: "[TOIL] Ticket Triage ‚Äî Routing incoming support tickets from Zendesk",
      url: `https://github.com/${CONFIG.fullRepo}/issues/6`,
      state: "closed",
      labels: ["toil", "high-impact", "automated"],
      submitter: "Jordan Reed (@jordanreed)",
      team: "Engineering",
      category: "üìä Reporting & Communication",
      frequency: "üü† Daily",
      time_per_occurrence: "30‚Äì60 minutes",
      people_affected: "Entire team",
      bonus_factors: ["üîó Blocking", "üìà Growing worse"],
      automation_idea: "Use an AI classifier to auto-route tickets by category",
      toil_score: 55,
      priority: "üî¥ Critical",
      monthly_saved_minutes: 3000,
      weekly_time_spent: 750,
      team_weekly_time_spent: 2250,
      weekly_time_spent_display: "12.5 hrs/week",
      team_weekly_time_spent_display: "37.5 hrs/week",
      created_at: "2026-01-05T08:00:00Z",
      ai_suggestion: "Train a classifier on historical ticket data to auto-label and route"
    }
  ]
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let dashboardData = null;
let sortCol = 'team_weekly_time_spent';
let sortDir = -1; // -1 = desc
const localEdits = JSON.parse(localStorage.getItem('toilEdits') || '{}');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA LOADING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function normalizeData(raw) {
  if (raw.toilItems) {
    return {
      repo: raw.repository,
      generated_at: raw.generatedAt,
      issues: raw.toilItems.map(item => ({
        number: item.number,
        title: item.title,
        url: item.url,
        state: item.state?.toLowerCase() || 'unknown',
        labels: (item.labels || '').split(',').filter(Boolean),
        submitter: item.submitter,
        team: item.team,
        category: item.category,
        frequency: item.frequency?.label || 'unknown',
        time_per_occurrence: item.time?.label || 'unknown',
        people_affected: item.people?.label || 'unknown',
        bonus_factors: item.bonusFactors || [],
        automation_idea: item.automationIdea || '',
        toil_score: item.toilScore,
        priority: item.priority,
        monthly_saved_minutes: item.monthlyMinutes,
        created_at: item.createdAt,
        ai_suggestion: ''
      })),
      wins: raw.wins || [],
      summary: raw.summary
    };
  }
  return raw; // Legacy format pass-through
}

async function loadData() {
  // Try local JSON first
  try {
    const res = await fetch('dashboard-data.json');
    if (res.ok) {
      dashboardData = normalizeData(await res.json());
      applyLocalEdits();
      render();
      return;
    }
  } catch (_) { /* fall through */ }

  // Fallback: GitHub API
  try {
    const apiUrl = `https://api.github.com/repos/${CONFIG.fullRepo}/issues?labels=toil&state=all&per_page=100`;
    const res = await fetch(apiUrl);
    if (res.ok) {
      const apiIssues = await res.json();
      if (apiIssues.length > 0) {
        dashboardData = convertApiIssues(apiIssues);
        applyLocalEdits();
        render();
        return;
      }
    }
  } catch (_) { /* fall through */ }

  // Fallback: sample data
  dashboardData = SAMPLE_DATA;
  applyLocalEdits();
  render();
}

function convertApiIssues(apiIssues) {
  return {
    repo: CONFIG.fullRepo,
    generated_at: new Date().toISOString(),
    issues: apiIssues.filter(i => !i.pull_request).map(issue => {
      const body = issue.body || '';
      const labels = issue.labels.map(l => l.name);
      const freq = extractField(body, 'How often does it happen?') || '‚ö™ Monthly or less';
      const time = extractField(body, 'How long does it take each time?') || '< 5 minutes';
      const people = extractField(body, 'Who is affected?') || 'Just me';
      const team = extractField(body, 'What team or group are you on?') || 'Unknown';
      const category = extractField(body, 'What area does this toil fall under?') || 'Other';
      const submitter = issue.user ? `${issue.user.login} (@${issue.user.login})` : 'Unknown';
      const bonusRaw = extractField(body, 'Bonus factors (check all that apply)') || '';
      const bonus = Object.keys(BONUS_MAP).filter(b => bonusRaw.includes(b));
      const { score, monthlyMins } = calcScore(freq, time, people, bonus);
      return {
        number: issue.number,
        title: issue.title,
        url: issue.html_url,
        state: issue.state,
        labels,
        submitter,
        team,
        category,
        frequency: freq,
        time_per_occurrence: time,
        people_affected: people,
        bonus_factors: bonus,
        automation_idea: extractField(body, 'Automation idea (if any)') || '',
        toil_score: score,
        priority: getPriorityLabel(score),
        monthly_saved_minutes: monthlyMins,
        created_at: issue.created_at,
        ai_suggestion: ''
      };
    })
  };
}

function extractField(body, field) {
  const escaped = field.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const regex = new RegExp(`###?\\s*${escaped}[\\s:]*\\n+([^\\n]+)`, 'i');
  const m = body.match(regex);
  return m ? m[1].trim() : null;
}

function calcScore(freq, time, people, bonus) {
  const fObj = FREQ_SCORES[freq] || { score: 1, monthly: 1 };
  const tObj = TIME_SCORES[time] || { score: 1, mins: 3 };
  const pObj = PEOPLE_SCORES[people] || { score: 1 };
  const base = fObj.score * tObj.score * pObj.score;
  const bonusList = Array.isArray(bonus) ? bonus : [];
  const bonusTotal = bonusList.reduce((s, b) => s + (BONUS_MAP[b] || 0), 0);
  const score = base + bonusTotal;
  const monthlyMins = fObj.monthly * tObj.mins * pObj.score;
  return { score, monthlyMins };
}

function applyLocalEdits() {
  if (!dashboardData) return;
  dashboardData.issues.forEach(issue => {
    const edits = localEdits[issue.number];
    if (!edits) return;
    if (edits.frequency) issue.frequency = edits.frequency;
    if (edits.time_per_occurrence) issue.time_per_occurrence = edits.time_per_occurrence;
    if (edits.people_affected) issue.people_affected = edits.people_affected;
    // Recalculate score
    const { score, monthlyMins } = calcScore(issue.frequency, issue.time_per_occurrence, issue.people_affected, issue.bonus_factors);
    issue.toil_score = score;
    issue.monthly_saved_minutes = monthlyMins;
    issue.priority = getPriorityLabel(score);
  });
}

function saveLocalEdits() {
  localStorage.setItem('toilEdits', JSON.stringify(localEdits));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATUS HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getStatus(issue) {
  // Check local overrides first
  if (localEdits[issue.number] && localEdits[issue.number].status) {
    return localEdits[issue.number].status;
  }
  const labels = issue.labels.map(l => l.toLowerCase());
  if (labels.includes('automated') || issue.state === 'closed') return 'automated';
  if (labels.includes('in-progress')) return 'in-progress';
  if (labels.includes('triage')) return 'triage';
  return 'toil';
}

function statusBadge(status, issueNum) {
  const badges = {
    'automated': '‚úÖ shipped',
    'in-progress': 'üî® building',
    'triage': 'üîç triaging',
    'toil': 'üí° ready to fix'
  };
  const edited = issueNum && localEdits[issueNum] && localEdits[issueNum].status ? '<span class="edited-marker">‚úé</span>' : '';
  return `<span class="badge badge-${status} status-toggle" data-issue="${issueNum || ''}" style="cursor:pointer" title="Click to update status">${badges[status] || status}${edited}</span>`;
}

function priorityClass(score) {
  return getPriorityBand(score).className;
}

function getPriorityLabel(score) {
  return getPriorityBand(score).label;
}

function formatMinutes(mins) {
  if (mins >= 60) return `${(mins / 60).toFixed(1)} hrs/mo`;
  return `${Math.round(mins)} min/mo`;
}

function formatWeeklyTime(mins) {
  if (!mins && mins !== 0) return '‚Äî';
  if (mins >= 60) return `${(mins / 60).toFixed(1)} hrs/wk`;
  return `${Math.round(mins)} min/wk`;
}

function formatCurrencyShort(value) {
  if (!isFinite(value) || value <= 0) return '$0';
  if (value >= 1_000_000) return `$${(value / 1_000_000).toFixed(1)}M`;
  if (value >= 1_000) return `$${(value / 1_000).toFixed(0)}K`;
  return `$${Math.round(value)}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render() {
  const data = dashboardData;
  if (!data) return;

  // Apply team renames
  applyTeamRenames(data.issues);

  // Header
  document.getElementById('headerRepo').textContent = data.repo;
  document.getElementById('headerDate').textContent = new Date(data.generated_at).toLocaleDateString();
  document.getElementById('headerRepoLink').href = `https://github.com/${data.repo}`;

  const issues = data.issues;

  // Populate filter dropdowns
  populateFilters(issues);

  // Summary cards
  renderSummaryCards(issues);

  // Hero + insight telemetry
  renderHeroPulse(issues);
  renderInsightPanels(issues);

  // Trend chart
  renderTrendChart(issues);

  // Team manager + breakdown
  renderTeamFocusCard(issues);

  // Main table
  renderToilTable(issues);
}

function populateFilters(issues) {
  const teams = [...new Set(issues.map(i => i.team).filter(Boolean))].sort();
  const categories = [...new Set(issues.map(i => i.category).filter(Boolean))].sort();
  const statuses = [...new Set(issues.map(i => getStatus(i)))].sort();

  fillSelect('filterTeam', teams);
  fillSelect('filterCategory', categories);
  fillSelect('filterStatus', statuses);
}

function fillSelect(id, options) {
  const sel = document.getElementById(id);
  const current = sel.value;
  // Keep first "All" option
  while (sel.options.length > 1) sel.remove(1);
  options.forEach(o => {
    const opt = document.createElement('option');
    opt.value = o; opt.textContent = o;
    sel.appendChild(opt);
  });
  sel.value = current;
}

// ‚îÄ‚îÄ Summary Cards ‚îÄ‚îÄ
function renderSummaryCards(issues) {
  const total = issues.length || 0;
  const statusCounts = issues.reduce((acc, issue) => {
    const status = getStatus(issue);
    acc[status] = (acc[status] || 0) + 1;
    return acc;
  }, {});
  const automated = statusCounts['automated'] || 0;
  const inProgress = statusCounts['in-progress'] || 0;
  const backlog = statusCounts['toil'] || 0;
  const totalMinsSaved = issues.reduce((s, i) => s + (i.monthly_saved_minutes || 0), 0);
  const hoursSaved = totalMinsSaved / 60;
  const automationRate = total ? Math.round((automated / total) * 100) : 0;
  const riskIssues = issues.filter(i => getStatus(i) !== 'automated' && isCritical(i.toil_score));
  const riskMins = riskIssues.reduce((s, i) => s + (i.monthly_saved_minutes || 0), 0);
  const riskHours = riskMins / 60;
  const avgHoursPerIdea = total ? (hoursSaved / total) : 0;
  const weeklyBurn = issues.reduce((s, i) => s + (i.team_weekly_time_spent || 0), 0) / 60;
  const fteRecovered = hoursSaved / 160;
  const targetRate = 55;
  const rateDelta = automationRate - targetRate;
  const deltaClass = rateDelta >= 0 ? 'positive' : 'negative';
  const deltaLabel = `${rateDelta >= 0 ? '+' : ''}${rateDelta.toFixed(0)} pts vs target`;
  const mitigationRate = hoursSaved + riskHours > 0 ? Math.round((hoursSaved / (hoursSaved + riskHours)) * 100) : 0;
  const riskShare = total ? Math.round((riskIssues.length / total) * 100) : 0;
  const backlogShare = total ? Math.round((backlog / total) * 100) : 0;

  document.getElementById('summaryCards').innerHTML = `
    <article class="card">
      <div class="label">Automation Velocity</div>
      <div class="value"><span class="value-number" data-animate="${automationRate}" data-format="percent">${automationRate}%</span></div>
      <div class="delta ${deltaClass}">${deltaLabel}</div>
      <p class="card-subtext">${automated} of ${total} toil signals retired</p>
      <div class="micro-progress"><span style="width:${Math.min(automationRate, 100)}%"></span></div>
    </article>
    <article class="card emerald">
      <div class="label">Hours Saved / Month</div>
      <div class="value"><span class="value-number" data-animate="${hoursSaved}" data-format="hours">${hoursSaved.toFixed(1)}</span><sup>hrs</sup></div>
      <p class="card-subtext">‚âà ${fteRecovered.toFixed(1)} FTEs given back</p>
      <div class="micro-progress" data-color="success"><span style="width:${Math.min(mitigationRate, 100)}%"></span></div>
    </article>
    <article class="card">
      <div class="label">Critical Hotspots</div>
      <div class="value"><span class="value-number" data-animate="${riskIssues.length}" data-format="number">${riskIssues.length}</span></div>
      <p class="card-subtext">${riskShare}% of backlog is üî¥ critical</p>
      <div class="micro-progress" data-color="danger"><span style="width:${Math.min(riskShare, 100)}%"></span></div>
    </article>
    <article class="card">
      <div class="label">Avg Payoff / Idea</div>
      <div class="value"><span class="value-number" data-animate="${avgHoursPerIdea}" data-format="hours">${avgHoursPerIdea.toFixed(1)}</span><sup>hrs</sup></div>
      <p class="card-subtext">Teams burn ${weeklyBurn.toFixed(1)} hrs/week on toil</p>
      <div class="micro-progress" data-color="warning"><span style="width:${Math.min(backlogShare, 100)}%"></span></div>
    </article>
  `;
  animateSummaryNumbers();
}

function animateSummaryNumbers() {
  requestAnimationFrame(() => {
    document.querySelectorAll('#summaryCards [data-animate]').forEach(el => {
      const target = parseFloat(el.dataset.animate) || 0;
      const format = el.dataset.format || 'number';
      animateValue(el, target, format);
    });
  });
}

function animateValue(el, target, format) {
  const duration = 900;
  const start = 0;
  const startTime = performance.now();
  function frame(now) {
    const progress = Math.min((now - startTime) / duration, 1);
    const eased = easeOutCubic(progress);
    const current = start + (target - start) * eased;
    el.textContent = formatAnimatedValue(current, format);
    if (progress < 1) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

function formatAnimatedValue(value, format) {
  if (format === 'percent') return `${Math.round(value)}%`;
  if (format === 'hours') return `${value.toFixed(1)}`;
  return `${Math.round(value)}`;
}

function easeOutCubic(t) {
  return 1 - Math.pow(1 - t, 3);
}

function renderHeroPulse(issues) {
  const heroPulse = document.getElementById('heroPulse');
  if (!heroPulse) return;
  const total = issues.length || 0;
  const automated = issues.filter(i => getStatus(i) === 'automated').length;
  const inProgress = issues.filter(i => getStatus(i) === 'in-progress').length;
  const triage = issues.filter(i => getStatus(i) === 'triage').length;
  const backlog = issues.filter(i => getStatus(i) === 'toil').length;
  const automationRate = total ? Math.round((automated / total) * 100) : 0;
  const highImpact = issues.filter(i => isCritical(i.toil_score) && getStatus(i) !== 'automated').length;
  heroPulse.innerHTML = `
    <span class="pulse-pill success">‚ö° ${automationRate}% automated</span>
    <span class="pulse-pill warning">üî• ${highImpact} critical</span>
    <span class="pulse-pill" data-filter-status="" style="cursor:pointer;border-color:rgba(67,198,255,0.45);background:rgba(67,198,255,0.12);color:#7dd8ff;" title="Show all">üì¶ ${total} signals (${backlog} backlog)</span>
    <span class="pulse-pill" data-filter-status="automated" style="cursor:pointer;border-color:rgba(61,214,140,0.5);background:rgba(61,214,140,0.18);color:#6eeeb0;" title="Filter to shipped">‚úÖ ${automated} shipped</span>
    <span class="pulse-pill" data-filter-status="in-progress" style="cursor:pointer;border-color:rgba(165,107,255,0.5);background:rgba(165,107,255,0.18);color:#dec0ff;" title="Filter to building">üî® ${inProgress} building</span>
    <span class="pulse-pill" data-filter-status="triage" style="cursor:pointer;border-color:rgba(246,192,92,0.5);background:rgba(246,192,92,0.15);color:#fcd77a;" title="Filter to triaging">üîç ${triage} triaging</span>
    <span class="pulse-pill" data-filter-status="toil" style="cursor:pointer;border-color:rgba(255,102,122,0.45);background:rgba(255,102,122,0.12);color:#ff99aa;" title="Filter to ready">üí° ${backlog} ready to fix</span>
  `;
}

function renderInsightPanels(issues) {
  renderPipelineCard(issues);
  renderTeamFocusCard(issues);
}

function renderPipelineCard(issues) {
  const card = document.getElementById('pipelineCard');
  if (!card) return;
  const total = issues.length || 0;
  const counts = { backlog: 0, triage: 0, building: 0, shipped: 0 };
  issues.forEach(issue => {
    const status = getStatus(issue);
    if (status === 'automated') counts.shipped++;
    else if (status === 'in-progress') counts.building++;
    else if (status === 'triage') counts.triage++;
    else counts.backlog++;
  });
  const automationRate = total ? Math.round((counts.shipped / total) * 100) : 0;
  card.innerHTML = `
    <div class="insight-header">
      <span class="eyebrow">Pipeline Momentum</span>
      <span class="mini-pill live">Live</span>
    </div>
    <div class="insight-body">
      <div class="radial-progress"><strong>${automationRate}%</strong><span>Automated</span></div>
      <div class="stat-list">
        <div class="stat-row"><span>Automated</span><strong>${counts.shipped}</strong></div>
        <div class="stat-row"><span>Building</span><strong>${counts.building}</strong></div>
        <div class="stat-row"><span>Triage</span><strong>${counts.triage}</strong></div>
        <div class="stat-row"><span>Backlog</span><strong>${counts.backlog}</strong></div>
      </div>
    </div>
  `;
  const gauge = card.querySelector('.radial-progress');
  if (gauge) {
    gauge.style.setProperty('--progress', `${automationRate * 3.6}deg`);
  }
}



function renderTeamFocusCard(issues) {
  const card = document.getElementById('teamFocusCard');
  if (!card) return;
  const personMap = {};
  issues.forEach(issue => {
    const person = issue.submitter || 'Unknown';
    const name = person.replace(/\s*\(@\w+\)/, '');
    if (!personMap[name]) personMap[name] = { weekly: 0, saved: 0, count: 0, automated: 0, team: issue.team || '' };
    personMap[name].weekly += (issue.weekly_time_spent || 0);
    personMap[name].saved += (issue.monthly_saved_minutes || 0);
    personMap[name].count++;
    if (getStatus(issue) === 'automated') personMap[name].automated++;
  });
  const people = Object.entries(personMap).sort((a, b) => (b[1].weekly || 0) - (a[1].weekly || 0)).slice(0, 6);
  const topPerson = people[0];
  const totalWeekly = people.reduce((s, [, d]) => s + d.weekly, 0);
  const totalSaved = people.reduce((s, [, d]) => s + d.saved, 0);
  card.innerHTML = `
    <div class="insight-header">
      <span class="eyebrow">People on Team</span>
      <span class="mini-pill">${people.length} contributors</span>
    </div>
    <div class="team-pills">
      ${people.map(([name, data]) => {
        const pct = data.count > 0 ? Math.round((data.automated / data.count) * 100) : 0;
        return `
        <div class="team-pill">
          <span>${esc(name)}</span>
          <strong>${formatWeeklyTime(data.weekly)}</strong>
          <small>${data.count} toil${data.count !== 1 ? 's' : ''} ‚Ä¢ ${pct}% automated ‚Ä¢ ${esc(data.team)}</small>
        </div>`;
      }).join('')}
    </div>
    <p class="insight-note" style="margin-top:auto;">${topPerson ? `${people.length} people spend a combined ${formatWeeklyTime(totalWeekly)} on toil weekly ‚Äî ${formatMinutes(totalSaved)} could be saved monthly through automation. üöÄ` : 'Submit toil ideas to see who benefits most.'}</p>
  `;
}

// ‚îÄ‚îÄ Executive Summary for Leadership ‚îÄ‚îÄ

// ‚îÄ‚îÄ Team Name Management ‚îÄ‚îÄ
function getTeamRenames() {
  return JSON.parse(localStorage.getItem('toilTeamRenames') || '{}');
}
function saveTeamRenames(renames) {
  localStorage.setItem('toilTeamRenames', JSON.stringify(renames));
}
function applyTeamRenames(issues) {
  const renames = getTeamRenames();
  issues.forEach(i => {
    if (i._originalTeam === undefined) i._originalTeam = i.team;
    if (renames[i._originalTeam]) i.team = renames[i._originalTeam];
  });
}
function renderTeamManager(issues) {
  const renames = getTeamRenames();
  const originalTeams = [...new Set(issues.map(i => i._originalTeam || i.team))].sort();
  const container = document.getElementById('teamManagerList');
  if (!originalTeams.length) { container.innerHTML = '<p style="font-size:0.85rem;color:#8b949e;">No teams found yet.</p>'; return; }
  container.innerHTML = originalTeams.map(t => {
    const current = renames[t] || t;
    return `<div class="team-rename-row">
      <span class="team-current">${esc(t)}</span>
      <span class="arrow">‚Üí</span>
      <input type="text" value="${esc(current)}" data-original="${esc(t)}" placeholder="New team name" />
      <button class="btn btn-rename" onclick="renameTeam(this)">Rename</button>
    </div>`;
  }).join('');
}
function renameTeam(btn) {
  const row = btn.closest('.team-rename-row');
  const input = row.querySelector('input');
  const original = input.dataset.original;
  const newName = input.value.trim();
  if (!newName) return;
  const renames = getTeamRenames();
  if (newName === original) { delete renames[original]; }
  else { renames[original] = newName; }
  saveTeamRenames(renames);
  applyTeamRenames(dashboardData.issues);
  render();
  showToast(`üè∑Ô∏è Team glow-up complete: ${original} ‚Üí ${newName} ‚ú®`);
}

// ‚îÄ‚îÄ Trend Chart ‚Äî Monthly hours reclaimed ‚îÄ‚îÄ
function renderTrendChart(issues) {
  const container = document.getElementById('trendChart');
  if (!container) return;

  // Build monthly buckets from issue created_at dates ‚Äî only months with data
  const monthMap = {};
  issues.forEach(issue => {
    const created = issue.created_at ? issue.created_at.slice(0, 7) : null;
    if (!created) return;
    if (!monthMap[created]) monthMap[created] = { total: 0, automated: 0 };
    const hrs = (issue.monthly_saved_minutes || 0) / 60;
    monthMap[created].total += hrs;
    if (getStatus(issue) === 'automated') monthMap[created].automated += hrs;
  });

  const months = Object.keys(monthMap).sort();
  const data = months.map(k => ({ month: k, total: monthMap[k].total, automated: monthMap[k].automated }));

  if (data.length === 0 || data.every(d => d.total === 0)) {
    container.innerHTML = '<p style="color:var(--text-soft);font-size:0.9rem;">Submit your first toil idea to start tracking impact.</p>';
    return;
  }

  const maxVal = Math.max(...data.map(d => d.total));
  // Round up to a clean number for the Y-axis
  const yMax = maxVal <= 10 ? Math.ceil(maxVal) : Math.ceil(maxVal / 10) * 10;

  const barCount = data.length;
  const barW = barCount === 1 ? 64 : barCount <= 3 ? 56 : 40;
  const barGap = 24;
  const pad = { top: 28, right: 20, bottom: 48, left: 50 };
  const totalBarsWidth = barCount * barW + Math.max(0, barCount - 1) * barGap;
  const svgW = pad.left + Math.max(totalBarsWidth + 40, 120) + pad.right;
  const svgH = 180;
  const chartW = svgW - pad.left - pad.right;
  const chartH = svgH - pad.top - pad.bottom;

  // Y-axis grid lines ‚Äî use clean intervals
  const gridCount = Math.min(4, yMax);
  let gridLines = '';
  for (let i = 0; i <= gridCount; i++) {
    const y = pad.top + chartH - (chartH * i / gridCount);
    const val = Math.round(yMax * i / gridCount);
    gridLines += `<line x1="${pad.left}" y1="${y}" x2="${svgW - pad.right}" y2="${y}" class="trend-grid"/>`;
    gridLines += `<text x="${pad.left - 8}" y="${y + 4}" text-anchor="end" class="trend-label">${val}h</text>`;
  }

  // Bars ‚Äî centered in available space
  const startX = pad.left + (chartW - totalBarsWidth) / 2;
  let bars = '';
  data.forEach((d, i) => {
    const x = startX + i * (barW + barGap);
    const totalH = Math.max(d.total > 0 ? 2 : 0, (d.total / yMax) * chartH);
    const autoH = Math.max(d.automated > 0 ? 2 : 0, (d.automated / yMax) * chartH);
    const totalY = pad.top + chartH - totalH;
    const autoY = pad.top + chartH - autoH;
    bars += `<rect class="trend-bar" x="${x}" y="${totalY}" width="${barW}" height="${totalH}" rx="4" fill="#ddd6fe" opacity="0.6"><title>${d.month}: ${d.total.toFixed(1)} hrs potential</title></rect>`;
    bars += `<rect class="trend-bar" x="${x}" y="${autoY}" width="${barW}" height="${autoH}" rx="4" fill="#a56bff"><title>${d.month}: ${d.automated.toFixed(1)} hrs automated</title></rect>`;
    if (d.total > 0) bars += `<text x="${x + barW / 2}" y="${totalY - 6}" text-anchor="middle" class="trend-value">${d.total.toFixed(0)}h</text>`;
    const label = new Date(d.month + '-15').toLocaleDateString('en-US', { month: 'short' });
    bars += `<text x="${x + barW / 2}" y="${svgH - 10}" text-anchor="middle" class="trend-label">${label}</text>`;
  });

  const axisLine = `<line x1="${pad.left}" y1="${pad.top + chartH}" x2="${svgW - pad.right}" y2="${pad.top + chartH}" class="trend-axis"/>`;
  const legend = `
    <g transform="translate(${pad.left}, ${svgH - 2})">
      <rect width="10" height="10" rx="2" fill="#ddd6fe" opacity="0.6"/>
      <text x="14" y="9" class="trend-label">Potential</text>
      <rect x="72" width="10" height="10" rx="2" fill="#a56bff"/>
      <text x="86" y="9" class="trend-label">Automated</text>
    </g>`;

  container.innerHTML = `<div class="trend-chart-wrap"><svg viewBox="0 0 ${svgW} ${svgH + 16}" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Monthly hours saved trend">${gridLines}${axisLine}${bars}${legend}</svg></div>`;
}

// ‚îÄ‚îÄ Team & Individual Breakdown ‚îÄ‚îÄ
// ‚îÄ‚îÄ Main Toil Table ‚îÄ‚îÄ
function renderToilTable(issues) {
  const teamF = document.getElementById('filterTeam').value;
  const catF = document.getElementById('filterCategory').value;
  const statF = document.getElementById('filterStatus').value;

  let filtered = issues.slice();
  if (teamF) filtered = filtered.filter(i => i.team === teamF);
  if (catF) filtered = filtered.filter(i => i.category === catF);
  if (statF) filtered = filtered.filter(i => getStatus(i) === statF);

  // Sort
  filtered.sort((a, b) => {
    let va = a[sortCol], vb = b[sortCol];
    if (typeof va === 'number' && typeof vb === 'number') return (va - vb) * sortDir;
    va = String(va || '').toLowerCase(); vb = String(vb || '').toLowerCase();
    return va < vb ? -sortDir : va > vb ? sortDir : 0;
  });

  // Sort arrows
  document.querySelectorAll('#toilTable th').forEach(th => {
    const col = th.dataset.col;
    const arrow = col === sortCol ? (sortDir === 1 ? ' ‚ñ≤' : ' ‚ñº') : '';
    const existing = th.querySelector('.sort-arrow');
    if (existing) existing.textContent = arrow;
    else if (col) {
      const sp = document.createElement('span');
      sp.className = 'sort-arrow';
      sp.textContent = arrow;
      th.appendChild(sp);
    }
  });

  const tbody = document.querySelector('#toilTable tbody');
  tbody.innerHTML = filtered.map(issue => {
    const status = getStatus(issue);
    const edited = localEdits[issue.number] ? '<span class="edited-marker">‚úé</span>' : '';
    const bonusStr = (issue.bonus_factors || []).join(' ');
    const rawTitle = (issue.title || '').replace(/^\[TOIL\]\s*/i, '');
    const freq = issue.frequency || 'unknown frequency';
    const time = issue.time_per_occurrence || 'unknown duration';
    const idea = issue.automation_idea || '';
    const issueUrl = issue.url || `https://github.com/${CONFIG.fullRepo}/issues/${issue.number}`;
    const repoUrl = `https://github.com/${CONFIG.fullRepo}`;
    const contextUrls = [issueUrl, repoUrl].filter(u => u && u.startsWith('https://'));
    const agentPrompt = [
      `You are an automation agent. A team identified this toil: "${rawTitle}".`,
      `IMPORTANT ‚Äî Start by reading these URLs for context:`,
      ...contextUrls.map((u, i) => `  ${i + 1}. ${u}`),
      CONFIG.fullRepo ? `Repository: ${CONFIG.fullRepo} (${repoUrl}).` : '',
      issue.number ? `Issue: #${issue.number} ‚Äî ${issueUrl}.` : '',
      issue.submitter ? `Submitter: ${issue.submitter}.` : '',
      issue.team ? `Team: ${issue.team}.` : '',
      issue.category ? `Category: ${issue.category}.` : '',
      `It happens ${freq}, takes ${time} each time, and affects ${issue.people_affected || 'the team'}.`,
      issue.toil_score ? `Toil score: ${issue.toil_score}. Priority: ${issue.priority || 'unknown'}. Potential savings: ${issue.monthly_saved_minutes || 0} min/month.` : '',
      idea ? `Suggested approach: ${idea}.` : '',
      `Step 1: Read the URLs above for full context, then analyze this repo to identify the best automation strategy.`,
      `Step 2: Propose a concrete implementation plan with file paths.`,
      `Step 3: Scaffold the solution (GitHub Actions workflow, script, or code).`,
      `Step 4: Ask the user if they want to refine, test, or commit the changes.`,
      `Start by exploring the repo structure, then present your plan.`
    ].filter(Boolean).join(' ');
    const ghCmd = `gh copilot "${agentPrompt.replace(/"/g, '\\"')}"`;
    
    // Split "Name ‚Äî Description" into two parts
    const dashIdx = rawTitle.indexOf(' ‚Äî ');
    const toilName = dashIdx > -1 ? rawTitle.substring(0, dashIdx) : rawTitle.split(/\s+/).slice(0, 4).join(' ');
    const toilDesc = dashIdx > -1 ? rawTitle.substring(dashIdx + 3) : (dashIdx === -1 && rawTitle.length > toilName.length ? rawTitle : '');

    const safeUrl = issue.url && issue.url.startsWith('https://github.com/') ? issue.url : '#';
    const actionBtn = `<button class="btn btn-launch" onclick="copyLaunchCmd(this, ${issue.number})" data-cmd="${esc(ghCmd, true)}" title="Launch Copilot CLI to solve this">üöÄ Launch GH Copilot CLI<br><small>To Automate</small></button>`;

    return `<tr class="${priorityClass(issue.toil_score)}">
      <td><a href="${safeUrl}" target="_blank" rel="noopener noreferrer" style="color:#0969da;font-weight:600;">#${issue.number}</a></td>
      <td class="toil-cell"><div class="toil-name">${esc(toilName)}</div>${toilDesc ? `<div class="toil-desc">${esc(toilDesc)}</div>` : ''}</td>
      <td class="toil-action-cell">${actionBtn} ${statusBadge(status, issue.number)}</td>
      <td>${esc(issue.submitter)}</td>
      <td class="col-hidden">${esc(issue.category)}</td>
      <td class="editable" data-issue="${issue.number}" data-field="frequency">${esc(issue.frequency)}${edited}</td>
      <td class="editable" data-issue="${issue.number}" data-field="time_per_occurrence">${esc(issue.time_per_occurrence)}</td>
      <td class="editable" data-issue="${issue.number}" data-field="people_affected">${esc(issue.people_affected)}</td>
      <td style="font-weight:700">${issue.toil_score}</td>
      <td>${statusBadge(status, issue.number)}</td>
      <td>${formatMinutes(issue.monthly_saved_minutes)}</td>
    </tr>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INLINE EDITING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('click', function(e) {
  const td = e.target.closest('td.editable');
  if (!td || td.querySelector('select')) return;

  const field = td.dataset.field;
  const issueNum = Number(td.dataset.issue);
  const issue = dashboardData.issues.find(i => i.number === issueNum);
  if (!issue) return;

  let options;
  if (field === 'frequency') options = Object.keys(FREQ_SCORES);
  else if (field === 'time_per_occurrence') options = Object.keys(TIME_SCORES);
  else if (field === 'people_affected') options = Object.keys(PEOPLE_SCORES);
  else return;

  const current = issue[field];
  const sel = document.createElement('select');
  options.forEach(o => {
    const opt = document.createElement('option');
    opt.value = o; opt.textContent = o;
    if (o === current) opt.selected = true;
    sel.appendChild(opt);
  });

  td.textContent = '';
  td.appendChild(sel);
  sel.focus();

  function commit() {
    const newVal = sel.value;
    if (newVal !== current) {
      if (!localEdits[issueNum]) localEdits[issueNum] = {};
      localEdits[issueNum][field] = newVal;
      issue[field] = newVal;
      const { score, monthlyMins } = calcScore(issue.frequency, issue.time_per_occurrence, issue.people_affected, issue.bonus_factors);
      issue.toil_score = score;
      issue.monthly_saved_minutes = monthlyMins;
      issue.priority = getPriorityLabel(score);
      saveLocalEdits();
    }
    render();
  }

  sel.addEventListener('change', commit);
  sel.addEventListener('blur', commit);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATUS TOGGLE ‚Äî click badge to cycle status
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STATUS_CYCLE = ['toil', 'triage', 'in-progress', 'automated'];
document.addEventListener('click', function(e) {
  const badge = e.target.closest('.status-toggle');
  if (!badge) return;
  const issueNum = Number(badge.dataset.issue);
  if (!issueNum) return;
  const issue = dashboardData.issues.find(i => i.number === issueNum);
  if (!issue) return;
  const current = getStatus(issue);
  const idx = STATUS_CYCLE.indexOf(current);
  const next = STATUS_CYCLE[(idx + 1) % STATUS_CYCLE.length];
  if (!localEdits[issueNum]) localEdits[issueNum] = {};
  localEdits[issueNum].status = next;
  saveLocalEdits();
  const labels = { 'automated': '‚úÖ shipped', 'in-progress': 'üî® building', 'triage': 'üîç triaging', 'toil': 'üí° ready to fix' };
  showToast(`Status updated ‚Üí ${labels[next]}`);
  render();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HEADER PILL FILTERS ‚Äî click to filter table by status
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('heroPulse').addEventListener('click', function(e) {
  const pill = e.target.closest('[data-filter-status]');
  if (!pill) return;
  const status = pill.dataset.filterStatus;
  const sel = document.getElementById('filterStatus');
  sel.value = status;
  render();
  document.getElementById('toilTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
  showToast(status ? `Filtered to: ${status}` : 'Showing all statuses');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.querySelector('#toilTable thead').addEventListener('click', function(e) {
  const th = e.target.closest('th');
  if (!th || !th.dataset.col || th.dataset.col === 'actions') return;
  const col = th.dataset.col;
  if (col === sortCol) sortDir *= -1;
  else { sortCol = col; sortDir = -1; }
  render();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
['filterTeam', 'filterCategory', 'filterStatus'].forEach(id => {
  document.getElementById(id).addEventListener('change', () => render());
});
document.getElementById('filterSort').addEventListener('change', function() {
  sortCol = this.value;
  sortDir = this.value === 'submitter' ? 1 : -1;
  render();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COPILOT CLI LAUNCH TRACKING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getCopilotLaunches() {
  return JSON.parse(localStorage.getItem('toilCopilotLaunches') || '{"total":0,"issues":{},"recent":[]}');
}
function trackCopilotLaunch(issueNum) {
  const data = getCopilotLaunches();
  data.total = (data.total || 0) + 1;
  if (!data.issues) data.issues = {};
  data.issues[issueNum] = (data.issues[issueNum] || 0) + 1;
  if (!data.recent) data.recent = [];
  data.recent.unshift({ issue: issueNum, time: Date.now() });
  data.recent = data.recent.slice(0, 20);
  localStorage.setItem('toilCopilotLaunches', JSON.stringify(data));
}
function timeAgo(ts) {
  const secs = Math.floor((Date.now() - ts) / 1000);
  if (secs < 60) return 'just now';
  if (secs < 3600) return `${Math.floor(secs / 60)}m ago`;
  if (secs < 86400) return `${Math.floor(secs / 3600)}h ago`;
  return `${Math.floor(secs / 86400)}d ago`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLIPBOARD & TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function copyLaunchCmd(btn, issueNum) {
  const cmd = btn.getAttribute('data-cmd');
  // Track the launch
  trackCopilotLaunch(issueNum);
  navigator.clipboard.writeText(cmd).then(() => {
    showToast('üöÄ Command copied ‚Äî paste in your terminal to start automating!');
    render();
  }).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = cmd; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('üöÄ Command copied ‚Äî paste in your terminal to start automating!');
    render();
  });
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
/**
 * Escapes HTML special characters to prevent XSS
 * @param {string} str - String to escape
 * @param {boolean} attr - If true, also escapes quotes for use in HTML attributes
 * @returns {string} Escaped string
 */
function escapeHtml(str, attr) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = str;
  return attr ? d.innerHTML.replace(/"/g, '&quot;') : d.innerHTML;
}
// Compatibility alias (to be removed in future refactor)
const esc = escapeHtml;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COLUMN TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let showAllCols = false;
function toggleColumns() {
  showAllCols = !showAllCols;
  document.querySelectorAll('.col-hidden').forEach(el => el.style.display = showAllCols ? '' : 'none');
  document.getElementById('toggleCols').textContent = showAllCols ? '‚àí Fewer columns' : '+ Show all columns';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT ‚Äî CSV & JSON downloads
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getVisibleData() {
  const rows = document.querySelectorAll('#toilTable tbody tr:not(.total-row)');
  return Array.from(rows).map(tr => {
    const cells = tr.querySelectorAll('td');
    return {
      number: cells[0]?.textContent?.trim() || '',
      title: cells[1]?.textContent?.trim() || '',
      submitter: cells[3]?.textContent?.trim() || '',
      frequency: cells[5]?.textContent?.trim() || '',
      time: cells[6]?.textContent?.trim() || '',
      people: cells[7]?.textContent?.trim() || '',
      score: cells[8]?.textContent?.trim() || '',
      status: cells[9]?.textContent?.trim() || '',
      saved_per_month: cells[10]?.textContent?.trim() || '',
    };
  });
}
function downloadFile(content, filename, mime) {
  const blob = new Blob([content], { type: mime });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}
function exportCSV() {
  const data = getVisibleData();
  if (!data.length) return;
  const headers = Object.keys(data[0]);
  const csv = [headers.join(','), ...data.map(r => headers.map(h => `"${(r[h]||'').replace(/"/g,'""')}"`).join(','))].join('\n');
  downloadFile(csv, 'toil-tracker-export.csv', 'text/csv');
  showToast('üì• CSV downloaded');
}
function exportJSON() {
  const data = getVisibleData();
  if (!data.length) return;
  downloadFile(JSON.stringify(data, null, 2), 'toil-tracker-export.json', 'application/json');
  showToast('üì• JSON downloaded');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
loadData();
</script>
</body>
</html>
